class e{static baseEncumbranceCap=1600;static encumbranceSteps={quarter:25,threeEighths:37.5,half:50};#e;#t;#a=0;constructor(t="disabled",a=e.baseEncumbranceCap){this.#e=t,this.#t=a}static defineSchema(){const{ArrayField:t,BooleanField:a,NumberField:s,SchemaField:n,StringField:i}=foundry.data.fields;return new n({variant:new i({initial:"disabled"}),enabled:new a({initial:!0}),encumbered:new a({initial:!1}),pct:new s({integer:!1,initial:0,min:0,max:100}),steps:new t(new s),value:new s({integer:!1}),max:new s({integer:!1,initial:e.baseEncumbranceCap}),atFirstBreakpoint:new a({initial:!1}),atSecondBreakpoint:new a({initial:!1}),atThirdBreakpoint:new a({initial:!1})})}get variant(){return this.#e}get enabled(){return"disabled"!==this.#e}get pct(){return Math.clamp(this.value/this.max*100,0,100)}get encumbered(){return this.value>this.max}get steps(){return[]}get value(){return this.#a}get max(){return this.#t}set max(e){this.#t=e}get#s(){return this.max-e.baseEncumbranceCap}get atThirdBreakpoint(){return this.pct>e.encumbranceSteps.half}get atSecondBreakpoint(){return this.pct>e.encumbranceSteps.threeEighths}get atFirstBreakpoint(){return this.pct>e.encumbranceSteps.quarter}get defaultMax(){return this.constructor.baseEncumbranceCap}get alternateMax(){return this.defaultMax}}class t extends e{static templateEncumbranceBar="";static templateInventoryRow="";static type="basic";static localizedLabel="OSE.Setting.EncumbranceBasic";static significantTreasure=800;static armorWeight={unarmored:0,light:1,heavy:2};#a;#n;#i;constructor(a=e.baseEncumbranceCap,s=[],n={}){super(t.type,a),this.#n=n?.significantTreasure||t.significantTreasure,this.#a=s.reduce(((e,{type:t,system:{treasure:a,quantity:s,weight:n}})=>"item"===t&&a?e+s.value*n:e),0),this.#i=s.reduce(((e,{type:a,system:{type:s,equipped:n}})=>"armor"===a&&n?"light"===s&&e===t.armorWeight.unarmored?t.armorWeight.light:"heavy"===s?t.armorWeight.heavy:e:e),t.armorWeight.unarmored)}static defineSchema(){const{ArrayField:a,BooleanField:s,NumberField:n,SchemaField:i,StringField:o}=foundry.data.fields;return new i({variant:new o({initial:t.type}),enabled:new s({initial:!0}),encumbered:new s({initial:!1}),overTreasureThreshold:new s({initial:!1}),overSignificantTreasureThreshold:new s({initial:!1}),pct:new n({integer:!1,initial:0,min:0,max:100}),steps:new a(new n),value:new n({integer:!1}),max:new n({integer:!1,initial:e.baseEncumbranceCap}),atFirstBreakpoint:new s({initial:!1}),atSecondBreakpoint:new s({initial:!1}),atThirdBreakpoint:new s({initial:!1})})}get steps(){return[100*this.#n/this.max]}get overTreasureThreshold(){return this.value>=this.#n}get value(){return this.#a}get overSignificantTreasureThreshold(){return this.value>=this.#n}get atThirdBreakpoint(){return this.#i===t.armorWeight.heavy&&this.value>=this.#n}get atSecondBreakpoint(){const e=this.#i===t.armorWeight.heavy,a=this.#i===t.armorWeight.light&&this.value>=this.#n;return e||a}get atFirstBreakpoint(){return this.#i===t.armorWeight.light||this.overSignificantTreasureThreshold}}class a extends e{static templateEncumbranceBar="";static templateInventoryRow="";static type="complete";static localizedLabel="OSE.Setting.EncumbranceComplete";#a;constructor(t=e.baseEncumbranceCap,s=[]){super(a.type,t),this.#a=s.reduce(((e,{type:t,system:{quantity:a,weight:s}})=>"item"===t?e+a.value*s:["weapon","armor","container"].includes(t)?e+s:e),0)}static defineSchema(){const{ArrayField:t,BooleanField:s,NumberField:n,SchemaField:i,StringField:o}=foundry.data.fields;return new i({variant:new o({initial:a.type}),enabled:new s({initial:!0}),encumbered:new s({initial:!1}),pct:new n({integer:!1,initial:0,min:0,max:100}),steps:new t(new n),value:new n({integer:!1}),max:new n({integer:!1,initial:e.baseEncumbranceCap}),atFirstBreakpoint:new s({initial:!1}),atSecondBreakpoint:new s({initial:!1}),atThirdBreakpoint:new s({initial:!1})})}get steps(){return Object.values(e.encumbranceSteps)}get value(){return this.#a}}class s extends e{static templateEncumbranceBar="";static templateInventoryRow="";static type="detailed";static localizedLabel="OSE.Setting.EncumbranceDetailed";static gearWeight=80;#a=0;#o;constructor(t=e.baseEncumbranceCap,a=[]){super(s.type,t),this.#o=a.some((e=>"item"===e.type&&!e.system.treasure)),this.#a=a.reduce(((e,{type:t,system:{treasure:a,quantity:s,weight:n}})=>{if("spell"===t||"ability"===t)return e;let i=e;return"item"===t&&a&&(i+=s.value*n),["weapon","armor","container"].includes(t)&&(i+=n),i}),0)+(this.#o?s.gearWeight:0)}static defineSchema(){const{ArrayField:t,BooleanField:a,NumberField:n,SchemaField:i,StringField:o}=foundry.data.fields;return new i({variant:new o({initial:s.type}),enabled:new a({initial:!0}),encumbered:new a({initial:!1}),pct:new n({integer:!1,initial:0,min:0,max:100}),steps:new t(new n),value:new n({integer:!1}),max:new n({integer:!1,initial:e.baseEncumbranceCap}),atFirstBreakpoint:new a({initial:!1}),atSecondBreakpoint:new a({initial:!1}),atThirdBreakpoint:new a({initial:!1})})}get steps(){return Object.values(e.encumbranceSteps)}get value(){return this.#a}}class n extends e{static templateEncumbranceBar="";static templateInventoryRow="";static type="disabled";static localizedLabel="OSE.Setting.EncumbranceDisabled";constructor(){super(n.type)}static defineSchema(){const{ArrayField:e,BooleanField:t,NumberField:a,SchemaField:s,StringField:i}=foundry.data.fields;return new s({variant:new i({initial:n.type}),enabled:new t({initial:!0}),encumbered:new t({initial:!1}),pct:new a({integer:!1,initial:0,min:0,max:100}),steps:new e(new a),value:new a({integer:!1}),max:new a({integer:!1}),atFirstBreakpoint:new t({initial:!1}),atSecondBreakpoint:new t({initial:!1}),atThirdBreakpoint:new t({initial:!1})})}get value(){return 0}}class i extends e{static baseEncumbranceCap=9;static alternateBaseEncumbranceCap=16;static packedEncumbranceSteps={fiveEighths:62.5,threeQuarters:75,sevenEighths:87.5};static packedStepCounts={stepOne:10,stepTwo:12,stepThree:14};static equippedEncumbranceSteps={oneThird:3/9*100,fiveNinths:5/9*100,sevenNinths:7/9*100};static equippedStepCounts={stepOne:3,stepTwo:5,stepThree:7};#r;#l;#t;#c;#u;#m;#d;#g;#p;static templateEncumbranceBar="";static templateInventoryRow="";static type="itembased";static localizedLabel="OSE.Setting.EncumbranceItemBased";#a;#h;#y;#w;constructor(t=16,a=[],s={}){super(i.type,t),game.settings.get(game.system.id,"encumbranceItemStrengthMod")?this.#w=s.scores?.str?.mod>0?s.scores.str.mod:0:this.#w=0;const n=!t||t===e.baseEncumbranceCap||t===i.alternateBaseEncumbranceCap;this.#l=n?16:t,this.#r=n?9:t,this.#y=Math.ceil(a.reduce(((e,t)=>"item"===t.type&&t.system.isCoinsOrGems?e:"item"!==t.type&&"container"!==t.type||t.system.equipped?["weapon","armor"].includes(t.type)&&!t.system.equipped?e+t.system.itemslots:e:e+Math.ceil(t.system.quantity.value*t.system.itemslots)),0))+Math.ceil(a.reduce(((e,t)=>"item"===t.type&&t.system.isCoinsOrGems?e+t.system.quantity.value/100:e),0)),this.#h=Math.ceil(a.reduce(((e,{type:t,system:{quantity:a,itemslots:s,equipped:n}})=>"item"===t&&n?e+Math.ceil(a.value*s):["weapon","armor"].includes(t)&&n?e+s:e),0)),this.#a=this.usingEquippedEncumbrance?this.#h:this.#y,this.#t=this.usingEquippedEncumbrance?this.#r:this.#l,this.#c=this.#y>i.packedStepCounts.stepOne,this.#u=this.#y>i.packedStepCounts.stepTwo,this.#m=this.#y>i.packedStepCounts.stepThree,this.#d=this.#h>i.equippedStepCounts.stepOne,this.#g=this.#h>i.equippedStepCounts.stepTwo,this.#p=this.#h>i.equippedStepCounts.stepThree}static defineSchema(){const{ArrayField:e,BooleanField:t,NumberField:a,SchemaField:s,StringField:n}=foundry.data.fields;return new s({variant:new n({initial:i.type}),enabled:new t({initial:!0}),encumbered:new t({initial:!1}),pct:new a({integer:!1,initial:0,min:0,max:100}),steps:new e(new a),value:new a({integer:!1}),max:new a({integer:!1,initial:i.baseEncumbranceCap}),atFirstBreakpoint:new t({initial:!1}),atSecondBreakpoint:new t({initial:!1}),atThirdBreakpoint:new t({initial:!1}),equippedSteps:new e(new a),packedSteps:new e(new a),equippedPct:new a({integer:!1,min:0,max:100}),packedPct:new a({integer:!1,min:0,max:100}),equippedValue:new a({integer:!1}),packedValue:new a({integer:!1}),equippedLabel:new n({initial:"0/0"}),packedLabel:new n({initial:"0/0"}),usingEquippedEncumbrance:new t({initial:!0}),weightMod:new a({integer:!0,initial:0})})}get steps(){return this.usingEquippedEncumbrance?Object.values(i.equippedEncumbranceSteps):Object.values(i.packedEncumbranceSteps)}get usingEquippedEncumbrance(){const e=Object.values(i.equippedStepCounts),t=Object.values(i.packedStepCounts);let a=e.findIndex((e=>e>=this.#h));a=-1===a?4:a;let s=t.findIndex((e=>e>=this.#y-this.#w));return s=-1===s?4:s,0===a&&0===s?this.#h>=this.#y-this.#w:a>=s}get value(){return this.#a}get max(){return this.#t}get atFirstBreakpoint(){return this.usingEquippedEncumbrance?this.#d:this.#c}get atSecondBreakpoint(){return this.usingEquippedEncumbrance?this.#g:this.#u}get atThirdBreakpoint(){return this.usingEquippedEncumbrance?this.#p:this.#m}get encumbered(){return this.value>this.max+this.#w}get equippedSteps(){return Object.values(i.equippedEncumbranceSteps)}get packedSteps(){return Object.values(i.packedEncumbranceSteps)}get equippedPct(){return Math.clamp(this.#h/this.#r*100,0,100)}get packedPct(){return Math.clamp((this.#y-this.#w)/this.#l*100,0,100)}get equippedValue(){return this.#h}get packedValue(){return this.#y}get equippedLabel(){return`${this.#h}/${this.#r}`}get packedLabel(){return`${this.#y}/${this.#l+this.#w}`}get alternateMax(){return i.alternateBaseEncumbranceCap}}const o={systemPath(){return`${this.systemRoot}/dist`},get systemRoot(){return`/systems/${game.system.id}`},get assetsPath(){return`${this.systemRoot}/assets`},get encumbrance(){const e=game.settings.get(game.system.id,"encumbranceOption");return this.encumbranceOptions[e]||this.encumbranceOptions.disabled},encumbranceOptions:{basic:t,detailed:s,complete:a,disabled:n,itembased:i},scores:{str:"OSE.scores.str.long",int:"OSE.scores.int.long",dex:"OSE.scores.dex.long",wis:"OSE.scores.wis.long",con:"OSE.scores.con.long",cha:"OSE.scores.cha.long"},scores_short:{str:"OSE.scores.str.short",int:"OSE.scores.int.short",dex:"OSE.scores.dex.short",wis:"OSE.scores.wis.short",con:"OSE.scores.con.short",cha:"OSE.scores.cha.short"},exploration_skills:{ld:"OSE.exploration.ld.long",od:"OSE.exploration.od.long",sd:"OSE.exploration.sd.long",fs:"OSE.exploration.ft.long"},exploration_skills_short:{ld:"OSE.exploration.ld.abrev",od:"OSE.exploration.od.abrev",sd:"OSE.exploration.sd.abrev",fs:"OSE.exploration.ft.abrev"},roll_type:{result:"=",above:"≥",below:"≤"},saves_short:{death:"OSE.saves.death.short",wand:"OSE.saves.wand.short",paralysis:"OSE.saves.paralysis.short",breath:"OSE.saves.breath.short",spell:"OSE.saves.spell.short"},saves_long:{death:"OSE.saves.death.long",wand:"OSE.saves.wand.long",paralysis:"OSE.saves.paralysis.long",breath:"OSE.saves.breath.long",spell:"OSE.saves.spell.long"},armor:{unarmored:"OSE.armor.unarmored",light:"OSE.armor.light",heavy:"OSE.armor.heavy",shield:"OSE.armor.shield"},apply_damage_options:{selected:"selected",targeted:"targeted",originalTarget:"originalTarget"},colors:{green:"OSE.colors.green",red:"OSE.colors.red",yellow:"OSE.colors.yellow",purple:"OSE.colors.purple",blue:"OSE.colors.blue",orange:"OSE.colors.orange",white:"OSE.colors.white"},languages:["Common","Lawful","Chaotic","Neutral","Bugbear","Doppelgänger","Dragon","Dwarvish","Elvish","Gargoyle","Gnoll","Gnomish","Goblin","Halfling","Harpy","Hobgoblin","Kobold","Lizard Man","Medusa","Minotaur","Ogre","Orcish","Pixie"],tags:{melee:"OSE.items.Melee",missile:"OSE.items.Missile",slow:"OSE.items.Slow",twohanded:"OSE.items.TwoHanded",blunt:"OSE.items.Blunt",brace:"OSE.items.Brace",splash:"OSE.items.Splash",reload:"OSE.items.Reload",charge:"OSE.items.Charge"},auto_tags:{get melee(){return{label:CONFIG.OSE.tags.melee,image:`${CONFIG.OSE.assetsPath}/melee.png`,icon:"fa-sword"}},get missile(){return{label:CONFIG.OSE.tags.missile,image:`${CONFIG.OSE.assetsPath}/missile.png`,icon:"fa-bow-arrow"}},get slow(){return{label:CONFIG.OSE.tags.slow,image:`${CONFIG.OSE.assetsPath}/slow.png`,icon:"fa-weight-hanging"}},get twohanded(){return{label:CONFIG.OSE.tags.twohanded,image:`${CONFIG.OSE.assetsPath}/twohanded.png`,icon:"fa-hands-holding"}},get blunt(){return{label:CONFIG.OSE.tags.blunt,image:`${CONFIG.OSE.assetsPath}/blunt.png`,icon:"fa-hammer-crash"}},get brace(){return{label:CONFIG.OSE.tags.brace,image:`${CONFIG.OSE.assetsPath}/brace.png`,icon:"fa-block-brick"}},get splash(){return{label:CONFIG.OSE.tags.splash,image:`${CONFIG.OSE.assetsPath}/splash.png`,icon:"fa-burst"}},get reload(){return{label:CONFIG.OSE.tags.reload,image:`${CONFIG.OSE.assetsPath}/reload.png`,icon:"fa-gear"}},get charge(){return{label:CONFIG.OSE.tags.charge,image:`${CONFIG.OSE.assetsPath}/charge.png`,icon:"fa-person-running"}}},tag_images:{get melee(){return`${CONFIG.OSE.assetsPath}/melee.png`},get missile(){return"fa-bow-arrow"},get slow(){return`${CONFIG.OSE.assetsPath}/slow.png`},get twohanded(){return`${CONFIG.OSE.assetsPath}/twohanded.png`},get blunt(){return`${CONFIG.OSE.assetsPath}/blunt.png`},get brace(){return`${CONFIG.OSE.assetsPath}/brace.png`},get splash(){return`${CONFIG.OSE.assetsPath}/splash.png`},get reload(){return`${CONFIG.OSE.assetsPath}/reload.png`},get charge(){return`${CONFIG.OSE.assetsPath}/charge.png`}},monster_saves:{0:{d:14,w:15,p:16,b:17,s:18},1:{d:12,w:13,p:14,b:15,s:16},4:{d:10,w:11,p:12,b:13,s:14},7:{d:8,w:9,p:10,b:10,s:12},10:{d:6,w:7,p:8,b:8,s:10},13:{d:4,w:5,p:6,b:5,s:8},16:{d:2,w:3,p:4,b:3,s:6},19:{d:2,w:2,p:2,b:2,s:4},22:{d:2,w:2,p:2,b:2,s:2}},monster_thac0:{0:20,1:19,2:18,3:17,4:16,5:15,6:14,7:13,9:12,10:11,12:10,14:9,16:8,18:7,20:6,22:5}},r={async sendRoll({parts:e=[],data:t={},title:a=null,flavor:s=null,speaker:n=null,form:i=null,chatMessage:l=!0}={}){const c=`${o.systemPath()}/templates/chat/roll-result.html`,u={user:game.user.id,speaker:n},m={title:a,flavor:s,data:t,config:CONFIG.OSE};null!==i&&i.bonus.value&&e.push(i.bonus.value);const d=new Roll(e.join("+"),t);await d.evaluate({allowStrings:!0});let g=game.settings.get("core","rollMode");return g=i?i.rollMode.value:g,!i&&t.roll.blindroll&&(g=game.user.isGM?"selfroll":"blindroll"),["gmroll","blindroll"].includes(g)&&(u.whisper=ChatMessage.getWhisperRecipients("GM")),"selfroll"===g&&(u.whisper=[game.user._id]),"blindroll"===g&&(u.blind=!0,t.roll.blindroll=!0),m.result=r.digestResult(t,d),new Promise((e=>{d.render().then((t=>{m.rollOSE=t,foundry.applications.handlebars.renderTemplate(c,m).then((t=>{u.content=t,game.dice3d?game.dice3d.showForRoll(d,game.user,!0,u.whisper,u.blind).then((()=>{!1!==l&&ChatMessage.create(u),e(d)})):(u.sound=CONFIG.sounds.dice,!1!==l&&ChatMessage.create(u),e(d))}))}))}))},digestResult(e,t){const a={isSuccess:!1,isFailure:!1,target:e.roll.target,total:t.total},s=t.dice?.[0]?.results?.[0]?.result??t.total;switch(e.roll.type){case"result":t.total===a.target?a.isSuccess=!0:a.isFailure=!0;break;case"above":t.total>=a.target?a.isSuccess=!0:a.isFailure=!0;break;case"below":t.total<=a.target?a.isSuccess=!0:a.isFailure=!0;break;case"check":1===s||t.total<=a.target&&s<20?a.isSuccess=!0:a.isFailure=!0;break;case"table":{const{table:s}=e.roll;let n=Object.values(s)[0];for(let e=0;e<=t.total;e++)s[e]&&(n=s[e]);a.details=n;break}default:a.isSuccess=!1,a.isFailure=!1}return a},attackIsSuccess:(e,t,a)=>1!==e.terms[0].results[0].result&&(20===e.terms[0].results[0].result||e.total+a>=t),digestAttackResult(e,t){const a={isSuccess:!1,isFailure:!1,target:"",total:t.total};a.target=e.roll.thac0;const s=e.roll.target?.actor?.system||null,n=e.roll.target?s?.ac?.value:9,i=e.roll.target?s?.aac?.value:10;if(a.victim=e.roll.target||null,game.settings.get(game.system.id,"ascendingAC")){const e=0;this.attackIsSuccess(t,i,e)||null==a.victim?(a.details=game.i18n.format("OSE.messages.AttackAscendingSuccess",{result:t.total}),a.isSuccess=!0):(a.details=game.i18n.format("OSE.messages.AttackAscendingFailure",{bonus:a.target}),a.isFailure=!0)}else if(this.attackIsSuccess(t,a.target,n)||null==a.victim){const e=a.target-t.total;a.details=game.i18n.format("OSE.messages.AttackSuccess",{result:e,bonus:a.target}),a.isSuccess=!0}else a.details=game.i18n.format("OSE.messages.AttackFailure",{bonus:a.target}),a.isFailure=!0;return a},async sendAttackRoll({parts:e=[],data:t={},flags:a={},title:s=null,flavor:n=null,speaker:i=null,form:l=null}={}){if(0===t.roll.dmg.filter((e=>""!==e)).length)return void ui.notifications.error("Attack has no damage dice terms; be sure to set the attack's damage");const c=`${o.systemPath()}/templates/chat/roll-attack.html`,u={user:game.user.id,speaker:i,flags:a},m={title:s,flavor:n,data:t,config:CONFIG.OSE};null!==l&&l.bonus.value&&e.push(l.bonus.value);const d=new Roll(e.join("+"),t);await d.evaluate();const g=new Roll(t.roll.dmg.join("+"),t);await g.evaluate();let p=game.settings.get("core","rollMode");return p=l?l.rollMode.value:p,t.roll.blindroll&&(p=game.user.isGM?"selfroll":"blindroll"),["gmroll","blindroll"].includes(p)&&(u.whisper=ChatMessage.getWhisperRecipients("GM")),"selfroll"===p&&(u.whisper=[game.user._id]),"blindroll"===p&&(u.blind=!0,t.roll.blindroll=!0),m.result=r.digestAttackResult(t,d),new Promise((e=>{d.render().then((t=>{m.rollOSE=t,g.render().then((t=>{m.rollDamage=t,foundry.applications.handlebars.renderTemplate(c,m).then((t=>{u.content=t,game.dice3d?game.dice3d.showForRoll(d,game.user,!0,u.whisper,u.blind).then((()=>{m.result.isSuccess?(m.result.dmg=g.total,game.dice3d.showForRoll(g,game.user,!0,u.whisper,u.blind).then((()=>{ChatMessage.create(u),e(d)}))):(ChatMessage.create(u),e(d))})):(u.sound=CONFIG.sounds.dice,ChatMessage.create(u),e(d))}))}))}))}))},async RollSave({parts:e=[],data:t={},skipDialog:a=!1,speaker:s=null,flavor:n=null,title:i=null,chatMessage:l=!0}={}){let c=!1;const u=`${o.systemPath()}/templates/chat/roll-dialog.html`,m={formula:e.join(" "),data:t,rollMode:game.settings.get("core","rollMode"),rollModes:CONFIG.Dice.rollModes},d={parts:e,data:t,title:i,flavor:n,speaker:s,chatMessage:l};if(a)return r.sendRoll(d);let g;const p=[{action:"ok",label:game.i18n.localize("OSE.Roll"),icon:"fas fa-dice-d20",callback:(e,t)=>{c=!0,d.form=t.form,g=r.sendRoll(d)}},{action:"magic",label:game.i18n.localize("OSE.saves.magic.short"),icon:"fas fa-magic",callback:(e,t)=>{c=!0,d.form=t.form,d.parts.push(`${d.data.roll.magic}`),d.title+=` ${game.i18n.localize("OSE.saves.magic.short")} (${d.data.roll.magic})`,g=r.sendRoll(d)}},{action:"cancel",icon:"fas fa-times",label:game.i18n.localize("OSE.Cancel"),callback:()=>{}}],h=await foundry.applications.handlebars.renderTemplate(u,m);return new Promise((e=>{new foundry.applications.api.DialogV2({window:{title:i},content:h,buttons:p,default:"ok",submit:()=>{e(!!c&&g)}}).render(!0)}))},async Roll({parts:e=[],data:t={},skipDialog:a=!1,speaker:s=null,flavor:n=null,title:i=null,chatMessage:l=!0,flags:c={}}={}){let u=!1;const m=`${o.systemPath()}/templates/chat/roll-dialog.html`,d={formula:e.join(" "),data:t,rollMode:t.roll.blindroll?"blindroll":game.settings.get("core","rollMode"),rollModes:CONFIG.Dice.rollModes},g={parts:e,data:t,title:i,flavor:n,speaker:s,chatMessage:l,flags:c};if(a)return["melee","missile","attack"].includes(t.roll.type)?r.sendAttackRoll(g):r.sendRoll(g);let p;const h=[{action:"ok",label:game.i18n.localize("OSE.Roll"),icon:"fas fa-dice-d20",callback:(e,a)=>{u=!0,g.form=a.form,p=["melee","missile","attack"].includes(t.roll.type)?r.sendAttackRoll(g):r.sendRoll(g)},default:!0},{action:"cancel",icon:"fas fa-times",label:game.i18n.localize("OSE.Cancel"),callback:()=>{}}],y=await foundry.applications.handlebars.renderTemplate(m,d);return new Promise((e=>{new foundry.applications.api.DialogV2({window:{title:i},content:y,buttons:h,submit:()=>{e(!!u&&p)}}).render(!0)}))}};class l extends FormApplication{static get defaultOptions(){const e=super.defaultOptions;return e.classes=["ose","dialog","creator"],e.id="character-creator",e.template=`${o.systemPath()}/templates/actors/dialogs/character-creation.html`,e.width=235,e.submitOnClose=!1,e}get title(){return`${this.object.name}: ${game.i18n.localize("OSE.dialog.generator")}`}getData(){const e=foundry.utils.deepClone(this.object);return e.user=game.user,e.config=CONFIG.OSE,this.counters={str:0,wis:0,dex:0,int:0,cha:0,con:0,gold:0},this.stats={sum:0,avg:0,std:0},this.scores={},this.gold=0,e}doStats(e){const t=$(e.currentTarget).closest(".attribute-list"),a=Object.values(this.scores),s=a.length,n=a.reduce(((e,t)=>e+t.value),0),i=parseFloat(n)/s,o=Math.sqrt(a.map((e=>(e.value-i)**2)).reduce(((e,t)=>e+t),0)/s),r=t.siblings(".roll-stats");r.find(".sum").text(n),r.find(".avg").text(Math.round(10*n/s)/10),r.find(".std").text(Math.round(100*o)/100),s>=6&&$(e.currentTarget).closest("form").find('button[type="submit"]').removeAttr("disabled"),this.object.stats={sum:n,avg:Math.round(10*n/s)/10,std:Math.round(100*o)/100}}async rollScore(e,t={}){this.counters[e]+=1;const a="gold"===e?"Gold":game.i18n.localize(`OSE.scores.${e}.long`),s=["3d6"];if(t.skipMessage){const e=new Roll(s[0]);await e.evaluate()}return r.Roll({event:t.event,parts:s,data:{roll:{}},skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.format("OSE.dialog.generateScore",{score:a,count:this.counters[e]}),title:game.i18n.format("OSE.dialog.generateScore",{score:a,count:this.counters[e]})})}activateListeners(e){super.activateListeners(e),e.find("a.score-roll").click((e=>{const t=e.currentTarget.parentElement.parentElement,{score:a}=t.dataset;this.rollScore(a,{event:e}).then((e=>{this.scores[a]={value:e.total},$(t).find("input").val(e.total).trigger("change")}))})),e.find("a.gold-roll").click((e=>{const t=e.currentTarget.parentElement.parentElement.parentElement;this.rollScore("gold",{event:e}).then((e=>{this.gold=10*e.total,$(t).find(".gold-value").val(this.gold)}))})),e.find("input.score-value").change((e=>{this.doStats(e)})),e.find("a.auto-roll").click((async e=>{const t=["str","int","dex","wis","con","cha"];for(const a of t){const t=await this.rollScore(a,{event:e,skipMessage:!0});this.scores[a]={value:t.total}}this.doStats(e);const a=await this.rollScore("gold",{event:e,skipMessage:!0});this.gold=10*a.total,this.submit()}))}async _onSubmit(e,{updateData:t=null,preventClose:a=!1,preventRender:s=!1}={}){const n={...t,system:{scores:this.scores}};super._onSubmit(e,{updateData:n,preventClose:a,preventRender:s});const i=ChatMessage.getSpeaker({actor:this.object.actor}),r={config:CONFIG.OSE,scores:this.scores,title:game.i18n.localize("OSE.dialog.generator"),stats:this.object.stats,gold:this.gold},l=await foundry.applications.handlebars.renderTemplate(`${o.systemPath()}/templates/chat/roll-creation.html`,r);await ChatMessage.create({content:l,speaker:i});const c={name:game.i18n.localize("OSE.items.gp.short"),type:"item",img:`${o.assetsPath}/gold.png`,system:{treasure:!0,cost:1,weight:1,quantity:{value:this.gold}}};this.object.createEmbeddedDocuments("Item",[c])}async _updateObject(e,t){e.preventDefault(),await this.object.update(t),this.object.sheet.render(!0)}}class c extends FormApplication{static physicalItemTypes=new Set(["item","container","weapon","armor"]);constructor(e,t,a){super(e,a),this.object.preparedData=t}static get defaultOptions(){const e=super.defaultOptions;return e.classes=["ose","dialog","gp-cost"],e.id="sheet-gp-cost",e.template=`${o.systemPath()}/templates/actors/dialogs/gp-cost-dialog.html`,e.width=240,e}get title(){return`${this.object.name}: ${game.i18n.localize("OSE.dialog.shoppingCart")}`}async getData(){const e=await foundry.utils.deepClone(this.object.preparedData);return e.totalCost=await this.#b(e),e.user=game.user,this.inventory=this.object.items,e}async close(e){return super.close(e)}async _onSubmit(e,{preventClose:t=!1,preventRender:a=!1}={}){super._onSubmit(e,{preventClose:t,preventRender:a});const s=await this.#b(await this.getData()),n=await this.object.items.find((e=>{const t=e.system;return(e.name===game.i18n.localize("OSE.items.gp.short")||"GP"===e.name)&&t.treasure}));if(!n)return void ui.notifications.error(game.i18n.localize("OSE.error.noGP"));const i=n.system.quantity.value-s;i>=0?(await this.object.updateEmbeddedDocuments("Item",[{_id:n.id,"system.quantity.value":i}]),await this.#v(),await this.close()):ui.notifications.error(game.i18n.localize("OSE.error.notEnoughGP"))}async _updateObject(e,t){e.preventDefault();const a=ChatMessage.getSpeaker({actor:this}),s=await this.getData(),n=await foundry.applications.handlebars.renderTemplate(`${o.systemPath()}/templates/chat/inventory-list.html`,s);ChatMessage.create({content:n,speaker:a}),await this.object.update(t),this.object.sheet.render(!0)}async#b(e){return e.items.reduce(((e,t)=>{const a=t.system;return!c.physicalItemTypes.has(t.type)||a.treasure||t.flags?.ose?.paid?e:e+(a.quantity.max?a.cost*a.quantity.value:a.cost)}),0)}async#v(){const e=[];this.object.items.forEach((t=>{const a=t.system;!c.physicalItemTypes.has(t.type)||a.treasure||t.flags?.ose?.paid||e.push({_id:t.id,"flags.ose.paid":!0})})),e.length>0&&await this.object.updateEmbeddedDocuments("Item",e)}activateListeners(e){super.activateListeners(e),e.find("a.auto-deduct").click((()=>{this.submit()}))}}class u extends FormApplication{static get defaultOptions(){const e=super.defaultOptions;return e.classes=["ose","dialog","modifiers"],e.id="sheet-modifiers",e.template=`${o.systemPath()}/templates/actors/dialogs/modifiers-dialog.html`,e.width=240,e}get title(){return`${this.object.name}: Modifiers`}getData(){const e=foundry.utils.deepClone(this.object);return e.user=game.user,e}activateListeners(e){super.activateListeners(e)}}class m extends FormApplication{static get defaultOptions(){const e=super.defaultOptions;return e.classes=["sheet-tweaks"],e.template=`${o.systemPath()}/templates/actors/dialogs/tweaks-dialog.html`,e.width=380,e}get title(){return`${this.object.name}: ${game.i18n.localize("OSE.dialog.tweaks")}`}getData(){const e=foundry.utils.deepClone(this.object);return"character"===e.type&&(e.isCharacter=!0),e.user=game.user,e.config={...CONFIG.OSE,ascendingAC:game.settings.get(game.system.id,"ascendingAC")},e}activateListeners(e){super.activateListeners(e)}async _updateObject(e,t){e.preventDefault();const a="system.encumbrance.max";"itembased"!==CONFIG.OSE.encumbrance.type||t[a]!==this.object.system.encumbrance.defaultMax&&t[a]!==this.object.system.encumbrance.alternateMax||(t[a]=null),await this.object.update(t),await this.object.sheet._render(!0)}}const d=e=>game.settings.get(game.system.id,"invertedCtrlBehavior")?!(e&&(e.ctrlKey||e.metaKey)):e&&(e.ctrlKey||e.metaKey);class g extends foundry.appv1.sheets.ActorSheet{_expanded=new Set;async getData(){const e=foundry.utils.deepClone(super.getData().data);for(const e of this.actor.items){const t=this._expanded.has(e.id);e.isExpanded=t,t&&await e.prepareDerivedData()}for(const t of e.items){const e=this._expanded.has(t.id);t.isExpanded=e,e&&await t.prepareDerivedData()}return e.owner=this.actor.isOwner,e.editable=this.actor.sheet.isEditable,e.isOwnerOrObserver=this.actor.isOwnerOrObserver,e.config={...CONFIG.OSE,ascendingAC:game.settings.get(game.system.id,"ascendingAC"),initiative:"group"!==game.settings.get(game.system.id,"initiative"),encumbrance:game.settings.get(game.system.id,"encumbranceOption"),encumbranceStrengthMod:game.settings.get(game.system.id,"encumbranceItemStrengthMod")&&"itembased"===game.settings.get(game.system.id,"encumbranceOption")},e.isNew=this.actor.isNew(),e.encumbranceTemplate=o.encumbrance?.templateEncumbranceBar||`${o.systemPath()}/templates/actors/partials/character-encumbrance.html`,e}activateEditor(e,t,a){super.activateEditor(e,t,a)}_getItemFromActor(e){const t=e.currentTarget.closest(".item-entry");return this.actor.items.get(t.dataset.itemId)}_toggleItemCategory(e){e.preventDefault();const t=$(e.currentTarget).next(".item-list");if("none"===t.css("display")){const a=$(e.currentTarget).find(".fas.fa-caret-right");a.removeClass("fa-caret-right"),a.addClass("fa-caret-down"),t.slideDown(200)}else{const a=$(e.currentTarget).find(".fas.fa-caret-down");a.removeClass("fa-caret-down"),a.addClass("fa-caret-right"),t.slideUp(200)}}_toggleContainedItems(e){e.preventDefault();const t=$(e.target.closest(".container")),a=t.find(".item-list.contained-items");if("none"===a.css("display")){const e=t.find(".fas.fa-caret-right");e.removeClass("fa-caret-right"),e.addClass("fa-caret-down"),a.slideDown(200)}else{const e=t.find(".fas.fa-caret-down");e.removeClass("fa-caret-down"),e.addClass("fa-caret-right"),a.slideUp(200)}}_toggleItemSummary(e){e.preventDefault();const t=e.currentTarget.closest(".item-entry.item"),a=t.querySelector(".item-summary");a.classList.contains("expanded")?this._expanded.delete(t.dataset.itemId):this._expanded.add(t.dataset.itemId),a.classList.toggle("expanded")}async _displayItemInChat(e){const t=$(e.currentTarget).closest(".item-entry");this.actor.items.get(t.data("itemId")).show()}async _promptRemoveItemFromActor(e){const t=this;return foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("OSE.dialog.deleteItem")},content:game.i18n.format("OSE.dialog.confirmDeleteItem",{name:e.name}),yes:{default:!1,callback:()=>{t._removeItemFromActor(e)}},defaultYes:!1})}async _removeItemFromActor(e){if("ability"===e.type||"spell"===e.type)return this.actor.deleteEmbeddedDocuments("Item",[e._id]);if("container"!==e.type&&""!==e.system.containerId){const{containerId:t}=e.system,a=this.actor.items.get(t).system.itemIds.filter((t=>t!==e.id));await this.actor.updateEmbeddedDocuments("Item",[{_id:t,system:{itemIds:a}}])}if("container"===e.type&&e.system.itemIds){const t=e.system.itemIds.reduce(((e,t)=>(this.actor.items.get(t)&&e.push({_id:t,"system.containerId":""}),e)),[]);await this.actor.updateEmbeddedDocuments("Item",t)}this.actor.deleteEmbeddedDocuments("Item",[e._id])}_useConsumable(e,t){const a=this._getItemFromActor(e);if(!a)return null;let{quantity:{value:s}}=a.system;a.update({"system.quantity.value":t?--s:++s})}async _onSpellChange(e){e.preventDefault();const t=this._getItemFromActor(e);return"cast"===e.target.dataset.field?t.update({"system.cast":parseInt(e.target.value)}):"memorize"===e.target.dataset.field?t.update({"system.memorized":parseInt(e.target.value)}):void 0}async _resetSpells(e){const t=e.currentTarget.closest(".inventory.spells").querySelectorAll(".item-entry"),a=[];for(const e of t){const{itemId:t}=e.dataset,s=this.actor.items.get(t);s?.system&&a.push({_id:s.id,"system.cast":s.system.memorized})}a.length>0&&await this.actor.updateEmbeddedDocuments("Item",a)}async _rollAbility(e){const t=this._getItemFromActor(e),a=t?.system;"weapon"===t.type?("monster"===this.actor.type&&await t.update({"system.counter.value":a.counter.value-1}),t.rollWeapon({skipDialog:d(e)})):"spell"==t.type?await t.spendSpell({skipDialog:d(e)}):await t.rollFormula({skipDialog:d(e)})}async _rollSave(e){const t=this.actor,a=e.currentTarget,{save:s}=a.parentElement.parentElement.dataset;t.rollSave(s,{event:e})}async _rollAttack(e){const t=this.actor,a=e.currentTarget,{attack:s}=a.parentElement.parentElement.dataset;t.targetAttack({roll:{}},s,{type:s,skipDialog:d(e)})}_onSortItem(e,t){const a=this.actor.items.get(t._id),s=this.actor.items.filter((e=>e.data._id!==a.data._id)),n=e.target.closest("[data-item-id]"),i=n?n.dataset.itemId:null,o=s.find((e=>e.data._id===i));if(!o)throw new Error(`Couldn't drop near ${e.target}`);const r=o?.system;"container"!==o?.type&&"container"!==o?.data?.type||""!==r.containerId?(""!==a?.system.containerId&&this.actor.updateEmbeddedDocuments("Item",[{_id:a.id,"system.containerId":""}]),super._onSortItem(e,t)):this.actor.updateEmbeddedDocuments("Item",[{_id:a.id,"system.containerId":o.id}])}_onDragStart(e){const t=e.currentTarget;let a,s=[];if(!e.target.classList.contains("content-link")){if(t.dataset.itemId){const e=this.actor.items.get(t.dataset.itemId);a=e.toDragData(),a.item=e,a.type="Item","container"===e.type&&e.system.itemIds.length>0&&(s=e.system.itemIds)}if(a.actorId=this.actor.id,a.sceneId=this.actor.isToken?canvas.scene?.id:null,a.tokenId=this.actor.isToken?this.actor.token.id:null,a.pack=this.actor.pack,t.dataset.effectId){const e=this.actor.effects.get(t.dataset.effectId);a.type="ActiveEffect",a.data=e.data}e.dataTransfer.setData("text/plain",JSON.stringify(a,((e,t)=>"itemIds"===e?JSON.stringify(s):t)))}}async _onDropFolder(e,t){const a=await fromUuid(t.uuid);if(!a||"Item"!==a.type)return;let s=a.contents||[];if(a.getSubfolders(!0).forEach((e=>{s.push(...e.contents)})),s.length>0&&s[0]?.uuid?.includes("Compendium")){const e=[];s.forEach((async t=>{e.push(await fromUuid(t.uuid))})),s=e}this._onDropItemCreate(s)}async _onDropItem(e,t){const a=e.target.closest(".item")?.dataset?.itemId,s=this.actor.items.get(a),n="container"===s?.type,i=await Item.implementation.fromDropData(t),o=i.toObject(),r=!!this.actor.items.get(i.id),l=this.actor.items.get(i.system.containerId);if(i.id!==a)return r||n?l?this._onContainerItemRemove(i,l):n?this._onContainerItemAdd(i,s):void 0:this._onDropItemCreate([o])}async _onContainerItemRemove(e,t){const a=t.system.itemIds.filter((t=>t!=e.id)),s=this.object.items.get(e.id);await t.update({system:{itemIds:a}}),await s.update({system:{containerId:""}})}async _onContainerItemAdd(e,t){const a=t.parent.items.find((t=>t.id===e.id));let s=e;if(!a){const t=await this._onDropItemCreate([e.toObject()]);s=t.pop()}if(!t.system.itemIds.find((e=>e.id===s.id))){const e=[...t.system.itemIds,s.id];await t.update({system:{itemIds:e}}),await s.update({system:{containerId:t.id,equipped:!1}})}}async _onDropItemCreate(e,t=!1){if((Array.isArray(e)?e:[e]).forEach((t=>{if(t.system.containerId&&""!==t.system.containerId&&(t.system.containerId=""),"container"===t.type&&"string"==typeof t.system.itemIds){const a=JSON.parse(t.system.itemIds);a.forEach((e=>{e.system.containerId=""})),e.push(...a)}})),!t)return this.actor.createEmbeddedDocuments("Item",e);const{itemIds:a}=t.system;a.push(e.id);const s=this.actor.items.get(e[0].id);return await t.update({system:{itemIds:a}}),s.update({system:{containerId:t.id}})}async _chooseItemType(e=["weapon","armor","shield","gear"]){const t={types:e.reduce(((e,t)=>(e[t]=t,e)),{})},a=await foundry.applications.handlebars.renderTemplate(`${o.systemPath()}/templates/items/entity-create.html`,t);return new Promise((e=>{new foundry.applications.api.DialogV2({window:{title:game.i18n.localize("OSE.dialog.createItem")},content:a,buttons:[{action:"ok",label:game.i18n.localize("OSE.Ok"),icon:"fas fa-check",default:!0,callback:(t,a,s)=>{e(new foundry.applications.ux.FormDataExtended(a.form).object)}},{action:"cancel",icon:"fas fa-times",label:game.i18n.localize("OSE.Cancel"),callback:()=>{}}]}).render(!0)}))}_createItem(e){e.preventDefault();const t=e.currentTarget,{treasure:a,type:s,lvl:n}=t.dataset,i=(e,t)=>({name:t||`New ${e.capitalize()}`,type:e});if("choice"!==s){const e=i(s);return a&&(e.system={treasure:!0}),"spell"===s&&(e.system=n?{lvl:n}:{lvl:1}),this.actor.createEmbeddedDocuments("Item",[e],{})}{const e=t.dataset.choices.split(",");this._chooseItemType(e).then((e=>{const t=i(e.type,e.name);this.actor.createEmbeddedDocuments("Item",[t],{})}))}}async _updateItemQuantity(e){e.preventDefault();const t=this._getItemFromActor(e);return"value"===e.target.dataset.field?t.update({"system.quantity.value":parseInt(e.target.value)}):"max"===e.target.dataset.field?t.update({"system.quantity.max":parseInt(e.target.value)}):void 0}async _renderInner(...e){const t=await super._renderInner(...e);this.form=t[0];const a=t.find(".resizable");if(0!==a.length)return a.each(((e,t)=>{const a=this.position.height-this.options.height;t.style.height=`${a+parseInt(t.dataset.baseSize)}px`})),t}async _onResize(e){super._onResize(e);const t=$(this.form),a=t.find(".resizable");if(0===a.length)return;a.each(((e,t)=>{const a=this.position.height-this.options.height;t.style.height=`${a+parseInt(t.dataset.baseSize)}px`}));t.find(".editor").each(((e,t)=>{const a=t.closest(".resizable-editor");if(a){const e=this.position.height-this.options.height;t.style.height=`${e+parseInt(a.dataset.editorSize)}px`}}))}_onConfigureActor(e){e.preventDefault(),new m(this.actor,{top:this.position.top+40,left:this.position.left+(this.position.width-400)/2}).render(!0)}_getHeaderButtons(){let e=super._getHeaderButtons();const t=game.user.isGM||this.actor.isOwner;return this.options.editable&&t&&(e=[{label:game.i18n.localize("OSE.dialog.tweaks"),class:"configure-actor",icon:"fas fa-code",onclick:e=>this._onConfigureActor(e)},...e]),e}activateListeners(e){super.activateListeners(e),e.find(".saving-throw .attribute-name a").click((e=>{this._rollSave(e)})),e.find(".attack a").click((e=>{this._rollAttack(e)})),e.find(".hit-dice .attribute-name").click((e=>{this.actor.rollHitDice({event:e})})),e.find(".item-rollable .item-image").click((async e=>{this._rollAbility(e)})),e.find(".inventory .item-category-title").click((e=>{this._toggleItemCategory(e)})),e.find(".inventory .item-category-title input").click((e=>{e.stopPropagation()})),e.find(".inventory .category-caret").click((e=>{this._toggleContainedItems(e)})),e.find(".item-name").click((e=>{this._toggleItemSummary(e)})),e.find(".item-controls .item-show").click((async e=>{this._displayItemInChat(e)})),this.options.editable&&(e.find(".item-create").click((e=>{this._createItem(e)})),e.find(".item-edit").click((e=>{this._getItemFromActor(e).sheet.render(!0)})),e.find(".item-delete").click((e=>{const t=this._getItemFromActor(e);this._promptRemoveItemFromActor(t)})),e.find(".quantity input").click((e=>e.target.select())).change(this._updateItemQuantity.bind(this)),e.find(".consumable-counter .full-mark").click((e=>{this._useConsumable(e,!0)})),e.find(".consumable-counter .empty-mark").click((e=>{this._useConsumable(e,!1)})),e.find(".memorize input").click((e=>e.target.select())).change(this._onSpellChange.bind(this)),e.find(".spells .item-reset[data-action='reset-spells']").click((e=>{this._resetSpells(e)})))}}class p extends g{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["ose","sheet","actor","character"],template:`${o.systemPath()}/templates/actors/character-sheet.html`,width:450,height:530,resizable:!0,tabs:[{navSelector:".sheet-tabs",contentSelector:".sheet-body",initial:"attributes"}],scrollY:[".inventory"]})}_prepareItems(e){e.owned={items:this.actor.system.items,armors:this.actor.system.armor,weapons:this.actor.system.weapons,treasures:this.actor.system.treasures,containers:this.actor.system.containers},e.treasure=this.actor.system.carriedTreasure,e.containers=this.actor.system.containers,e.abilities=this.actor.system.abilities,e.spells=this.actor.system.spells.spellList,e.slots=this.actor.system.spellSlots,e.system.usesAscendingAC=this.actor.system.usesAscendingAC,e.system.meleeMod=this.actor.system.meleeMod,e.system.rangedMod=this.actor.system.rangedMod,e.system.init=this.actor.system.init,[...Object.values(e.owned),...Object.values(e?.spells?.spellList||{}),e.abilities].forEach((e=>e.sort(((e,t)=>(e.sort||0)-(t.sort||0)))))}generateScores(){new l(this.actor,{top:this.position.top+40,left:this.position.left+(this.position.width-400)/2}).render(!0)}async getData(){const e=await super.getData();return this._prepareItems(e),e.enrichedBiography=await foundry.applications.ux.TextEditor.implementation.enrichHTML(this.object.system.details.biography,{async:!0}),e.enrichedNotes=await foundry.applications.ux.TextEditor.implementation.enrichHTML(this.object.system.details.notes,{async:!0}),e}async _chooseLang(){const e={choices:CONFIG.OSE.languages},t=await foundry.applications.handlebars.renderTemplate(`${o.systemPath()}/templates/actors/dialogs/lang-create.html`,e);return new Promise((e=>{new foundry.applications.api.DialogV2({window:{title:""},content:t,buttons:[{action:"ok",label:game.i18n.localize("OSE.Ok"),icon:"fas fa-check",default:!0,callback:(t,a,s)=>{e(new foundry.applications.ux.FormDataExtended(a.form).object)}},{action:"cancel",icon:"fas fa-times",label:game.i18n.localize("OSE.Cancel"),callback:()=>{}}]}).render(!0)}))}_pushLang(e){let t=this.actor.system[e];this._chooseLang().then((a=>{const s=CONFIG.OSE.languages[a.choice];t.value?t.value.push(s):t={value:[s]};const n={};return n[e]=t,this.actor.update({system:n})}))}_popLang(e,t){const a=this.actor.system[e].value.filter((e=>e!=t)),s={};return s[e]={value:a},this.actor.update({system:s})}_onShowModifiers(e){e.preventDefault(),new u(this.actor,{top:this.position.top+40,left:this.position.left+(this.position.width-400)/2}).render(!0)}async _prepareShoppingCartData(){const e=await this.getData(),t=e=>e.filter((e=>!e.flags?.ose?.paid)),a=foundry.utils.deepClone(e);return a.owned&&(a.owned.items=t(a.owned.items||[]),a.owned.weapons=t(a.owned.weapons||[]),a.owned.armors=t(a.owned.armors||[]),a.owned.containers=t(a.owned.containers||[])),a.items&&(a.items=t(a.items)),a}async _onShowGpCost(e){e.preventDefault();const t=await this._prepareShoppingCartData();new c(this.actor,t,{top:this.position.top+40,left:this.position.left+(this.position.width-400)/2}).render(!0)}activateListeners(e){super.activateListeners(e),e.find(".ability-score .attribute-name a").click((e=>{const t=this.actor,a=e.currentTarget,{score:s}=a.parentElement.parentElement.dataset,{stat:n}=a.parentElement.parentElement.dataset;s?t.rollCheck(s,{event:e}):"lr"===n&&t.rollLoyalty(s,{event:e})})),e.find(".exploration .attribute-name a").click((e=>{const t=this.actor,a=e.currentTarget.parentElement.parentElement.dataset.exploration;t.rollExploration(a,{event:e})})),e.find("a[data-action='modifiers']").click((e=>{this._onShowModifiers(e)})),e.find("a[data-action='gp-cost']").click((e=>{this._onShowGpCost(e)})),this.options.editable&&(e.find(".item-push").click((e=>{e.preventDefault();const t=e.currentTarget.dataset.array;this._pushLang(t)})),e.find(".item-pop").click((e=>{e.preventDefault();const t=e.currentTarget.dataset.array;this._popLang(t,$(e.currentTarget).closest(".item").data("lang"))})),e.find(".item-toggle").click((async e=>{const t=$(e.currentTarget).parents(".item"),a=this.actor.items.get(t.data("itemId"));await a.update({system:{equipped:!a.system.equipped}})})),e.find("a[data-action='generate-scores']").click((e=>{this.generateScores(e)})))}}class h{static baseAscending=10;static baseDescending=9;static propAscending="aac";static propDescending="ac";#f;#q;#S;#O;#k;constructor(e=!1,t=[],a=0,s=0){this.#k=e,this.#f=t,this.#q=a,this.#S=s,this.#O=this.#k?h.propAscending:h.propDescending}#E(){return this.#f.find((({system:{type:e}})=>"shield"===e))?.system[this.#O].value||0}get base(){return this.#k?h.baseAscending:h.baseDescending}get naked(){return this.#k?this.base+this.#q:this.base-this.#q}get shield(){return this.#E()}get#T(){const e=this.#f.find((({system:{type:e}})=>"shield"!==e))?.system[this.#O].value;return e||0===e?this.#k?e+this.#q:e-this.#q:null}get value(){const e=null===this.#T?this.naked:this.#T;return this.#k?e+this.shield+this.mod:e-this.shield-this.mod}set value(e){}get mod(){return this.#S}set mod(e){this.#S=e}}class y{static baseMoveRate=120;#I;#C;#e;#A;#N;#F;#D;constructor(t=new e,a=!0,s=y.baseMoveRate){this.#I=s,this.#C=a,this.#e=t.variant,this.#A=t.encumbered,this.#N=t.atFirstBreakpoint,this.#F=t.atSecondBreakpoint,this.#D=t.atThirdBreakpoint}#M(){return this.#A?0:this.#D?.25*this.#I:this.#F?.5*this.#I:this.#N?.75*this.#I:this.#I}get base(){return this.#C&&"disabled"!==this.#e?this.#M():this.#I}set base(e){this.#I=e}get encounter(){return this.base/3}get overland(){return this.base/5}}class w{static standardAttributeMods={0:-3,3:-3,4:-2,6:-1,9:0,13:1,16:2,18:3};static cappedAttributeMods={0:-2,3:-2,4:-1,6:-1,9:0,13:1,16:1,18:2};static openDoorMods={0:0,3:1,9:2,13:3,16:4,18:5};static literacyMods={0:"",3:"OSE.Illiterate",6:"OSE.LiteracyBasic",9:"OSE.Literate"};static spokenMods={0:"OSE.NativeBroken",3:"OSE.Native",13:"OSE.NativePlus1",16:"OSE.NativePlus2",18:"OSE.NativePlus3"};static valueFromTable(e,t){let a;for(let s=0;s<=t;s+=1)void 0!==e[s]&&(a=e[s]);return a}#x={value:0,bonus:0};#_={value:0,bonus:0};#R={value:0,bonus:0};#$={value:0,bonus:0};#z={value:0,bonus:0};#L={value:0,bonus:0};constructor({str:e,int:t,wis:a,dex:s,con:n,cha:i}={}){this.#x=e??{value:0,bonus:0},this.#_=t??{value:0,bonus:0},this.#R=a??{value:0,bonus:0},this.#$=s??{value:0,bonus:0},this.#z=n??{value:0,bonus:0},this.#L=i??{value:0,bonus:0}}get str(){return{value:this.#x.value,bonus:this.#x.bonus,mod:this.#P,od:this.#B}}set str(e){this.#x={...this.#x,...e}}get#P(){return w.valueFromTable(w.standardAttributeMods,this.#x.value)}get#B(){return w.valueFromTable(w.openDoorMods,this.#x.value)}get int(){return{value:this.#_.value,bonus:this.#_.bonus,mod:this.#j,literacy:this.#H,spoken:this.#G}}set int(e){this.#_={...this.#_,...e}}get#j(){return w.valueFromTable(w.standardAttributeMods,this.#_.value)}get#H(){return w.valueFromTable(w.literacyMods,this.#_.value)}get#G(){return w.valueFromTable(w.spokenMods,this.#_.value)}get wis(){return{value:this.#R.value,bonus:this.#R.bonus,mod:this.#W}}set wis(e){this.#R={...this.#R,...e}}get#W(){return w.valueFromTable(w.standardAttributeMods,this.#R.value)}get dex(){return{value:this.#$.value,bonus:this.#$.bonus,mod:this.#q,init:this.#U}}set dex(e){this.#$={...this.#$,...e}}get#q(){return w.valueFromTable(w.standardAttributeMods,this.#$.value)}get#U(){return w.valueFromTable(w.cappedAttributeMods,this.#$.value)}get con(){return{value:this.#z.value,bonus:this.#z.bonus,mod:this.#K}}set con(e){this.#z={...this.#z,...e}}get#K(){return w.valueFromTable(w.standardAttributeMods,this.#z.value)}get cha(){return{value:this.#L.value,bonus:this.#L.bonus,mod:this.#V,loyalty:this.#Y,retain:this.#X,npc:this.#Q}}set cha(e){this.#L={...this.#L,...e}}get#V(){return w.valueFromTable(w.standardAttributeMods,this.#L.value)}get#Q(){return w.valueFromTable(w.cappedAttributeMods,this.#L.value)}get#X(){return this.#V+4}get#Y(){return this.#V+7}}class b{#J={};#Z=[];#ee;constructor({enabled:e,...t},a=[]){this.#Z=a,this.#ee=e||!1;const s=this.#Z?.reduce(this.#te,{})||{};this.#J=Object.keys(t||{}).reduce(((e,a,n)=>this.#ae(e,a,n,s,t)),{})}get enabled(){return this.#ee}set enabled(e){this.#ee=e}get spellList(){return this.#Z.reduce(((e,t)=>((e,t)=>{const{lvl:a}=t.system,s=e[a]||[];return{...e,[a]:[...s,t].sort(((e,t)=>e.name.localeCompare(t.name)))}})(e,t)),{})}#te(e,t){const{lvl:a}=t.system;let{cast:s}=t.system;s&&!Number.isNaN(s)||(s=0);const n=e[a]||0;return{...e,[a]:n+s}}#ae(e,t,a,s,n){if("enabled"===t)return e;const i=a,o=n[i]?.max||0,r=s[i];return{...e,[i]:{used:r,max:o}}}get slots(){return this.#J}}const v=(e,t,a=null)=>e.items.filter((({type:e})=>e===t)).filter(a||(()=>!0));class f extends foundry.abstract.TypeDataModel{prepareDerivedData(){this.scores=new w(this.scores),this.encumbrance=new CONFIG.OSE.encumbrance(this.encumbrance.max,[...this.parent.items],{significantTreasure:game.settings.get(game.system.id,"significantTreasure"),scores:this.scores},this.scores.str.mod),this.movement=new y(this.encumbrance,this.config.movementAuto,this.movement.base),this.ac=new h(!1,v(this.parent,"armor",(e=>e.system.equipped)),this.scores.dex.mod,this.ac.mod),this.aac=new h(!0,v(this.parent,"armor",(e=>e.system.equipped)),this.scores.dex.mod,this.aac.mod),this.spells=new b(this.spells,this.#Z)}static defineSchema(){const{BooleanField:e,NumberField:t,ObjectField:a,SchemaField:s,StringField:n}=foundry.data.fields;return{spells:new a,scores:new a,details:new a,ac:new a,aac:new a,encumbrance:CONFIG.OSE.encumbrance.defineSchema(),movement:new a,config:new a,initiative:new s({value:new t({integer:!1,initial:0}),mod:new t({integer:!1,initial:0})}),hp:new s({hd:new n,value:new t({integer:!0}),max:new t({integer:!0})}),thac0:new a,languages:new a,saves:new s({breath:new s({value:new t({integer:!0})}),death:new s({value:new t({integer:!0})}),paralysis:new s({value:new t({integer:!0})}),spell:new s({value:new t({integer:!0})}),wand:new s({value:new t({integer:!0})})}),exploration:new s({ft:new t({integer:!0,positive:!0}),ld:new t({integer:!0,positive:!0}),od:new t({integer:!0,positive:!0}),sd:new t({integer:!0,positive:!0})}),retainer:new s({enabled:new e,loyalty:new t({integer:!0}),wage:new n})}}static migrateData(e){return this.#se(e),super.migrateData(e)}static#se(e){const t=e.spells??{};t&&!t[0]&&(t[0]={max:0,value:0})}get usesAscendingAC(){return game.settings.get(game.system.id,"ascendingAC")}get meleeMod(){const e=this.usesAscendingAC&&this.thac0.bba||0;return(this.scores.str?.mod||0)+(this.thac0?.mod?.melee||0)+e}get rangedMod(){const e=this.usesAscendingAC&&this.thac0.bba||0;return(this.scores.dex?.mod||0)+(this.thac0?.mod?.missile||0)+e}get isNew(){const{str:e,int:t,wis:a,dex:s,con:n,cha:i}=this.scores;return![e,t,a,s,n,i].reduce(((e,t)=>e+t.value),0)}get containers(){return v(this.parent,"container",(({system:{containerId:e}})=>!e))}get treasures(){return v(this.parent,"item",(({system:{treasure:e,containerId:t}})=>e&&!t))}get carriedTreasure(){const e=this.treasures.reduce(((e,{system:{quantity:t,cost:a}})=>e+t.value*a),0);return Math.round(100*e)/100}get items(){return v(this.parent,"item",(({system:{treasure:e,containerId:t}})=>!e&&!t))}get weapons(){return v(this.parent,"weapon",(({system:{containerId:e}})=>!e))}get armor(){return v(this.parent,"armor",(({system:{containerId:e}})=>!e))}get abilities(){return v(this.parent,"ability",(({system:{containerId:e}})=>!e)).sort(((e,t)=>(e.sort||0)-(t.sort||0)))}get spellList(){return v(this.parent,"spell",(({system:{containerId:e}})=>!e))}get#Z(){return this.spellList}get isSlow(){return 0!==this.weapons.length&&this.weapons.some((e=>!("weapon"!==e.type||!e.system.slow||!e.system.equipped)))}get init(){return"group"!==game.settings.get(game.system.id,"initiative")?(this.initiative.value||0)+(this.initiative.mod||0)+this.scores.dex.init:0}}const q=(e,t,a=null)=>e.items.filter((({type:e})=>e===t)).filter(a||(()=>!0));class S extends foundry.abstract.TypeDataModel{prepareDerivedData(){this.encumbrance=new n,this.spells=new b(this.spells,this.#Z),this.movement=new y(this.encumbrance,this.config.movementAuto=!1,this.movement.base)}static migrateData(e){return this.#ne(e),this.#se(e),super.migrateData(e)}static#ne(e){const t=e.languages??{};"function"!=typeof t?.value?.[Symbol.iterator]&&(t.value=[])}static#se(e){const t=e.spells??{};t&&!t[0]&&(t[0]={max:0,value:0})}static defineSchema(){const{StringField:e,NumberField:t,BooleanField:a,ObjectField:s,SchemaField:n}=foundry.data.fields;return{spells:new s,details:new s,ac:new s,aac:new s,encumbrance:new n({value:new t({integer:!1}),max:new t({integer:!1})}),movement:new s,config:new s,initiative:new n({value:new t({integer:!1,initial:0}),mod:new t({integer:!1,initial:0})}),hp:new n({hd:new e,value:new t({integer:!0}),max:new t({integer:!0})}),thac0:new s,languages:new s,saves:new n({breath:new n({value:new t({integer:!0})}),death:new n({value:new t({integer:!0})}),paralysis:new n({value:new t({integer:!0})}),spell:new n({value:new t({integer:!0})}),wand:new n({value:new t({integer:!0})})}),retainer:new n({enabled:new a,loyalty:new t({integer:!0}),wage:new e})}}get usesAscendingAC(){return game.settings.get(game.system.id,"ascendingAC")}get isNew(){return!Object.values(this.saves).reduce(((e,t)=>e+(parseInt(t?.value,10)||0)),0)}get containers(){return q(this.parent,"container",(({system:{containerId:e}})=>!e))}get treasures(){return q(this.parent,"item",(({system:{treasure:e,containerId:t}})=>e&&!t)).sort(((e,t)=>e.name.localeCompare(t.name)))}get items(){return q(this.parent,"item",(({system:{treasure:e,containerId:t}})=>!e&&!t)).sort(((e,t)=>e.name.localeCompare(t.name)))}get weapons(){return q(this.parent,"weapon",(({system:{containerId:e}})=>!e)).sort(((e,t)=>e.name.localeCompare(t.name)))}get armor(){return q(this.parent,"armor",(({system:{containerId:e}})=>!e)).sort(((e,t)=>e.name.localeCompare(t.name)))}get abilities(){return q(this.parent,"ability",(({system:{containerId:e}})=>!e)).sort(((e,t)=>(e.sort||0)-(t.sort||0)))}get attackPatterns(){return[...this.weapons,...this.abilities].sort(((e,t)=>"transparent"!==e.system.pattern&&"transparent"===t.system.pattern?-1:"transparent"===e.system.pattern&&"transparent"!==t.system.pattern||"white"===e.system.pattern&&"white"!==t.system.pattern?1:"white"===t.system.pattern&&"white"!==e.system.pattern?-1:t.type.localeCompare(e.type)||e.name.localeCompare(t.name))).reduce(((e,t)=>{const a={...e},{pattern:s}=t.system;return a[s]||(a[s]=[]),{...a,[s]:[...a[s],t]}}),{})}get#Z(){return q(this.parent,"spell",(({system:{containerId:e}})=>!e))}get isSlow(){return 0!==this.weapons.length&&this.weapons.every((e=>!("weapon"!==e.type||!e.system.slow)))}get init(){return"group"!==game.settings.get(game.system.id,"initiative")?(this.initiative.value||0)+(this.initiative.mod||0):0}}class O extends Item{static get defaultIcons(){return{spell:`${o.assetsPath}/default/spell.png`,ability:`${o.assetsPath}/default/ability.png`,armor:`${o.assetsPath}/default/armor.png`,weapon:`${o.assetsPath}/default/weapon.png`,item:`${o.assetsPath}/default/item.png`,container:`${o.assetsPath}/default/bag.png`}}static async create(e,t={}){return void 0===e.img&&(e.img=this.defaultIcons[e.type]),super.create(e,t)}static migrateData(e){return""===e?.img&&e.type&&(e.img=this.defaultIcons(e.type)),void 0===e?.system?.itemslots&&((e?.system?.tags??[]).some((e=>"Two-handed"===e.value))&&"weapon"===e?.type&&(e.system.itemslots=2),"heavy"===e?.system?.type&&"armor"===e.type&&(e.system.itemslots=2)),e}prepareData(){super.prepareData()}async prepareDerivedData(){this.system.enrichedDescription=await foundry.applications.ux.TextEditor.implementation.enrichHTML(this.system.description,{async:!0})}static chatListeners(e){e.addEventListener("click",(e=>{e.target.closest(".card-buttons button")&&O._onChatCardAction(e);e.target.closest(".item-name")&&O._onChatCardToggleContent(e)}))}async getChatData(e){const t=this.type,a=this.system,s=[];return"weapon"===t&&a.tags.forEach((e=>s.push(e.value))),"spell"===t&&s.push(`${a.class} ${a.lvl}`,a.range,a.duration),a.hasOwnProperty("equipped")&&s.push(a.equipped?"Equipped":"Not Equipped"),a.properties=s.filter((e=>!!e)),a}rollWeapon(e={}){const t="character"!=this.actor.type,a=this.system;let s=t?"attack":"melee";const n={item:this._source,actor:this.actor,roll:{save:a.save,target:null}};return a.missile&&a.melee&&!t?(new foundry.applications.api.DialogV2({window:{title:"Choose Attack Range"},content:"",buttons:[{action:"melee",icon:"fas fa-fist-raised",label:game.i18n.localize("OSE.Melee"),default:!0,callback:()=>{this.actor.targetAttack(n,"melee",e)}},{action:"missile",icon:"fas fa-bullseye",label:game.i18n.localize("OSE.Missile"),callback:()=>{this.actor.targetAttack(n,"missile",e)}}]}).render(!0),!0):(a.missile&&!t&&(s="missile"),this.actor.targetAttack(n,s,e),!0)}async rollFormula(e={}){const t=this.system;if(!t.roll)throw new Error("This Item does not have a formula to roll!");const a=`${this.name}`,s=[t.roll],n=t.rollType,i={actor:this.actor,item:this._source,description:null,save:t.save,properties:this.system.autoTags,roll:{type:n,target:t.rollTarget,blindroll:t.blindroll}};return"spell"===this.type&&(i.description=t.description),r.Roll({event:e.event,parts:s,data:i,skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.format("OSE.roll.formula",{label:a}),title:game.i18n.format("OSE.roll.formula",{label:a})})}async spendSpell(){if("spell"!==this.type)throw new Error("Trying to spend a spell on an item that is not a spell.");const e=this.system;await this.update({system:{cast:e.cast-1}}),e.roll?await this.rollFormula():await this.show({skipDialog:!0})}_getRollTag(e){if(e.roll){const t=`${e.roll}${e.rollTarget?CONFIG.OSE.roll_type[e.rollType]:""}${e.rollTarget?e.rollTarget:""}`;return{label:`${game.i18n.localize("OSE.items.Roll")} ${t}`}}}_getSaveTag(e){if(e.save)return{label:CONFIG.OSE.saves_long[e.save],icon:"fa-skull"}}getAutoTagList(){const e=[],t=this.system;switch(this.type){case"container":case"item":break;case"weapon":e.push({label:t.damage,icon:"fa-tint"}),t.missile&&e.push({label:`${t.range.short}/${t.range.medium}/${t.range.long}`,icon:"fa-bullseye"}),t.tags.forEach((t=>{e.push({label:t.value})}));break;case"armor":e.push({label:CONFIG.OSE.armor[t.type],icon:"fa-tshirt"});break;case"spell":e.push({label:t.class},{label:t.range},{label:t.duration});break;case"ability":t.requirements.split(",").forEach((t=>e.push({label:t})));break}const a=this._getRollTag(t);a&&e.push(a);const s=this._getSaveTag(t);return s&&e.push(s),e}async pushManualTag(e){const t=this?.system;let a=[];t.tags&&(a=t.tags);const s={},n=/\(([^)]+)\)/;return e.forEach((e=>{const t=n.exec(e);let i="";switch(t?(i=t[1],e=e.slice(0,Math.max(0,t.index)).trim()):i=e=e.trim(),i.toLowerCase()){case CONFIG.OSE.tags.melee.toLowerCase():s.melee=!0;break;case CONFIG.OSE.tags.slow.toLowerCase():s.slow=!0;break;case CONFIG.OSE.tags.missile.toLowerCase():s.missile=!0}i===e&&(s.melee||s.slow||s.missile)||a.push({title:i,value:e,label:e}),"Two-handed"===e&&"weapon"===this.type&&(s.itemslots=2)})),s.tags=a,this.update({system:s})}popManualTag(e){const t=this.system,{tags:a}=t;if(!a)return;const s={tags:a.filter((t=>t.value.toLowerCase()!==e.toLowerCase()))};return this.update({system:s})}roll(e={}){const t=this.system;switch(this.type){case"weapon":this.rollWeapon(e);break;case"spell":this.spendSpell(e);break;case"ability":t.roll?this.rollFormula():this.show();break;case"item":case"armor":this.show()}}async show(){const e=this.type,t=this.actor?.token,a={actor:this.actor,tokenId:t?`${t.parent.id}.${t.id}`:null,item:this._source,itemId:this._source._id,data:await this.getChatData(),labels:this.labels,isHealing:this.isHealing,hasDamage:this.hasDamage,isSpell:"spell"===e,hasSave:this.hasSave,config:CONFIG.OSE};a.rollFormula=new Roll(a.data.roll,a).formula,a.data.properties=this.system.autoTags;const s=`${o.systemPath()}/templates/chat/item-card.html`,n=await foundry.applications.handlebars.renderTemplate(s,a),i={user:game.user.id,type:CONST.CHAT_MESSAGE_STYLES.OTHER,content:n,speaker:{actor:this.actor?.id,token:this.actor?.token,alias:this.actor?.name}},r=game.settings.get("core","rollMode");return["gmroll","blindroll"].includes(r)&&(i.whisper=ChatMessage.getWhisperRecipients("GM")),"selfroll"===r&&(i.whisper=[game.user.id]),"blindroll"===r&&(i.blind=!0),ChatMessage.create(i)}static _onChatCardToggleContent(e){e.preventDefault();const t=e.target.closest(".item-name").closest(".chat-card").querySelector(".card-content");"none"===t.style.display?$(t).slideDown(200):$(t).slideUp(200)}static async _onChatCardAction(e){e.preventDefault();const t=e.target.closest(".card-buttons button");t.disabled=!0;const a=t.closest(".chat-card"),{messageId:s}=a.closest(".message").dataset,n=game.messages.get(s),{action:i}=t.dataset,o="save"===i;if(!(o||game.user.isGM||n.isAuthor))return;const r=this._getChatCardActor(a);if(!r)return;const l=r.items.get(a.dataset.itemId);if(!l)return ui.notifications.error(game.i18n.format("OSE.error.itemNoLongerExistsOnActor",{actorName:r.name,itemId:a.dataset.itemId}));let c=[];switch(o&&(c=this._getChatCardTargets(a)),i){case"damage":await l.rollDamage({event:e});break;case"formula":await l.rollFormula({event:e});break;case"save":if(0===c.length)return ui.notifications.error(game.i18n.localize("OSE.error.noTokenControlled")),t.disabled=!1;for(const a of c)await a.rollSave(t.dataset.save,{event:e})}t.disabled=!1}static _getChatCardActor(e){const t=e.dataset.tokenId;if(t){const[e,a]=t.split("."),s=game.scenes.get(e);if(!s)return null;const n=s.getEmbeddedDocument("Token",a);if(!n)return null;return new Token(n).actor}const{actorId:a}=e.dataset;return game.actors.get(a)||null}static _getChatCardTargets(e){const{character:t}=game.user,{controlled:a}=canvas.tokens,s=a.reduce(((e,t)=>t.actor?[...e,t.actor]:e),[]);return t&&0===a.length&&s.push(t),s}}const k=e=>e.reduce(((e,t)=>t?[...e,t]:e),[]);class E extends Actor{static migrateData(e){return""===e?.img&&(e.img="icons/svg/mystery-man.svg"),""===e?.prototypeToken?.texture?.img&&(e.prototypeToken.texture.img="icons/svg/mystery-man.svg"),e?.system?.movement?.value&&!e?.system?.details.movement&&(e.system.details.movement=e.system.movement.value,delete e.system.movement.value),e}async update(e,t={}){const a={...e},{"system.ac.value":s,"system.aac.value":n,"system.ac.mod":i,"system.aac.mod":o,"system.thac0.bba":r,"system.thac0.value":l}=a;return void 0!==s?a["system.aac.value"]=19-s:void 0!==n&&(a["system.ac.value"]=19-n),void 0!==i?a["system.aac.mod"]=i:void 0!==o&&(a["system.ac.mod"]=o),void 0!==l?a["system.thac0.bba"]=19-l:void 0!==r&&(a["system.thac0.value"]=19-r),super.update(a,t)}async createEmbeddedDocuments(e,t=[],a={}){return t.map((e=>{void 0===e.img&&(e.img=O.defaultIcons[e.type])})),super.createEmbeddedDocuments(e,t,a)}getExperience(e,t={}){const a=this.system;if("character"!==this.type)return;const s=Math.floor(e+a.details.xp.bonus*e/100);return this.update({"system.details.xp.value":s+a.details.xp.value}).then((()=>{const e=ChatMessage.getSpeaker({actor:this});ChatMessage.create({content:game.i18n.format("OSE.messages.GetExperience",{name:this.name,value:s}),speaker:e})}))}isNew(){return this.system.isNew}async _preCreate(e,t,a){if(await super._preCreate(e,t,a),this._stats?.compendiumSource?.startsWith("Compendium."))return;const s={};"character"===this.type&&Object.assign(s,{...void 0===e.prototypeToken?.actorLink&&{actorLink:!0},...void 0===e.prototypeToken?.disposition&&{disposition:foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY}}),this.updateSource({prototypeToken:s})}get isOwnerOrObserver(){return this.isOwner||this.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER)}generateSave(e){e=e.includes("+")?parseInt(e)+1:parseInt(e);let t={};for(let a=0;a<=e;a++){const e=CONFIG.OSE.monster_saves[a];e&&(t=e)}let a=20;Object.keys(CONFIG.OSE.monster_thac0).forEach((t=>{e<parseInt(t)||(a=CONFIG.OSE.monster_thac0[t])})),this.update({"system.thac0.value":a,"system.thac0.bba":19-a,"system.saves":{death:{value:t.d},wand:{value:t.w},paralysis:{value:t.p},breath:{value:t.b},spell:{value:t.s}}})}async rollHP(e={}){const{total:t}=await new Roll(this.system.hp.hd).roll({async:!0});return this.update({"system.hp":{max:t,value:t}})}rollSave(e,t={}){const a=game.i18n.localize(`OSE.saves.${e}.long`),s=this.system,n=this.type,i={actor:this,roll:{type:"above",target:s.saves[e].value,magic:"character"===n?s.scores.wis.mod:0},details:game.i18n.format("OSE.roll.details.save",{save:a})};return("character"===n?r.RollSave:r.Roll)({event:t.event,parts:["1d20"],data:i,skipDialog:t.fastForward||d(t.event),speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.format("OSE.roll.save",{save:a}),title:game.i18n.format("OSE.roll.save",{save:a}),chatMessage:t.chatMessage})}rollMorale(e={}){const t={actor:this,roll:{type:"below",target:this.system.details.morale}};return r.Roll({event:e.event,parts:["2d6"],data:t,skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.localize("OSE.roll.morale"),title:game.i18n.localize("OSE.roll.morale")})}rollLoyalty(e={}){const t=game.i18n.localize("OSE.roll.loyalty"),a={actor:this,roll:{type:"below",target:this.system.retainer.loyalty}};return r.Roll({event:e.event,parts:["2d6"],data:a,skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:t,title:t})}rollReaction(e={}){const t={actor:this,roll:{type:"table",table:{2:game.i18n.format("OSE.reaction.Hostile",{name:this.name}),3:game.i18n.format("OSE.reaction.Unfriendly",{name:this.name}),6:game.i18n.format("OSE.reaction.Neutral",{name:this.name}),9:game.i18n.format("OSE.reaction.Indifferent",{name:this.name}),12:game.i18n.format("OSE.reaction.Friendly",{name:this.name})}}};return r.Roll({event:e.event,parts:["2d6"],data:t,skipDialog:e.fastForward||d(e.event),speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.localize("OSE.reaction.check"),title:game.i18n.localize("OSE.reaction.check")})}rollCheck(e,t={}){if("character"!==this.type)return;const a=this.system,s=game.i18n.localize(`OSE.scores.${e}.long`),n={actor:this,roll:{type:"check",target:a.scores[e].value},details:game.i18n.format("OSE.roll.details.attribute",{score:s})};return r.Roll({event:t.event,parts:["1d20"],data:n,skipDialog:t.fastForward||d(t.event),speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.format("OSE.roll.attribute",{attribute:s}),title:game.i18n.format("OSE.roll.attribute",{attribute:s}),chatMessage:t.chatMessage})}rollHitDice(e={}){const t=this.type,a=this.system,s=game.i18n.localize("OSE.roll.hd");let n=[a.hp.hd];"character"===t&&(n=[`max(${a.hp.hd} + ${a.scores.con.mod*a.details.level}, ${a.hp.hd[0]})`]);const i={actor:this,roll:{type:"hitdice"}};return r.Roll({event:e.event,parts:n,data:i,skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:s,title:s})}rollAppearing(e={}){if("monster"!==this.type)return;const t=this.system,a=[];let s="";"wilderness"===e.check?(a.push(t.details.appearing.w),s="2"):(a.push(t.details.appearing.d),s="1");const n={actor:this,roll:{type:{type:"appearing"}}};return r.Roll({event:e.event,parts:a,data:n,skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.format("OSE.roll.appearing",{type:s}),title:game.i18n.format("OSE.roll.appearing",{type:s})})}rollExploration(e,t={}){if("character"!==this.type)return;const a=this.system,s=game.i18n.localize(`OSE.exploration.${e}.long`),n={actor:this,roll:{type:"below",target:a.exploration[e],blindroll:!0},details:game.i18n.format("OSE.roll.details.exploration",{expl:s})};return r.Roll({event:t.event,parts:["1d6"],data:n,skipDialog:t.fastForward||d(t.event),speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.format("OSE.roll.exploration",{exploration:s}),title:game.i18n.format("OSE.roll.exploration",{exploration:s})})}async rollDamage(e,t={}){const a=this.system,s={actor:this,item:e.item,roll:{type:"damage"}},n=[];return e.roll?.dmg?n.push(e.roll.dmg):n.push("1d6"),"melee"===e.roll?.type&&a.scores.str.mod&&n.push(a.scores.str.mod),r.Roll({event:t.event,parts:n,data:s,skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:`${e.label} - ${game.i18n.localize("OSE.Damage")}`,title:`${e.label} - ${game.i18n.localize("OSE.Damage")}`})}async targetAttack(e,t,a){if(game.user.targets.size>0)for(const s of game.user.targets.values())e.roll.target=s,await this.rollAttack(e,{type:t,skipDialog:a.skipDialog});else this.rollAttack(e,{type:t,skipDialog:a.skipDialog})}rollAttack(e,t={}){const a=this.system,s=e.item?game.i18n.format("OSE.roll.attacksWith",{name:e.item.name}):game.i18n.format("OSE.roll.attacks",{name:this.name}),n=k([e.item?.system?.damage??"1d6"]);game.settings.get(game.system.id,"ignoreAttackBonusOnDamageRoll")||this.system.config?.ignoreBonusDamage||!e.item?.system?.bonus||n.push(e.item?.system?.bonus);const i=["1d20"];game.settings.get(game.system.id,"ascendingAC")&&a.thac0.bba&&i.push(a.thac0.bba);let o=[];"melee"===t.type&&(o=[a.scores.str.mod,a.thac0.mod.melee]),n.push(...k(o)),"missile"===t.type&&(o=[a.scores.dex.mod,a.thac0.mod.missile]),e.item&&o.push(e.item?.system?.bonus),i.push(...k(o));const l={actor:this,item:e.item,itemId:e.item?._id,roll:{type:t.type,thac0:a.thac0.value,dmg:n,save:e.roll.save,target:e.roll.target}};return r.Roll({event:t.event,parts:i,data:l,skipDialog:t.skipDialog,speaker:ChatMessage.getSpeaker({actor:this}),flavor:s,flags:{ose:{roll:"attack",itemId:e.item?._id}},title:s})}async applyDamage(e=0,t=1){e=Math.floor(parseInt(e)*t);const{value:a,max:s}=this.system.hp;return this.update({"system.hp.value":Math.clamp(a-e,0,s)})}}class T extends g{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["ose","sheet","monster","actor"],template:`${o.systemPath()}/templates/actors/monster-sheet.html`,width:450,height:560,resizable:!0,tabs:[{navSelector:".tabs",contentSelector:".sheet-body",initial:"attributes"}]})}_prepareItems(e){e.owned={weapons:this.actor.system.weapons,items:this.actor.system.items,containers:this.actor.system.containers,armors:this.actor.system.armor,treasures:this.actor.system.treasures},e.attackPatterns=this.actor.system.attackPatterns,e.spells=this.actor.system.spells.spellList}async getData(){const e=await super.getData();this._prepareItems(e);const t=e?.system;return e.config.morale=game.settings.get(game.system.id,"morale"),t.details.treasure.link=await foundry.applications.ux.TextEditor.implementation.enrichHTML(t.details.treasure.table,{async:!0}),e.isNew=this.actor.isNew(),e.enrichedBiography=await foundry.applications.ux.TextEditor.implementation.enrichHTML(this.object.system.details.biography,{async:!0}),e.encumbranceTemplate="",e}async generateSave(){const e={choices:CONFIG.OSE.monster_saves},t=await foundry.applications.handlebars.renderTemplate(`${o.systemPath()}/templates/actors/dialogs/monster-saves.html`,e);return new foundry.applications.api.DialogV2({window:{title:game.i18n.localize("OSE.dialog.generateSaves")},position:{width:250},content:t,buttons:[{action:"ok",label:game.i18n.localize("OSE.Ok"),icon:"fas fa-check",default:!0,callback:(e,t)=>{const{hd:a}=new foundry.applications.ux.FormDataExtended(t.form).object;this.actor.generateSave(a.replace(/[^\d+.-]/g,""))}},{action:"cancel",icon:"fas fa-times",label:game.i18n.localize("OSE.Cancel"),callback:()=>{}}]}).render(!0)}async _onDrop(e){let t;super._onDrop(e);try{if(t=JSON.parse(e.dataTransfer.getData("text/plain")),"RollTable"!==t.type)return}catch(e){return!1}let a="";if(t.pack){const e=game.packs.get(t.pack).index.find((e=>e._id===t.id));a=`@UUID[${t.uuid}]{${e.name}}`}else a=`@UUID[${t.uuid}]`;this.actor.update({"system.details.treasure.table":a})}async _resetAttacks(e){return Promise.all(this.actor.items.filter((e=>"weapon"===e.type)).map((e=>e.update({"system.counter.value":parseInt(e.system.counter.max)}))))}async _updateAttackCounter(e){e.preventDefault();const t=this._getItemFromActor(e);return"value"===e.target.dataset.field?t.update({"system.counter.value":parseInt(e.target.value)}):"max"===e.target.dataset.field?t.update({"system.counter.max":parseInt(e.target.value)}):void 0}_cycleAttackPatterns(e){const t=super._getItemFromActor(e),a=t.system.pattern,s=Object.keys(CONFIG.OSE.colors);s.push("transparent");let n=s.indexOf(a);n+1===s.length?n=0:n++,t.update({"system.pattern":s[n]})}activateListeners(e){super.activateListeners(e),e.find(".morale-check a").click((e=>{this.actor.rollMorale({event:e})})),e.find(".reaction-check a").click((e=>{this.actor.rollReaction({event:e})})),e.find(".appearing-check a").click((e=>{const t=this.actor,a=$(e.currentTarget).closest(".check-field").data("check");t.rollAppearing({event:e,check:a})})),e.find(".treasure-table a").contextmenu((e=>{this.actor.update({"system.details.treasure.table":null})})),this.options.editable&&(e.find(".item-reset[data-action='reset-attacks']").click((e=>{this._resetAttacks(e)})),e.find(".counter input").click((e=>e.target.select())).change(this._updateAttackCounter.bind(this)),e.find(".hp-roll").click((e=>{this.actor.rollHP({event:e})})),e.find(".item-pattern").click((e=>this._cycleAttackPatterns(e))),e.find('button[data-action="generate-saves"]').click((()=>this.generateSave())))}}const I={rollTagFormula({actor:e={},data:t={roll:""}}={}){const a={actor:e,data:t};return new Roll(t.roll,a).formula},rollTagTarget:({rollType:e="",rollTarget:t=null}={})=>null===t?"":` ${CONFIG.OSE.roll_type[e]}${t}`};class C extends foundry.abstract.TypeDataModel{static defineSchema(){const{StringField:e,NumberField:t,BooleanField:a,ArrayField:s,ObjectField:n}=foundry.data.fields;return{save:new e,pattern:new e,requirements:new e,roll:new e,rollType:new e,rollTarget:new t,blindroll:new a,description:new e,tags:new s(new n)}}get#ie(){if(!this.roll)return null;return{label:`${game.i18n.localize("OSE.items.Roll")} ${I.rollTagFormula({actor:this.parent?.actor,data:this._source})}${I.rollTagTarget({rollType:this.rollType,rollTarget:this.rollTarget})}`}}get#oe(){return this.save?{label:CONFIG.OSE.saves_long[this.save],icon:"fa-skull"}:null}get manualTags(){return this.tags||[]}get autoTags(){return[...this.requirements?.split(",").map((e=>({label:e.trim()})))||[],this.#ie,this.#oe].filter((e=>!!e))}}class A extends foundry.abstract.TypeDataModel{static ArmorTypes={unarmored:"OSE.armor.unarmored",light:"OSE.armor.light",heavy:"OSE.armor.heavy",shield:"OSE.armor.shield"};static defineSchema(){const{SchemaField:e,StringField:t,NumberField:a,BooleanField:s,ArrayField:n,ObjectField:i}=foundry.data.fields;return{type:new t({initial:"light",choices:Object.keys(A.ArmorTypes)}),ac:new e({value:new a({initial:9})}),aac:new e({value:new a({initial:10})}),description:new t,tags:new n(new i),equipped:new s,cost:new a({min:0,initial:0}),containerId:new t,quantity:new e({value:new a({min:0,initial:0}),max:new a({min:0,initial:0})}),weight:new a({min:0,initial:0}),itemslots:new a({min:0,initial:1})}}get manualTags(){if(!this.tags)return null;const e=new Set(Object.values(CONFIG.OSE.auto_tags).map((({label:e})=>e)));return this.tags.filter((({value:t})=>!e.has(t))).map((({title:e,value:t})=>({title:e,value:t,label:t})))}get autoTags(){const e=Object.values(CONFIG.OSE.auto_tags),t=this.tags.map((({value:t})=>e.find((({label:e})=>t===e))));return[{label:A.ArmorTypes[this.type],icon:"fa-tshirt"},...t,...this.manualTags].flat().filter((e=>!!e))}}class N extends foundry.abstract.TypeDataModel{static defineSchema(){const{SchemaField:e,StringField:t,NumberField:a,ArrayField:s,ObjectField:n,BooleanField:i}=foundry.data.fields;return{itemIds:new s(new t),description:new t,tags:new s(new n),equipped:new i,cost:new a({min:0,initial:0}),containerId:new t,quantity:new e({value:new a({min:0,initial:0}),max:new a({min:0,initial:0})}),weight:new a({min:0,initial:0}),itemslots:new a({min:0,initial:1})}}get contents(){if(!this.itemIds)return null;if(!this?.parent?.parent?.items)return null;const{id:e}=this.parent;return this.parent.parent.items.filter((({system:{containerId:t}})=>e===t))}get totalWeight(){return this.contents?this.contents.reduce(((e,{system:{weight:t,quantity:a}})=>e+t*(a?.value||1)),0):0}get manualTags(){if(!this.tags)return null;const e=new Set(Object.values(CONFIG.OSE.auto_tags).map((({label:e})=>e)));return this.tags.filter((({value:t})=>!e.has(t))).map((({title:e,value:t})=>({title:e,value:t,label:t})))}get autoTags(){const e=Object.values(CONFIG.OSE.auto_tags);return[...this.tags.map((({value:t})=>e.find((({label:e})=>t===e)))),...this.manualTags].flat().filter((e=>!!e))}}class F extends foundry.abstract.TypeDataModel{static defineSchema(){const{SchemaField:e,StringField:t,NumberField:a,BooleanField:s,ArrayField:n,ObjectField:i}=foundry.data.fields;return{treasure:new s,description:new t,tags:new n(new i),equipped:new s,cost:new a({min:0,initial:0}),containerId:new t,quantity:new e({value:new a({min:0,initial:1}),max:new a({min:0,initial:0})}),weight:new a({min:0,initial:0}),itemslots:new a({min:0,initial:0})}}get cumulativeWeight(){return this.weight*this.quantity.value}get cumulativeCost(){return this.cost*this.quantity.value}get cumulativeItemslots(){return Math.ceil(this.itemslots*this.quantity.value)}static migrateData(e){return e.details?.description&&!e.description&&(e.description=e.details.description),e}get manualTags(){if(!this.tags)return null;const e=new Set(Object.values(CONFIG.OSE.auto_tags).map((({label:e})=>e)));return this.tags.filter((({value:t})=>!e.has(t))).map((({title:e,value:t})=>({title:e,value:t,label:t})))}get autoTags(){const e=Object.values(CONFIG.OSE.auto_tags);return[...this.tags.map((({value:t})=>e.find((({label:e})=>t===e)))),...this.manualTags].flat().filter((e=>!!e))}get isCoinsOrGems(){if(!this.treasure)return!1;if(this.tags?.some((e=>"gem"===e.value||"gems"===e.value||"coin"===e.value||"coins"===e.value)))return!0;if(!this.parent?.name)return!1;const e=this.parent.name.toLowerCase();if(e.endsWith(" coins"))return!0;return["cp","sp","ep","gp","pp",game.i18n.localize("OSE.items.gp.short").toLowerCase(),game.i18n.localize("OSE.items.gp.long").toLowerCase(),"[00.01] copper (cp)","[00.10] silver (sp)","[00.50] electrum (ep)","[01.00] gold (gp)","[10.00] platinum (pp)"].includes(e)}}class D extends foundry.abstract.TypeDataModel{static defineSchema(){const{StringField:e,NumberField:t,ArrayField:a,ObjectField:s}=foundry.data.fields;return{save:new e,lvl:new t({integer:!0,min:0}),class:new e,duration:new e,range:new e,roll:new e,memorized:new t({min:0}),cast:new t({min:0}),description:new e,tags:new a(new s)}}get#ie(){if(!this.roll)return null;return{label:`${game.i18n.localize("OSE.items.Roll")} ${I.rollTagFormula({actor:this.parent?.actor,data:this._source})}`}}get#oe(){return this.save?{label:CONFIG.OSE.saves_long[this.save],icon:"fa-skull"}:null}get manualTags(){return this.tags||[]}get autoTags(){return[{label:this.class??""},{label:this.range??""},{label:this.duration??""},this.#ie,this.#oe].filter((e=>!!e))}}class M extends foundry.abstract.TypeDataModel{static defineSchema(){const{SchemaField:e,StringField:t,NumberField:a,BooleanField:s,ArrayField:n,ObjectField:i}=foundry.data.fields;return{damage:new t,description:new t,tags:new n(new i),equipped:new s,save:new t,range:new e({short:new a({integer:!0,min:0,initial:0}),medium:new a({integer:!0,min:0,initial:0}),long:new a({integer:!0,min:0,initial:0})}),bonus:new a({}),pattern:new t,missile:new s,melee:new s({initial:!0}),slow:new s,counter:new e({value:new a({integer:!0,min:0,initial:0}),max:new a({integer:!0,min:0,initial:0})}),cost:new a({min:0,initial:0}),containerId:new t,quantity:new e({value:new a({min:0}),max:new a({min:0})}),weight:new a({min:0}),itemslots:new a({min:0,initial:1})}}get#re(){return this.missile?[CONFIG.OSE.auto_tags.missile,{label:`${this.range.short}/${this.range.medium}/${this.range.long}`,icon:"fa-bullseye"}]:null}get#le(){return this.melee?CONFIG.OSE.auto_tags.melee:null}get#ce(){return this.slow?CONFIG.OSE.auto_tags.slow:null}get#oe(){return this.save?{label:CONFIG.OSE.saves_long[this.save],icon:"fa-skull"}:null}get manualTags(){if(!this.tags)return null;const e=new Set(Object.values(CONFIG.OSE.auto_tags).map((({label:e})=>e)));return this.tags.filter((({value:t})=>!e.has(t)))}get qualities(){return[...this.autoTags.filter((e=>!!e.image)).map((e=>({...e,title:e.label}))),...this.manualTags]}get autoTags(){const e=Object.values(CONFIG.OSE.auto_tags),t=this.tags.map((({value:t})=>e.find((({label:e})=>t===e))));return[{label:this.damage??"",icon:"fa-tint"},this.#le,this.#re,this.#ce,...t,this.#oe].flat().filter((e=>!!e))}}class x extends foundry.appv1.sheets.ItemSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["ose","sheet","item"],width:520,height:390,resizable:!0,tabs:[{navSelector:".tabs",contentSelector:".sheet-body",initial:"description"}]})}get template(){return`${`${o.systemPath()}/templates/items`}/${this.item.type}-sheet.html`}async getData(){const{data:e}=super.getData();return e.editable=this.document.sheet.isEditable,e.config={...CONFIG.OSE,encumbrance:game.settings.get(game.system.id,"encumbranceOption")},e.enriched={description:await foundry.applications.ux.TextEditor.implementation.enrichHTML(this.item.system?.description||"",{async:!0})},e}activateListeners(e){e.find('input[data-action="add-tag"]').keypress((e=>{if(13===e.which){const t=$(e.currentTarget).val().split(",");this.object.pushManualTag(t)}})),e.find(".tag-delete").click((e=>{const t=e.currentTarget.parentElement.dataset.tag;this.object.popManualTag(t)})),e.find("a.melee-toggle").click((()=>{this.object.update({"system.melee":!this.object.system.melee})})),e.find("a.missile-toggle").click((()=>{this.object.update({"system.missile":!this.object.system.missile})})),super.activateListeners(e)}}async function _(e,t,a,s){game.user?.isGM&&e instanceof E?await e.applyDamage(t,a):ui.notifications?.error(game.i18n.format("OSE.error.cantDealDamageTo",{nameOrId:s}))}function R(e,t){const a=e.querySelectorAll(".dice-total"),s=a[a.length-1]?.textContent||"0",n=game.settings.get(game.system.id,"applyDamageOption");if(n===CONFIG.OSE.apply_damage_options.originalTarget){const a=e.querySelector(".chat-target")?.dataset.id;(async()=>{const e=(await fromUuid(a||""))?.actor;await _(e,s,t,e?.name||a||"original target")})()}n===CONFIG.OSE.apply_damage_options.targeted&&game.user?.targets.forEach((e=>_(e.actor,s,t,e.name))),n===CONFIG.OSE.apply_damage_options.selected&&canvas.tokens?.controlled.forEach((e=>_(e.actor,s,t,e.name)))}function z(e){if(!game.user?.isGM)return!1;if(!e.querySelector(".dice-total"))return!1;const t=game.settings.get(game.system.id,"applyDamageOption");switch(t){case CONFIG.OSE.apply_damage_options.originalTarget:const a=e.querySelectorAll(".chat-target");return!!a[a.length-1]?.dataset.id;case CONFIG.OSE.apply_damage_options.targeted:return!!game.user?.targets?.size;case CONFIG.OSE.apply_damage_options.selected:return!!canvas.tokens?.controlled.length;default:return ui.notifications?.error(game.i18n.format("OSE.error.unexpectedSettings",{configName:"applyDamageOption",configValue:t})),!1}}const L=e=>z(e),P=(e,t)=>(t.push({name:game.i18n.localize("OSE.messages.applyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:L,callback:e=>R(e,1)},{name:game.i18n.localize("OSE.messages.applyHealing"),icon:'<i class="fas fa-user-plus"></i>',condition:L,callback:e=>R(e,-1)}),t);async function B(e,t){const a=async e=>{const t=new Roll("1d100");return await t.evaluate(),t.total<=e};if(t.treasure={},e.getFlag(game.system.id,"treasure")){for(const s of e.results)if(await a(s.weight)){const e=await s.getHTML();t.treasure[s.id]={img:s.img,text:await foundry.applications.ux.TextEditor.implementation.enrichHTML(e,{async:!0})};const a=foundry.utils.parseUuid(s.documentUuid),n=a?.collection?.metadata?.id??a?.documentType??"";if(s.type===CONST.TABLE_RESULT_TYPES.DOCUMENT&&"RollTable"===n){const e=await fromUuid(s.documentUuid);await B(e,t.treasure[s.id])}}}else{const{results:a}=await e.roll();for(const e of a)t.treasure[e.id]={img:e.img,text:await e.getHTML()}}return t}async function j(e,t={}){const a=await B(e,{}),s={treasure:a.treasure,table:e};if(t.event){$(t.event.currentTarget.parentElement).prev().find(".table-result").each(((e,t)=>{t.classList.remove("active"),a.treasure[t.dataset.resultId]&&t.classList.add("active")}))}await new Promise((e=>requestAnimationFrame(e)));const n={content:await foundry.applications.handlebars.renderTemplate(`${o.systemPath()}/templates/chat/roll-treasure.html`,s)},i=game.settings.get("core","rollMode");["gmroll","blindroll"].includes(i)&&(n.whisper=ChatMessage.getWhisperRecipients("GM")),"selfroll"===i&&(n.whisper=[game.user._id]),"blindroll"===i&&(n.blind=!0),ChatMessage.create(n)}const H={drawTreasure:B,rollTreasure:j};async function G(e,t){if("Macro"===e.type)return game.user.assignHotbarMacro(await fromUuid(e.uuid),t);if("RollTable"===e.type){const a=`game.ose.rollTableMacro("${e.uuid}");`,s=await fromUuid(e.uuid),n=await Macro.create({name:s.name,type:"script",img:s.img,command:a,flags:{"ose.tableMacro":!0}});return game.user.assignHotbarMacro(n,t)}if("Item"!==e.type)return ui.notifications.warn(game.i18n.localize("OSE.warn.macrosNotAnItem"));if(e.uuid.indexOf("Item.")<=0)return ui.notifications.warn(game.i18n.localize("OSE.warn.macrosOnlyForOwnedItems"));const{item:a}=e,s=`game.ose.rollItemMacro("${a.name}");`;let n=game.macros.contents.find((e=>e.name===a.name&&e.command===s));return n&&void 0!==n.ownership[game.userId]||(n=await Macro.create({name:a.name,type:"script",img:a.img,command:s,flags:{"ose.itemMacro":!0}})),game.user.assignHotbarMacro(n,t)}function W(e){const t=ChatMessage.getSpeaker();if(!t.actor||!t.scene)return ui.notifications.warn(game.i18n.localize("OSE.warn.macrosNoTokenOwnedInScene"));let a;t.token&&(a=game.actors.tokens[t.token]),a||(a=game.actors.get(t.actor));const s=a?a.items.filter((t=>t.name===e)):[];if(s.length>1)ui.notifications.warn(game.i18n.format("OSE.warn.moreThanOneItemWithName",{actorName:a.name,itemName:e}));else if(0===s.length)return ui.notifications.error(game.i18n.format("OSE.error.noItemWithName",{actorName:a.name,itemName:e}));return s[0].roll()}function U(e){fromUuid(e).then((t=>null===t?ui.notifications.error(game.i18n.format("OSE.error.noRollTableWithUuId",{uuid:e})):t.getFlag(game.system.id,"treasure")?j(t):t.draw({displayChat:!0})))}const K={get currentParty(){return game.actors.filter((e=>"character"===e.type&&e.flags[game.system.id]&&!0===e.flags[game.system.id].party))}};class V extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["ose","dialog","party-xp"],template:`${o.systemPath()}/templates/apps/party-xp.html`,width:300,height:"auto",resizable:!1,closeOnSubmit:!0})}get title(){return game.i18n.localize("OSE.dialog.xp.deal")}getData(){return{actors:K.currentParty,data:this.object,config:CONFIG.OSE,user:game.user,settings:game.settings}}_onDrop(e){let t;e.preventDefault();try{if(t=JSON.parse(e.dataTransfer.getData("text/plain")),"Item"!==t.type)return}catch(e){return!1}}_updateObject(e){this._dealXP(e)}_calculateShare(){const{currentParty:e}=K,t=$(this.form),a=t.find('input[name="total"]').val(),s=parseFloat(a)/e.length;e.forEach((e=>{const a=e?.system,n=Math.floor(a.details.xp.share/100*s);t.find(`li[data-actor-id='${e.id}'] input`).val(n)}))}_dealXP(){$(this.form).find(".actor").each(((e,t)=>{const a=$(t),s=a.find("input").val(),n=a.data("actorId"),i=K.currentParty.find((e=>e.id===n));s&&i.getExperience(Math.floor(parseInt(s,10)))}))}activateListeners(e){super.activateListeners(e);e.find('input[name="total"]').on("input",this._calculateShare.bind(this)),e.find('button[data-action="deal-xp"').click((e=>{super.submit(e)}))}}const Y={partySheet:void 0};class X extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["ose","dialog","party-sheet"],template:`${o.systemPath()}/templates/apps/party-sheet.html`,width:280,height:400,resizable:!0,dragDrop:[{dragSelector:".actor-list .actor",dropSelector:".party-members"}],closeOnSubmit:!1})}static init(){Y.partySheet=new X}static showPartySheet(e={}){X.partySheet.render(!0,{focus:!0,...e})}static get partySheet(){return Y.partySheet}get title(){return game.i18n.localize("OSE.dialog.partysheet")}getData(){const e={ascending:game.settings.get(game.system.id,"ascendingAC")};return{partyActors:K.currentParty,config:CONFIG.OSE,user:game.user,settings:e}}async _addActorToParty(e){"character"===e.type&&await e.setFlag(game.system.id,"party",!0)}async _removeActorFromParty(e){await e.setFlag(game.system.id,"party",!1)}_onDrop(e){let t;e.preventDefault();try{switch(t=JSON.parse(e.dataTransfer.getData("text/plain")),t.type){case"Actor":return this._onDropActor(e,t);case"Folder":return this._onDropFolder(e,t)}}catch(e){return!1}}async _onDropActor(e,t){if("Actor"!==t.type)return;const a=await fromUuid(t.uuid);this._addActorToParty(a)}_recursiveAddFolder(e){e.contents.forEach((e=>this._addActorToParty(e))),e.children.forEach((e=>this._recursiveAddFolder(e.folder)))}async _onDropFolder(e,t){const a=await fromUuid(t.uuid);"Actor"===a?.type&&this._recursiveAddFolder(a)}async _onDragStart(e){try{const{uuid:t}=e.currentTarget.dataset,a=(await fromUuid(t)).toDragData();e.dataTransfer.setData("text/plain",JSON.stringify(a))}catch(e){return!1}return!0}async _dealXP(e){new V(this.object,{}).render(!0)}activateListeners(e){super.activateListeners(e),e.find(".header #deal-xp").click(this._dealXP.bind(this));const t=e=>{const t=e.currentTarget.closest(".actor").dataset.actorId;return game.actors.get(t)};e.find(".field-img button[data-action='open-sheet']").click((e=>{t(e).sheet.render(!0)})),e.find(".field-img button[data-action='remove-actor']").click((async e=>{await this._removeActorFromParty(t(e)),this.render(!0)}))}}const Q=e=>{e.getFlag(game.system.id,"party")&&X.partySheet.render()};const{HandlebarsApplicationMixin:J,ApplicationV2:Z}=foundry.applications.api;class ee extends(J(Z)){_highlighted;static DEFAULT_OPTIONS={id:"combat-set-groups-{id}",classes:["combat-set-groups"],tag:"form",window:{frame:!0,positioned:!0,title:"OSE.combat.SetCombatantGroups",icon:"fa-solid fa-flag",controls:[],minimizable:!1,resizable:!0,contentTag:"section",contentClasses:[]},actions:{},form:{handler:void 0,submitOnChange:!0},position:{width:600,height:"auto"}};static PARTS={main:{template:"/systems/ose/dist/templates/apps/combat-set-groups.hbs"}};async _prepareContext(e){return{groups:o.colors,combatants:game.combat?.combatants||[]}}_onRender(e,t){super._onRender(e,t);for(const e of this.element.querySelectorAll("[data-combatant-id]"))e.addEventListener("mouseover",this.#ue.bind(this)),e.addEventListener("mouseout",this.#me.bind(this));this.element.addEventListener("change",this._updateObject)}async _updateObject(e){e.preventDefault(),e.stopPropagation();const t=e.target;if(!t?.name||!t?.value)return;const a=game.combat?.combatants.get(t.name);a&&await a.assignGroup(t.value)}#ue(e){if(e.preventDefault(),!canvas.ready)return;const t=e.currentTarget,{combatantId:a}=t.dataset;if(!a)return;const s=game.combat?.combatants.get(a),n=s.token?.object;n?.isVisible&&(n.controlled||n._onHoverIn(e,{hoverOutOthers:!0}),this._highlighted=n)}#me(e){e.preventDefault(),this._highlighted&&this._highlighted._onHoverOut(e),this._highlighted=null}}const te={slow:"OSE.items.Slow",cast:"OSE.spells.Cast"};class ae extends foundry.documents.Combat{static FORMULA="1d6 + @init";static GROUP_FORMULA="1d6";static get GROUPS(){return{...o.colors,...Object.entries(te).reduce(((e,[t,a])=>(e[t]=game.i18n.localize(a),e)),{})}}#de=new Map;get#ge(){return game.settings.get(game.system.id,"rerollInitiative")}get isGroupInitiative(){return"group"===game.settings.get(game.system.id,"initiative")}async#pe({excludeAlreadyRolled:e=!1,updateTurn:t=!1}={}){const a=this.isGroupInitiative?ae.GROUP_FORMULA:ae.FORMULA;await this.rollInitiative(this.combatants.filter((t=>!(t.defeated||e&&null!==t.initiative))).map((e=>e.id)),{formula:a,updateTurn:t})}async smartRerollInitiative({excludeAlreadyRolled:e=!1,updateTurn:t=!1}={}){if(!this.isGroupInitiative)return this.#pe({excludeAlreadyRolled:e,updateTurn:t});const a=[],s=[];for(const t of this.groups){if(0===t.members.size||e&&null!==t.initiative||"slow"===t.name)continue;const n=new Roll(ae.GROUP_FORMULA);await n.evaluate(),a.push({_id:t.id,initiative:n.total});const i=game.settings.get("core","rollMode"),o={speaker:{alias:game.i18n.localize("OSE.Initiative")},flavor:game.i18n.format("OSE.roll.initiative",{group:foundry.utils.escapeHTML(t.name)}),flags:{"core.initiativeRoll":!0}},r=await n.toMessage(o,{rollMode:i,create:!1});s.push(r)}return 0===a.length||(await foundry.documents.ChatMessage.implementation.create(s),await this.updateEmbeddedDocuments("CombatantGroup",a)),this}async onUpdateCombatantGroup(){this.setupTurns(),await ui.combat.render(!0)}async rollAll(e){await super.rollAll(e);let t=null===this.turn||0===this.turns.length?null:0;return this.settings.skipDefeated&&null!==t&&(t=this.turns.findIndex((e=>!e.isDefeated)),-1===t&&(ui.notifications.warn("COMBAT.NoneRemaining",{localize:!0}),t=0)),await this.update({turn:t}),this.setupTurns(),await ui.combat.render(!0),this}async startCombat(){return await super.startCombat(),"reset"!==this.#ge&&await this.smartRerollInitiative({excludeAlreadyRolled:!0}),this}async resetActions(){for(const e of this.combatants)await e.setFlag(game.system.id,"prepareSpell",!1),await e.setFlag(game.system.id,"moveInCombat",!1)}async _onEndRound(e){if(await super._onEndRound(e),e?.round){switch(this.#ge){case"reset":await this.resetAll();break;case"reroll":await this.smartRerollInitiative()}await this.resetActions()}}async resetAll(e){if(await super.resetAll(e),this.isGroupInitiative){const e=this.groups.map((e=>({_id:e.id,initiative:null})));e.length>0&&await this.updateEmbeddedDocuments("CombatantGroup",e)}}async activateCombatant(e){game.user.isGM&&await game.combat.update({turn:e})}async assignGroup(e,t){if(!t)return;if(this.#de.has(t))await this.#de.get(t);else{const e=this.createEmbeddedDocuments("CombatantGroup",[{name:t,initiative:null}]);this.#de.set(t,e),await e}const a=this.groups.find((e=>e.name===t));a&&await e.update({group:a.id})}async createGroups(){for(const e of this.combatants){if(e.group)continue;const t=e.groupRaw;t&&await this.assignGroup(e,t)}return this.groups}setCombatantGroups(){(new ee).render(!0,{focus:!0})}_sortCombatants(e,t){const a=Number.isNumeric(e.initiative)?e.initiative:-1/0,s=(Number.isNumeric(t.initiative)?t.initiative:-1/0)-a;if(0!==s)return s;if(e.group?.name&&t.group?.name&&e.group?.name!==t.group?.name){const a=Object.keys(ae.GROUPS),s=a.indexOf(e.group.name)-a.indexOf(t.group.name);if(0!==s)return s}const n=e.token?.disposition??0,i=t.token?.disposition??0;if(n!==i)return i-n;if(e.hasPlayerOwner!==t.hasPlayerOwner)return e.hasPlayerOwner?-1:1;if(e.hasPlayerOwner&&t.hasPlayerOwner){const a=!!e.system?.retainer?.enabled;if(a!==!!t.system?.retainer?.enabled)return a?1:-1}else if(!e.hasPlayerOwner&&!t.hasPlayerOwner){const a=!!e.system?.retainer?.enabled;if(a!==!!t.system?.retainer?.enabled)return a?-1:1}return e.name&&e.name===t.name?e.id>t.id?1:-1:(e.name||"").localeCompare(t.name||"")}}class se extends Combatant{static INITIATIVE_VALUE_SLOWED=-789;static INITIATIVE_VALUE_DEFEATED=-790;get isCasting(){return this.getFlag(game.system.id,"prepareSpell")}set isCasting(e){this.setFlag(game.system.id,"prepareSpell",e)}get isSlow(){return this.actor?.system?.isSlow}get isDefeated(){return!!this.defeated||!this.defeated&&0===this.actor?.system?.hp?.value}getInitiativeRoll(e){let t=e||CONFIG.Combat.initiative.formula;this.isSlow&&(t=`${se.INITIATIVE_VALUE_SLOWED}`),this.isDefeated&&(t=`${se.INITIATIVE_VALUE_DEFEATED}`);const a=this.actor?.getRollData()||{};return new Roll(t,a)}async getData(e={}){const t=await super.getData(e);return foundry.utils.mergeObject(t,{slow:this.isSlow,casting:this.isCasting})}async assignGroup(e){e||(e=this.groupRaw),this.group?.name!==e&&await this.combat.assignGroup(this,e)}get groupRaw(){if(this.actor?.system?.isSlow)return"slow";const e=this.group?.name;if(e)return e;switch(this.token?.disposition){case-1:return"red";case 0:return"purple";case 1:return"green";default:return"white"}}}class ne extends foundry.applications.sidebar.tabs.CombatTracker{static DEFAULT_OPTIONS={...foundry.applications.sidebar.tabs.CombatTracker.DEFAULT_OPTIONS,actions:{...foundry.applications.sidebar.tabs.CombatTracker.DEFAULT_OPTIONS.actions,casting:ne.#he,retreat:ne.#he}};async _prepareTrackerContext(e,t){return await super._prepareTrackerContext(e,t),e.turns?.forEach((e=>{const t=game.combat.combatants.get(e.id);e.isSlowed=e.initiative===`${se.INITIATIVE_VALUE_SLOWED}`,e.isCasting=!!t.getFlag(game.system.id,"prepareSpell"),e.isRetreating=!!t.getFlag(game.system.id,"moveInCombat"),e.isOwnedByUser=!!t.actor?.isOwner,e.group=t.group})),e}static#he(...e){return this._onCombatantControl(...e)}async _onCombatantControl(e,t){e.preventDefault(),e.stopPropagation();const a=t||e.currentTarget,{combatantId:s}=a.closest(".combatant").dataset,n=this.viewed.combatants.get(s);switch(a.dataset.control||a.dataset.action){case"casting":return await this.#ye(n,"prepareSpell"),super._onCombatantControl(e,t);case"retreat":return await this.#ye(n,"moveInCombat"),super._onCombatantControl(e,t)}return super._onCombatantControl(e,t)}_configureRenderOptions(e){return super._configureRenderOptions(e),this.constructor.PARTS.tracker.template=`${o.systemPath()}/templates/sidebar/combat-tracker-combatant.hbs`,e}async#ye(e,t){const a=!!e.getFlag(game.system.id,t);await e.setFlag(game.system.id,t,!a)}_getEntryContextOptions(){const e=super._getEntryContextOptions();return[{name:game.i18n.localize("OSE.combat.SetCombatantAsActive"),icon:'<i class="fas fa-star-of-life"></i>',callback:e=>{const{combatantId:t}=e.dataset,a=this.viewed.turns.findIndex((e=>e.id===t));this.viewed.activateCombatant(a)}},...e]}async renderGroups(e){if(!this.viewed||"group"!==game.settings.get(game.system.id,"initiative"))return;const t=e.querySelector(".combat-tracker-header .control-buttons");if(t){const e=document.createElement("button");e.type="button",e.classList.add("inline-control","combat-control","combat-button","icon","fa-solid","fa-dice"),e.dataset.action="smartRerollInitiative",e.dataset.tooltip=game.i18n.localize("OSE.Reroll"),e.ariaLabel=game.i18n.localize("OSE.Reroll");const a=document.createElement("button");a.type="button",a.classList.add("inline-control","combat-control","combat-button","icon","fa-solid","fa-flag"),a.dataset.action="setCombatantGroups",a.dataset.tooltip=game.i18n.localize("OSE.combat.SetCombatantGroups"),a.ariaLabel=game.i18n.localize("OSE.combat.SetCombatantGroups"),t.replaceChildren(e,a)}const a=e.querySelector(".directory-list, .combat-tracker");for(const e of this.viewed?.groups?.values()){if(!e.members?.size)continue;const t=a?.querySelectorAll([...e.members.map((e=>`[data-combatant-id="${e?.id}"]`))].join(", "))||[];if(0===t.length)continue;const s=e.name,n=document.createElement("li"),i=document.createElement("span");i.classList.add("create-button"),i.style.fontSize="1.25em",i.style.fontWeight="600",i.style.flex="0 0 20px",i.style.textAlign="center","slow"===s?i.innerHTML='<i class="fa fa-weight-hanging"></i>':i.textContent=e.initiative;const o=document.createElement("div");o.className="group-header flexrow",o.style.background=`linear-gradient(90deg, var(--ose-group-color-${s}, ${s}), transparent)`;const r=document.createElement("div");r.className="token-name";const l=document.createElement("strong");l.className="name";const c=document.createElement("i");c.className="fas fa-dice-d6",l.append(c),l.append(" ",game.i18n.localize("slow"===s?"OSE.items.Slow":`OSE.colors.${s}`)),r.append(l),o.append(r),o.append(i.cloneNode(!0));const u=document.createElement("div");u.className="wrapper";const m=document.createElement("ol");m.className="group-children",u.append(m),n.append(o),n.append(u),n.dataset.groupKey=s,n.dataset.initiative="slow"===s?"-1":e.initiative,t[0].before(n),n.querySelector(".group-children")?.replaceChildren(...t)}}}class ie extends foundry.canvas.placeables.tokens.TokenRuler{_getGridHighlightStyle(e,t){const a=super._getGridHighlightStyle(e,t);if(!this.token?.actor||!a?.color)return a;let s=this.token.actor.system?.movement?.base??120;const{cost:n}=e.measurement;return this.token.actor?.inCombat&&(s=Math.floor(s/3)),n>s?{...a,color:10027008}:a}}const oe=e=>new Promise((t=>{setTimeout(t,e)})),re=()=>{if(game.messages?.size)return game.messages?.documentClass.deleteDocuments([],{deleteAll:!0})},le=()=>oe(120),ce=e=>Object.values(ui.windows).filter((t=>t.options.classes.includes(e))),ue=()=>Object.values(ui.windows).filter((e=>e.options.classes.includes("dialog"))),me=()=>Array.from(foundry.applications.instances.values()).filter((e=>e.options.classes.includes("dialog"))),de=async()=>{for(const e of ue())await e.close()},ge=async()=>{for(const e of me())await e.close()},pe=async()=>{for(const e of ce("sheet"))await e.close();le()},he=()=>Array.from(document.querySelectorAll("#notifications li").values()),ye=e=>"string"==typeof e?.message&&"string"==typeof e?.type&&"function"==typeof e?.remove,we=(e,t)=>1-e/t,be=async(e,t={},a="")=>CONFIG.Actor.documentClass.create({...t,name:`Test Actor ${a}`,type:e}),ve=async(e,t=`New World Test ${e.capitalize()}`)=>CONFIG.Item.documentClass.create({type:e,name:t}),fe=async(e,t,a=`New Actor Test ${t.capitalize()}`,s={})=>e?.createEmbeddedDocuments("Item",[{type:t,name:a,...s}]),qe=async()=>CONFIG.Macro.documentClass.create({name:`Mock Macro ${foundry.utils.randomID()}`,type:"script",command:"console.log('Testing Macro');"}),Se=async()=>CONFIG.Scene.documentClass.create({name:"Mock Scene",tokenVision:!0}),Oe=async e=>game.actors?.getName(`Test Actor ${e}`),ke=async e=>foundry.documents.collections.CompendiumCollection.createCompendium({label:"Test Compendium",name:"testcompendium",type:e,path:"",private:!1,package:"world"}),Ee=async()=>game.packs.get("world.testcompendium")?.deleteCompendium(),Te=async()=>{const e=game.macros?.filter((e=>e.name?.includes("Mock Macro")));for(const t of e||[])await t.delete();return!0},Ie=async e=>{for(const t of game.actors?.filter((t=>t.name===`Test Actor ${e}`)))await t.delete()},Ce=async()=>{for(const e of game.items?.filter((e=>e?.name?.includes("New World Test"))))await e.delete()},Ae=async()=>{for(const e of game.scenes?.filter((e=>"Mock Scene"===e.name)))await e.delete()},Ne=new Set(["spell","ability","armor","weapon","item","container"]),Fe="ose.actor.datamodel.character",De={displayName:"OSE: Actor: Data Model: Character"},Me=()=>be("character",{},Fe);var xe=({describe:e,it:t,expect:a,after:s,before:n})=>{const i=new f,o=game.settings.get(game.system.id,"ascendingAC"),r=game.settings.get(game.system.id,"initiative"),l=game.settings.get(game.system.id,"encumbranceOption");s((async()=>{game.settings.set(game.system.id,"ascendingAC",o),game.settings.set(game.system.id,"initiative",r),game.settings.set(game.system.id,"encumbranceOption",l),await Ie(Fe)})),e("prepareDerivedData()",(()=>{n((async()=>{await game.settings.set(game.system.id,"encumbranceOption","detailed"),await Me()})),t("has scores",(async()=>{const e=await Oe(Fe);a(e?.system.scores).not.undefined,a(e?.system.scores.str).not.undefined,a(e?.system.scores.str.od).not.undefined,a(e?.system.scores.int).not.undefined,a(e?.system.scores.int.literacy).not.undefined,a(e?.system.scores.int.spoken).not.undefined,a(e?.system.scores.wis).not.undefined,a(e?.system.scores.dex).not.undefined,a(e?.system.scores.dex.init).not.undefined,a(e?.system.scores.con).not.undefined,a(e?.system.scores.cha).not.undefined,a(e?.system.scores.cha.loyalty).not.undefined,a(e?.system.scores.cha.retain).not.undefined,a(e?.system.scores.cha.npc).not.undefined})),t("has encumbrance",(async()=>{const e=await Oe(Fe);a(e?.system.encumbrance).not.undefined,a(e?.system.encumbrance.variant).not.undefined,a(e?.system.encumbrance.enabled).not.undefined,a(e?.system.encumbrance.pct).not.undefined,a(e?.system.encumbrance.encumbered).not.undefined,a(e?.system.encumbrance.steps).not.undefined,a(e?.system.encumbrance.value).not.undefined,a(e?.system.encumbrance.max).not.undefined,a(e?.system.encumbrance.steps).not.undefined})),t("has movement",(async()=>{const e=await Oe(Fe);a(e?.system.movement).not.undefined,a(e?.system.movement.base).not.undefined,a(e?.system.movement.encounter).not.undefined,a(e?.system.movement.overland).not.undefined})),t("has ac",(async()=>{const e=await Oe(Fe);a(e?.system.ac).not.undefined,a(e?.system.ac.base).not.undefined,a(e?.system.ac.naked).not.undefined,a(e?.system.ac.shield).not.undefined,a(e?.system.ac.value).not.undefined,a(e?.system.ac.mod).not.undefined})),t("has aac",(async()=>{const e=await Oe(Fe);a(e?.system.aac).not.undefined,a(e?.system.aac.base).not.undefined,a(e?.system.aac.naked).not.undefined,a(e?.system.aac.shield).not.undefined,a(e?.system.aac.value).not.undefined,a(e?.system.aac.mod).not.undefined})),e("has spells",(()=>{const e=new Set(["1","2","3","4","5","6"]);t("has spells",(async()=>{const e=await Oe(Fe);a(e?.system.spells).not.undefined,a(e?.system.spells.enabled).not.undefined,a(e?.system.spells.spellList).not.undefined,a(e?.system.spells.slots).not.undefined})),e.forEach((e=>{t(`has spell level ${e}`,(async()=>{const t=await Oe(Fe);a(t?.system.spells.slots[e]).not.undefined,a(Object.keys(t?.system.spells.slots[e])).contain("used"),a(Object.keys(t?.system.spells.slots[e])).contain("max")}))}))})),s((async()=>{await Ie(Fe)}))})),e("defineSchema()",(()=>{n((async()=>{await Me()}));["config","initiative","thac0","languages"].forEach((e=>{t(`has ${e}`,(async()=>{const t=await Oe(Fe);a(t?.system[e]).not.undefined}))}));[{field:"hp",subFields:["hd","value","max"]},{field:"exploration",subFields:["ft","ld","od","sd"]},{field:"retainer",subFields:["enabled","loyalty","wage"]}].forEach((({field:e,subFields:s})=>{s.forEach((s=>{t(`${e} field has ${s} subfield`,(async()=>{const t=await Oe(Fe);a(t?.system[e]).not.undefined,a(t?.system[e][s]).not.undefined}))}))}));[{field:"saves",subFields:[{subField:"breath",subSubField:["value"]},{subField:"death",subSubField:["value"]},{subField:"paralysis",subSubField:["value"]},{subField:"spell",subSubField:["value"]},{subField:"wand",subSubField:["value"]}]}].forEach((({field:e,subFields:s})=>{s.forEach((({subField:s,subSubField:n})=>{t(`${e} field has ${s} subfield, which has ${n} field`,(async()=>{const t=await Oe(Fe);a(t?.system[e]).not.undefined,a(t?.system[e][s]).not.undefined,a(t?.system[e][s][n]).not.undefined}))}))})),s((async()=>{await Ie(Fe)}))})),e("usesAscendingAC()",(()=>{t("successfully reads from settings",(()=>{a(i.usesAscendingAC).equal(game.settings.get(game.system.id,"ascendingAC"))}))})),e("meleeMod()",(()=>{e("ascendingAC on",(()=>{n((async()=>{await game.settings.set(game.system.id,"ascendingAC",!0)})),t("without scores, return 0 if bba undefined",(()=>{a(i.meleeMod).equal(0)})),t("without scores, return thac0.bba when bba defined",(()=>{i.thac0.bba=12,a(i.meleeMod).equal(12),i.thac0.bba=0,a(i.thac0.bba).equal(0)}))})),e("ascendingAC off",(()=>{n((async()=>{await game.settings.set(game.system.id,"ascendingAC",!1)})),t("without scores, return 0",(async()=>{a(i.meleeMod).equal(0)}))})),t("adds str modifier",(()=>{i.scores.str={mod:10},a(i.meleeMod).equal(10),i.scores.str.mod=0,a(i.scores.str.mod).equal(0)})),t("adds thac0 melee modifier",(()=>{i.thac0.mod={melee:5},a(i.meleeMod).equal(5),i.thac0.mod.melee=0,a(i.thac0.mod.melee).equal(0)}))})),e("rangedMod()",(()=>{e("ascendingAC on",(()=>{n((async()=>{await game.settings.set(game.system.id,"ascendingAC",!0)})),t("without scores, return 0 if bba undefined",(()=>{a(i.rangedMod).equal(0)})),t("without scores, return thac0.bba when bba defined",(()=>{i.thac0.bba=12,a(i.rangedMod).equal(12),i.thac0.bba=0,a(i.thac0.bba).equal(0)}))})),e("ascendingAC off",(()=>{n((async()=>{await game.settings.set(game.system.id,"ascendingAC",!1)})),t("without scores, return 0",(async()=>{a(i.rangedMod).equal(0)}))})),t("adds dex modifier",(()=>{i.scores.dex={mod:10},a(i.rangedMod).equal(10),i.scores.dex.mod=0,a(i.scores.dex.mod).equal(0)})),t("adds thac0 missile modifier",(()=>{i.thac0.mod={missile:5},a(i.rangedMod).equal(5),i.thac0.mod.missile=0,a(i.thac0.mod.missile).equal(0)}))})),e("isNew()",(()=>{t("New when all ability scores are at 0",(async()=>{const e=await be("character",{system:{scores:{str:{value:0},int:{value:0},wis:{value:0},dex:{value:0},con:{value:0},cha:{value:0}}}},Fe);a(e?.system.isNew).to.be.true})),t("Not new when any ability score is above 0",(async()=>{const e=await be("character",{system:{scores:{str:{value:10},int:{value:0},wis:{value:0},dex:{value:0},con:{value:0},cha:{value:0}}}},Fe);a(e?.system.isNew).to.be.false})),t("New when all saves are at 0",(async()=>{const e=await be("monster",{system:{saves:{breath:{value:0},death:{value:0},paralysis:{value:0},spell:{value:0},wand:{value:0}}}},Fe);a(e?.system.isNew).to.be.true})),t("Not new when any save is above 0",(async()=>{const e=await be("monster",{system:{saves:{breath:{value:10},death:{value:0},paralysis:{value:0},spell:{value:0},wand:{value:0}}}},Fe);a(e?.system.isNew).to.be.false})),s((async()=>{await Ie(Fe)}))})),e("containers()",(()=>{t("returns all containers",(async()=>{const e=await Me();a(e?.items.contents.length).equal(0),a(e?.system.containers.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}])),a(e?.items.contents.length).equal(1);const t=e?.items.getName("test container");a(t).to.not.be.undefined,a(t?.name).equal("test container"),a(e?.system.containers.length).equal(1),a(e?.system.containers[0]._id).equal(t?.id),await(e?.delete())}))})),e("treasures()",(()=>{t("returns treasures on actor",(async()=>{const e=await Me();a(e?.items.contents.length).equal(0),a(e?.system.treasures.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0}}])),a(e?.items.contents.length).equal(1);const t=e?.items.getName("test treasure");a(t).to.not.be.undefined,a(t?.name).equal("test treasure"),a(t?.system.treasure).is.true,a(e?.system.treasures.length).equal(1),a(e?.system.treasures[0]._id).equal(t?.id),await(e?.delete())})),t("doesn't returns treasures on actor if in container",(async()=>{const e=await Me();a(e?.items.contents.length).equal(0),a(e?.system.treasures.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]));const t=e?.items.getName("test container");a(t).to.not.be.undefined,a(t?.name).equal("test container"),await(e?.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0,containerId:t?.id}}])),a(e?.items.contents.length).equal(2);const s=e?.items.getName("test treasure");a(s).to.not.be.undefined,a(s?.name).equal("test treasure"),a(s?.system.treasure).is.true,a(s?.system.containerId).equal(t?.id),a(e?.system.treasures.length).equal(0),await(e?.delete())}))})),e("carriedTreasure()",(()=>{t("return treasure value on actor",(async()=>{const e=await Me();a(e?.items.contents.length).equal(0),a(e?.system.carriedTreasure).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0,quantity:{value:1},cost:10}}])),a(e?.items.contents.length).equal(1);const t=e?.items.getName("test treasure");a(t).to.not.be.undefined,a(t?.name).equal("test treasure"),a(t?.system.treasure).is.true,a(e?.system.carriedTreasure).equal(10),await(e?.delete())})),t("return multiple treasure value on actor",(async()=>{const e=await Me();a(e?.items.contents.length).equal(0),a(e?.system.carriedTreasure).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0,quantity:{value:1},cost:10}},{type:"item",name:"test treasure 2",system:{treasure:!0,quantity:{value:3},cost:4}}])),a(e?.items.contents.length).equal(2);const t=e?.items.getName("test treasure");a(t).to.not.be.undefined,a(t?.name).equal("test treasure"),a(t?.system.treasure).is.true;const s=e?.items.getName("test treasure 2");a(s).to.not.be.undefined,a(s?.name).equal("test treasure 2"),a(s?.system.treasure).is.true,a(e?.system.carriedTreasure).equal(22),await(e?.delete())})),t("doesn't returns treasure value on actor if in container",(async()=>{const e=await Me();a(e?.items.contents.length).equal(0),a(e?.system.carriedTreasure).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]));const t=e?.items.getName("test container");a(t).to.not.be.undefined,a(t?.name).equal("test container"),await(e?.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0,containerId:t?.id,quantity:{value:1},cost:10}}])),a(e?.items.contents.length).equal(2);const s=e?.items.getName("test treasure");a(s).to.not.be.undefined,a(s?.name).equal("test treasure"),a(s?.system.treasure).is.true,a(s?.system.containerId).equal(t?.id),a(e?.system.carriedTreasure).equal(0),await(e?.delete())}))})),e("items()",(()=>{t("only returns other items than treasure",(async()=>{const e=await Me();a(e?.items.contents.length).equal(0),a(e?.system.items.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"item",name:"test item"},{type:"item",name:"test treasure",system:{treasure:!0,quantity:{value:3},cost:4}}])),a(e?.items.contents.length).equal(2);const t=e?.items.getName("test item");a(t).to.not.be.undefined,a(t?.name).equal("test item");const s=e?.items.getName("test treasure");a(s).to.not.be.undefined,a(s?.name).equal("test treasure"),a(s?.system.treasure).is.true,a(e?.system.items.length).equal(1),a(e?.system.items[0].name).equal("test item"),await(e?.delete())})),t("only returns other items than stored in containers",(async()=>{const e=await Me();a(e?.items.contents.length).equal(0),a(e?.system.items.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]));const t=e?.items.getName("test container");a(t).to.not.be.undefined,a(t?.name).equal("test container"),await(e?.createEmbeddedDocuments("Item",[{type:"item",name:"test item in container",system:{containerId:t?.id}},{type:"item",name:"test item"}])),a(e?.items.contents.length).equal(3);const s=e?.items.getName("test item in container");a(s).to.not.be.undefined,a(s?.name).equal("test item in container");const n=e?.items.getName("test item");a(n).to.not.be.undefined,a(n?.name).equal("test item"),a(e?.system.items.length).equal(1),a(e?.system.items[0].name).equal("test item"),await(e?.delete())}))}));[{type:"weapon",getter:"weapons"},{type:"ability",getter:"abilities"},{type:"armor",getter:"armor"},{type:"spell",getter:"spellList"}].forEach((({type:s,getter:n})=>{e(`${n}()`,(()=>{t(`returns all ${n}`,(async()=>{const e=await Me();a(e?.items.contents.length).equal(0),a(e?.system[n].length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:s,name:`test ${s}`}])),a(e?.items.contents.length).equal(1);const t=e?.items.getName(`test ${s}`);a(t).to.not.be.undefined,a(t?.name).equal(`test ${s}`),a(e?.system[n].length).equal(1),a(e?.system[n][0]._id).equal(t?.id),await(e?.delete())})),t(`returns all ${n} except ones in container`,(async()=>{switch(n){case"abilities":case"spellList":return}const e=await Me();a(e?.items.contents.length).equal(0),a(e?.system[n].length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]));const t=e?.items.getName("test container");a(t).to.not.be.undefined,a(t?.name).equal("test container"),await(e?.createEmbeddedDocuments("Item",[{type:s,name:`test ${s} in container`,system:{containerId:t?.id}},{type:s,name:`test ${s}`}])),a(e?.items.contents.length).equal(3);const i=e?.items.getName(`test ${s} in container`);a(i).to.not.be.undefined,a(i?.name).equal(`test ${s} in container`);const o=e?.items.getName(`test ${s}`);a(o).to.not.be.undefined,a(o?.name).equal(`test ${s}`),a(e?.system[n].length).equal(1),a(e?.system[n][0]._id).equal(o?.id),await(e?.delete())}))}))})),e("isSlow()",(()=>{t("returns false if no weapons",(async()=>{const e=await Me();a(e?.system.isSlow).is.false,await(e?.delete())})),t("returns false if weapon that has slow tag and not equipped",(async()=>{const e=await Me();a(e?.items.contents.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"weapon",name:"test weapon",system:{slow:!0,equipped:!1}}])),a(e?.items.contents.length).equal(1);const t=e?.items.getName("test weapon");a(t).to.not.be.undefined,a(t?.name).equal("test weapon"),a(e?.system.isSlow).is.false,await(e?.delete())})),t("returns false if weapon that doesn't have slow tag and is equipped",(async()=>{const e=await Me();a(e?.items.contents.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"weapon",name:"test weapon",system:{slow:!1,equipped:!0}}])),a(e?.items.contents.length).equal(1);const t=e?.items.getName("test weapon");a(t).to.not.be.undefined,a(t?.name).equal("test weapon"),a(e?.system.isSlow).is.false,await(e?.delete())})),t("returns true if weapon that has slow tag and is equipped",(async()=>{const e=await Me();a(e?.items.contents.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"weapon",name:"test weapon",system:{slow:!0,equipped:!0}}])),a(e?.items.contents.length).equal(1);const t=e?.items.getName("test weapon");a(t).to.not.be.undefined,a(t?.name).equal("test weapon"),a(e?.system.isSlow).is.true,await(e?.delete())}))})),e("init()",(()=>{e("group inititative",(()=>{n((async()=>{await game.settings.set(game.system.id,"initiative","group")})),t("returns 0",(()=>{a(i.init).equal(0)})),t("returns 0 with initiative value set",(async()=>{i.initiative.value=12,a(i.init).equal(0),i.initiative.value=0,a(i.initiative.value).equal(0)})),t("returns 0 with initiative mod set",(async()=>{i.initiative.mod=10,a(i.init).equal(0),i.initiative.mod=0,a(i.initiative.mod).equal(0)})),t("returns 0 with dex mod init set",(async()=>{i.dex={mod:{init:5}},a(i.init).equal(0),i.dex.mod.init=0,a(i.dex.mod.init).equal(0)}))})),e("individual inititative",(()=>{n((async()=>{await game.settings.set(game.system.id,"initiative","individual"),i.scores=new w({dex:{value:9,bonus:0,mod:0}})})),t("returns 0 by default",(()=>{a(i.initiative.value).equal(0),a(i.initiative.mod).equal(0),a(i.scores.dex.init).equal(0),a(i.init).equal(0)})),t("returns correctly with initiative value set",(async()=>{i.initiative.value=12,a(i.init).equal(12),i.initiative.value=0,a(i.initiative.value).equal(0)})),t("returns correctly with initiative mod set",(async()=>{i.initiative.mod=10,a(i.init).equal(10),i.initiative.mod=0,a(i.initiative.mod).equal(0)})),t("returns correctly with dex mod init set",(async()=>{i.scores.dex={value:18},a(i.init).equal(2),i.scores.dex={value:9},a(i.scores.dex.init).equal(0)})),t("returns correctly with initiative value, mod, and dex mod init set",(async()=>{i.initiative.value=12,i.initiative.mod=10,i.scores.dex={value:18},a(i.init).equal(24),i.initiative.value=0,a(i.initiative.value).equal(0),i.initiative.mod=0,a(i.initiative.mod).equal(0),i.scores.dex={value:9},a(i.scores.dex.init).equal(0)}))}))}))};const _e={displayName:"OSE: Actor: Data Model: Character AC"};var Re=({describe:e,it:t,expect:a})=>{const s=new Item.implementation({name:"Armor",type:"armor",system:{ac:{value:4},aac:{value:4},type:"light",equipped:!0}}),n=new Item.implementation({name:"Shield",type:"armor",system:{ac:{value:2},aac:{value:2},type:"shield",equipped:!0}}),i=[s],o=[n],r=[s,n],l=-1,c=-4;e("Naked AC values",(()=>{e("Returns the default base AC",(()=>{t("When ascending",(()=>{const e=new h(!0);a(e.value).to.equal(h.baseAscending)})),t("When descending",(()=>{const e=new h;a(e.value).to.equal(h.baseDescending)}))}))})),e("Armored AC values",(()=>{e("Returns the expected AC, provided equipment",(()=>{e("With armor",(()=>{t("When ascending",(()=>{const e=new h(!0,i);a(e.value).to.equal(4)})),t("When descending",(()=>{const e=new h(!1,i);a(e.value).to.equal(4)}))})),e("With shield",(()=>{t("When ascending",(()=>{const e=new h(!0,o);a(e.value).to.equal(h.baseAscending+2)})),t("When descending",(()=>{const e=new h(!1,o);a(e.value).to.equal(h.baseDescending-2)}))})),e("With armor and shield",(()=>{t("When ascending",(()=>{const e=new h(!0,r);a(e.value).to.equal(6)})),t("When descending",(()=>{const e=new h(!1,r);a(e.value).to.equal(2)}))}))}))})),e("With a dexterity modifier",(()=>{e("Positive modifier",(()=>{e("When ascending",(()=>{const e=h.baseAscending;t("Unarmored, no shield",(()=>{const t=new h(!0,[],3);a(t.value).to.equal(e+3)})),t("Armored, no shield",(()=>{const e=new h(!0,i,3);a(e.value).to.equal(7)})),t("Unarmored, shield",(()=>{const t=new h(!0,o,3);a(t.value).to.equal(e+2+3)})),t("Armored, shield",(()=>{const e=new h(!0,r,3);a(e.value).to.equal(9)}))})),e("When descending",(()=>{const e=h.baseDescending;t("Unarmored, no shield",(()=>{const t=new h(!1,[],3);a(t.value).to.equal(e-3)})),t("Armored, no shield",(()=>{const e=new h(!1,i,3);a(e.value).to.equal(1)})),t("Unarmored, shield",(()=>{const t=new h(!1,o,3);a(t.value).to.equal(e-2-3)})),t("Armored, shield",(()=>{const e=new h(!1,r,3);a(e.value).to.equal(-1)}))}))})),e("Negative modifier",(()=>{e("When ascending",(()=>{const e=h.baseAscending;t("Unarmored, no shield",(()=>{const t=new h(!0,[],l);a(t.value).to.equal(e+l)})),t("Armored, no shield",(()=>{const e=new h(!0,i,l);a(e.value).to.equal(3)})),t("Unarmored, shield",(()=>{const t=new h(!0,o,l);a(t.value).to.equal(e+2+l)})),t("Armored, shield",(()=>{const e=new h(!0,r,l);a(e.value).to.equal(5)}))})),e("When descending",(()=>{const e=h.baseDescending;t("Unarmored, no shield",(()=>{const t=new h(!1,[],l);a(t.value).to.equal(e-l)})),t("Armored, no shield",(()=>{const e=new h(!1,i,l);a(e.value).to.equal(5)})),t("Unarmored, shield",(()=>{const t=new h(!1,o,l);a(t.value).to.equal(e-2-l)})),t("Armored, shield",(()=>{const e=new h(!1,r,l);a(e.value).to.equal(3)}))}))}))})),e("With an arbitrary modifier",(()=>{e("Positive modifier",(()=>{e("When ascending",(()=>{const e=h.baseAscending;t("Unarmored, no shield",(()=>{const t=new h(!0,[],0,2);a(t.value).to.equal(e+2)})),t("Armored, no shield",(()=>{const e=new h(!0,i,0,2);a(e.value).to.equal(6)})),t("Unarmored, shield",(()=>{const t=new h(!0,o,0,2);a(t.value).to.equal(e+2+2)})),t("Armored, shield",(()=>{const e=new h(!0,r,0,2);a(e.value).to.equal(8)}))})),e("When descending",(()=>{const e=h.baseDescending;t("Unarmored, no shield",(()=>{const t=new h(!1,[],0,2);a(t.value).to.equal(e-2)})),t("Armored, no shield",(()=>{const e=new h(!1,i,0,2);a(e.value).to.equal(2)})),t("Unarmored, shield",(()=>{const t=new h(!1,o,0,2);a(t.value).to.equal(e-2-2)})),t("Armored, shield",(()=>{const e=new h(!1,r,0,2);a(e.value).to.equal(0)}))}))})),e("Negative modifier",(()=>{e("When ascending",(()=>{const e=h.baseAscending;t("Unarmored, no shield",(()=>{const t=new h(!0,[],0,c);a(t.value).to.equal(e+c)})),t("Armored, no shield",(()=>{const e=new h(!0,i,0,c);a(e.value).to.equal(0)})),t("Unarmored, shield",(()=>{const t=new h(!0,o,0,c);a(t.value).to.equal(e+2+c)})),t("Armored, shield",(()=>{const e=new h(!0,r,0,c);a(e.value).to.equal(2)}))})),e("When descending",(()=>{const e=h.baseDescending;t("Unarmored, no shield",(()=>{const t=new h(!1,[],0,c);a(t.value).to.equal(e-c)})),t("Armored, no shield",(()=>{const e=new h(!1,i,0,c);a(e.value).to.equal(8)})),t("Unarmored, shield",(()=>{const t=new h(!1,o,0,c);a(t.value).to.equal(e-2-c)})),t("Armored, shield",(()=>{const e=new h(!1,r,0,c);a(e.value).to.equal(6)}))}))}))}))};const $e={displayName:"OSE: Actor: Data Model: Character Encumbrance"},ze=(e,t)=>Math.clamp(100*e/t,0,100),Le=(e,t,a,s={})=>new Item.implementation({name:`Mock ${e} ${foundry.utils.randomID()}`,type:e,system:{...s,weight:t,quantity:{value:a}}});var Pe=({describe:o,it:r,expect:l})=>{o("Disabled Encumbrance",(()=>{r("Is disabled",(()=>{let t=new e;l(t.enabled).to.be.false,t=new n,l(t.enabled).to.be.false}))})),o("Basic Encumbrance",(()=>{r("Is enabled",(()=>{const e=new t;l(e.enabled).to.be.true})),r("Returns the appropriate encumbrance steps",(()=>{const e=new t,a=[100*game.settings.get(game.system.id,"significantTreasure")/e.max];l(e.steps).to.have.members(a)})),o("Returns current carried weight",(()=>{r("As Percentage",(()=>{const e=1600;let a=new t(e,[Le("item",400,1,{treasure:!0})]);l(a.pct).to.equal(ze(400,e)),a=new t(e,[Le("item",800,1,{treasure:!0})]),l(a.pct).to.equal(ze(800,e)),a=new t(e,[Le("item",1200,1,{treasure:!0})]),l(a.pct).to.equal(ze(1200,e)),a=new t(e,[Le("item",e,1,{treasure:!0})]),l(a.pct).to.equal(100),a=new t(e,[Le("item",e,1,{treasure:!1})]),l(a.pct).to.equal(0)})),r("As Value",(()=>{const e=1600;let a=new t(e,[Le("item",400,1,{treasure:!0})]);l(a.value).to.equal(400),a=new t(e,[Le("item",800,1,{treasure:!0})]),l(a.value).to.equal(800),a=new t(e,[Le("item",1200,1,{treasure:!0})]),l(a.value).to.equal(1200),a=new t(e,[Le("item",e,1,{treasure:!0})]),l(a.value).to.equal(e),a=new t(e,[Le("item",e,1,{treasure:!1})]),l(a.value).to.equal(0)})),o("As fully encumbered flag",(()=>{r("Encumbered over full load (1600.1)",(()=>{const e=new t(1600,[Le("item",1600.1,1,{treasure:!0})]);l(e.encumbered).to.be.true})),o("Not encumbered",(()=>{r("from non-treasure items",(()=>{const e=new t(1600,[Le("weapon",1600.1,1),Le("armor",1600.1,1),Le("container",1600.1,1),Le("item",1600.1,1)]);l(e.encumbered).to.be.false})),r("from a partial load",(()=>{const e=new t(1600,[Le("item",400,1,{treasure:!0})]);l(e.encumbered).to.be.false}))}))})),r('As "over significant treasure threshold" flag',(()=>{let e=new t(1600,[Le("item",400,1,{treasure:!0})]);l(e.overSignificantTreasureThreshold).to.be.false,e=new t(1600,[Le("item",800,1,{treasure:!0})]),l(e.overSignificantTreasureThreshold).to.be.true,e=new t(1600,[Le("weapon",800,1)]),l(e.overSignificantTreasureThreshold).to.be.false}))})),r("Returns max carry weight",(()=>{let a=new t(2e3);l(a.max).to.equal(2e3),a=new t,l(a.max).to.equal(e.baseEncumbranceCap)}))})),o("Detailed Encumbrance",(()=>{r("Is enabled",(()=>{const e=new s;l(e.enabled).to.be.true})),r("Returns the appropriate encumbrance steps",(()=>{const t=new s;l(t.steps).to.have.members(Object.values(e.encumbranceSteps))})),o("Returns current carried weight",(()=>{r("As Percentage",(()=>{const e=1600;let t=new s(e,[Le("item",400,1,{treasure:!0})]);l(t.pct).to.equal(ze(400,e)),t=new s(e,[Le("item",800,1,{treasure:!0})]),l(t.pct).to.equal(ze(800,e)),t=new s(e,[Le("item",1200,1,{treasure:!0})]),l(t.pct).to.equal(ze(1200,e)),t=new s(e,[Le("item",e,1,{treasure:!0})]),l(t.pct).to.equal(100),t=new s(e,[Le("item",e,1,{treasure:!1})]),l(t.pct).to.equal(ze(s.gearWeight,e))})),r("As Value",(()=>{const e=1600;let t=new s(e,[Le("item",400,1,{treasure:!0})]);l(t.value).to.equal(400),t=new s(e,[Le("item",800,1,{treasure:!0})]),l(t.value).to.equal(800),t=new s(e,[Le("item",1200,1,{treasure:!0})]),l(t.value).to.equal(1200),t=new s(e,[Le("item",e,1,{treasure:!0})]),l(t.value).to.equal(e),t=new s(e,[Le("item",e,1,{treasure:!1})]),l(t.value).to.equal(s.gearWeight)})),o("As fully encumbered flag",(()=>{r("Encumbered over full load (1600.1)",(()=>{const e=new s(1600,[Le("item",1600.1,1,{treasure:!0})]);l(e.encumbered).to.be.true})),o("Not encumbered",(()=>{r("from non-treasure items",(()=>{const e=new s(1600,[Le("item",1600.1,1)]);l(e.encumbered).to.be.false,l(e.value).to.equal(80)})),r("from a partial load",(()=>{const e=new s(1600,[Le("item",400,1,{treasure:!0})]);l(e.encumbered).to.be.false}))}))}))})),r("Returns max carry weight",(()=>{let t=new s(2e3);l(t.max).to.equal(2e3),t=new s,l(t.max).to.equal(e.baseEncumbranceCap)}))})),o("Complete Encumbrance",(()=>{r("Is enabled",(()=>{const e=new a;l(e.enabled).to.be.true})),r("Returns the appropriate encumbrance steps",(()=>{const t=new a;l(t.steps).to.have.members(Object.values(e.encumbranceSteps))})),o("Returns current carried weight",(()=>{r("As Percentage",(()=>{const e=1600;let t=new a(e,[Le("item",400,1,{treasure:!0})]);l(t.pct).to.equal(ze(400,e)),t=new a(e,[Le("item",800,1,{treasure:!0})]),l(t.pct).to.equal(ze(800,e)),t=new a(e,[Le("item",1200,1,{treasure:!0})]),l(t.pct).to.equal(ze(1200,e)),t=new a(e,[Le("item",e,1,{treasure:!0})]),l(t.pct).to.equal(100),t=new a(e,[Le("item",e,1,{treasure:!1})]),l(t.pct).to.equal(100)})),r("As Value",(()=>{const e=1600;let t=new a(e,[Le("item",400,1,{treasure:!0})]);l(t.value).to.equal(400),t=new a(e,[Le("item",800,1,{treasure:!0})]),l(t.value).to.equal(800),t=new a(e,[Le("item",1200,1,{treasure:!0})]),l(t.value).to.equal(1200),t=new a(e,[Le("item",e,1,{treasure:!0})]),l(t.value).to.equal(e),t=new a(e,[Le("item",e,1,{treasure:!1})]),l(t.value).to.equal(e)})),o("As fully encumbered flag",(()=>{r("Encumbered over full load (1600.1)",(()=>{let e=new a(1600,[Le("item",1600.1,1,{treasure:!0})]);l(e.encumbered).to.be.true,e=new a(1600,[Le("item",1600.1,1,{treasure:!1})]),l(e.encumbered).to.be.true})),o("Not encumbered",(()=>{r("from a partial load",(()=>{const e=new a(1600,[Le("item",400,1,{treasure:!0})]);l(e.encumbered).to.be.false})),r("from a full load",(()=>{let e=new a(1600,[Le("item",1600,1,{treasure:!0})]);l(e.encumbered).to.be.false,e=new a(1600,[Le("item",1600,1,{treasure:!1})]),console.info(e),l(e.encumbered).to.be.false}))}))}))})),r("Returns max carry weight",(()=>{let t=new a(2e3);l(t.max).to.equal(2e3),t=new a,l(t.max).to.equal(e.baseEncumbranceCap)}))})),o("Item-based Encumbrance",(()=>{r("Is enabled",(()=>{const e=new i(0);l(e.enabled).to.be.true})),r("Returns the appropriate encumbrance steps",(()=>{const e=new i(0);l(e.steps).to.have.members(Object.values(i.equippedEncumbranceSteps))})),o("Returns current carried weight",(()=>{r("Equipped Slots",(()=>{const e=[{quantity:1,atFirstBreakpoint:!1,atSecondBreakpoint:!1,atThirdBreakpoint:!1,encumbered:!1},{quantity:2,atFirstBreakpoint:!1,atSecondBreakpoint:!1,atThirdBreakpoint:!1,encumbered:!1},{quantity:3,atFirstBreakpoint:!1,atSecondBreakpoint:!1,atThirdBreakpoint:!1,encumbered:!1},{quantity:4,atFirstBreakpoint:!0,atSecondBreakpoint:!1,atThirdBreakpoint:!1,encumbered:!1},{quantity:5,atFirstBreakpoint:!0,atSecondBreakpoint:!1,atThirdBreakpoint:!1,encumbered:!1},{quantity:6,atFirstBreakpoint:!0,atSecondBreakpoint:!0,atThirdBreakpoint:!1,encumbered:!1},{quantity:7,atFirstBreakpoint:!0,atSecondBreakpoint:!0,atThirdBreakpoint:!1,encumbered:!1},{quantity:8,atFirstBreakpoint:!0,atSecondBreakpoint:!0,atThirdBreakpoint:!0,encumbered:!1},{quantity:9,atFirstBreakpoint:!0,atSecondBreakpoint:!0,atThirdBreakpoint:!0,encumbered:!1},{quantity:10,atFirstBreakpoint:!0,atSecondBreakpoint:!0,atThirdBreakpoint:!0,encumbered:!0}];for(const t of e){const e=new i(0,[Le("item",0,t.quantity,{itemslots:1,equipped:!0})]);l(e.value,`equipped value (${t.quantity})`).to.equal(t.quantity),l(e.atFirstBreakpoint,"atFirstBreakpoint").to.equal(t.atFirstBreakpoint),l(e.atSecondBreakpoint,"atSecondBreakpoint").to.equal(t.atSecondBreakpoint),l(e.atThirdBreakpoint,"atThirdBreakpoint").to.equal(t.atThirdBreakpoint),l(e.encumbered,"encumbered flag").to.equal(t.encumbered)}})),r("Packed Slots",(()=>{const e=[{quantity:1,atFirstBreakpoint:!1,atSecondBreakpoint:!1,atThirdBreakpoint:!1,encumbered:!1},{quantity:2,atFirstBreakpoint:!1,atSecondBreakpoint:!1,atThirdBreakpoint:!1,encumbered:!1},{quantity:9,atFirstBreakpoint:!1,atSecondBreakpoint:!1,atThirdBreakpoint:!1,encumbered:!1},{quantity:10,atFirstBreakpoint:!1,atSecondBreakpoint:!1,atThirdBreakpoint:!1,encumbered:!1},{quantity:11,atFirstBreakpoint:!0,atSecondBreakpoint:!1,atThirdBreakpoint:!1,encumbered:!1},{quantity:12,atFirstBreakpoint:!0,atSecondBreakpoint:!1,atThirdBreakpoint:!1,encumbered:!1},{quantity:13,atFirstBreakpoint:!0,atSecondBreakpoint:!0,atThirdBreakpoint:!1,encumbered:!1},{quantity:14,atFirstBreakpoint:!0,atSecondBreakpoint:!0,atThirdBreakpoint:!1,encumbered:!1},{quantity:15,atFirstBreakpoint:!0,atSecondBreakpoint:!0,atThirdBreakpoint:!0,encumbered:!1},{quantity:16,atFirstBreakpoint:!0,atSecondBreakpoint:!0,atThirdBreakpoint:!0,encumbered:!1},{quantity:17,atFirstBreakpoint:!0,atSecondBreakpoint:!0,atThirdBreakpoint:!0,encumbered:!0}];for(const t of e){const e=new i(0,[Le("item",0,t.quantity,{itemslots:1})]);l(e.packedValue,`packed value (${t.quantity})`).to.equal(t.quantity),l(e.atFirstBreakpoint,"atFirstBreakpoint").to.equal(t.atFirstBreakpoint),l(e.atSecondBreakpoint,"atSecondBreakpoint").to.equal(t.atSecondBreakpoint),l(e.atThirdBreakpoint,"atThirdBreakpoint").to.equal(t.atThirdBreakpoint),l(e.encumbered,"encumbered flag").to.equal(t.encumbered)}})),r("Coins and Gems",(()=>{const e=[{quantity:1,value:1},{quantity:50,value:1},{quantity:100,value:1},{quantity:101,value:2}];for(const t of e){const e=new i(0,[Le("item",0,t.quantity,{treasure:!0,tags:[{value:"gems"}]})]);l(e.packedValue,`packed value (${t.quantity})`).to.equal(t.value),l(e.encumbered,"encumbered flag").to.be.false}}))})),r("Returns max carry weight",(()=>{const e=new i(0);l(e.max).to.equal(9)}))}))};const Be={displayName:"OSE: Actor: Data Model: Character Movement"},je=(e,t,a,s={})=>new Item.implementation({name:`Mock ${e} ${foundry.utils.randomID()}`,type:e,system:{...s,weight:t,quantity:{value:a}}});var He=({describe:n,it:i,expect:o})=>{n("Prevent autocalculation when...",(()=>{i("Autocalculation is off",(()=>{const e=new t,a=new y(e,!1);o(a.base).to.equal(y.baseMoveRate)})),i("Encumbrance is disabled",(()=>{const t=new e("disabled"),a=new y(t);o(a.base).to.equal(y.baseMoveRate)})),i("Encumbrance is not provided",(()=>{const e=new y;o(e.base).to.equal(y.baseMoveRate)}))})),n("Correctly calculates from Basic Encumbrance",(()=>{i("While unarmored",(()=>{let e=new t,a=new y(e);o(a.base).to.equal(y.baseMoveRate),e=new t(void 0,[je("armor",100,1,{type:"unarmored",equipped:!0}),je("armor",100,1,{type:"light",equipped:!1}),je("armor",100,1,{type:"heavy",equipped:!1})]),a=new y(e),o(a.base).to.equal(y.baseMoveRate),o(a.encounter).to.equal(y.baseMoveRate/3),o(a.overland).to.equal(y.baseMoveRate/5)})),i("While lightly armored",(()=>{const e=new t(void 0,[je("armor",100,1,{type:"unarmored",equipped:!1}),je("armor",100,1,{type:"light",equipped:!0}),je("armor",100,1,{type:"heavy",equipped:!1})]),a=new y(e);o(a.base).to.equal(.75*y.baseMoveRate),o(a.encounter).to.equal(.75*y.baseMoveRate/3),o(a.overland).to.equal(.75*y.baseMoveRate/5)})),i("While heavily armored",(()=>{const e=new t(void 0,[je("armor",100,1,{type:"unarmored",equipped:!1}),je("armor",100,1,{type:"light",equipped:!1}),je("armor",100,1,{type:"heavy",equipped:!0})]),a=new y(e);o(a.base).to.equal(.5*y.baseMoveRate),o(a.encounter).to.equal(.5*y.baseMoveRate/3),o(a.overland).to.equal(.5*y.baseMoveRate/5)})),i("While carrying a significant amount of treasure",(()=>{let e=new t(void 0,[je("item",t.significantTreasure-1,1,{treasure:!0})]),a=new y(e);o(a.base).to.equal(y.baseMoveRate),o(a.encounter).to.equal(y.baseMoveRate/3),o(a.overland).to.equal(y.baseMoveRate/5),e=new t(void 0,[je("item",t.significantTreasure,1,{treasure:!0})]),a=new y(e),o(a.base).to.equal(y.baseMoveRate-30),o(a.encounter).to.equal((y.baseMoveRate-30)/3),o(a.overland).to.equal((y.baseMoveRate-30)/5)}))})),n("Correctly calculates from Detailed Encumbrance",(()=>{i("At unencumbered",(()=>{const e=y.baseMoveRate,t=e/3,a=e/5;let n=new s,i=new y(n);o(i.base).to.equal(e),o(i.encounter).to.equal(t),o(i.overland).to.equal(a),n=new s(void 0,[je("item",800,1)]),i=new y(n),o(i.base).to.equal(e),o(i.encounter).to.equal(t),o(i.overland).to.equal(a)})),i("At 12.5% encumbered (100% moverate)",(()=>{const t=y.baseMoveRate,a=t/3,n=t/5,i=new s(void 0,[je("item",.125*e.baseEncumbranceCap,1,{treasure:!0})]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(a),o(r.overland).to.equal(n)})),i("At 25% encumbered (100% moverate)",(()=>{const t=y.baseMoveRate,a=t/3,n=t/5,i=new s(void 0,[je("item",.25*e.baseEncumbranceCap,1,{treasure:!0})]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(a),o(r.overland).to.equal(n)})),i("At 25.1% encumbered (75% moverate)",(()=>{const t=.75*y.baseMoveRate,a=t/3,n=t/5;let i=new s(void 0,[je("item",.251*e.baseEncumbranceCap,1,{treasure:!0})]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(a),o(r.overland).to.equal(n)})),i("At 37.5% encumbered (75% moverate)",(()=>{const t=.75*y.baseMoveRate,a=t/3,n=t/5;let i=new s(void 0,[je("item",.375*e.baseEncumbranceCap,1,{treasure:!0})]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(a),o(r.overland).to.equal(n)})),i("At 37.51% encumbered (50% moverate)",(()=>{const t=.5*y.baseMoveRate,a=t/3,n=t/5;let i=new s(void 0,[je("item",.3751*e.baseEncumbranceCap,1,{treasure:!0})]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(a),o(r.overland).to.equal(n)})),i("At 50% encumbered (50% moverate)",(()=>{const t=.5*y.baseMoveRate,a=t/3,n=t/5;let i=new s(void 0,[je("item",.5*e.baseEncumbranceCap,1,{treasure:!0})]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(a),o(r.overland).to.equal(n)})),i("At 50.1% encumbered (25% moverate)",(()=>{const t=.25*y.baseMoveRate,a=t/3,n=t/5;let i=new s(void 0,[je("item",.501*e.baseEncumbranceCap,1,{treasure:!0})]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(a),o(r.overland).to.equal(n)})),i("At 100% encumbered (25% moverate)",(()=>{const t=.25*y.baseMoveRate,a=t/3,n=t/5;let i=new s(void 0,[je("item",e.baseEncumbranceCap,1,{treasure:!0})]);const r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(a),o(r.overland).to.equal(n)})),i("At 100.1% encumbered (0% moverate)",(()=>{let t=new s(void 0,[je("item",e.baseEncumbranceCap,1.001,{treasure:!0})]),a=new y(t);o(a.base).to.equal(0),o(a.encounter).to.equal(0),o(a.overland).to.equal(0)}))})),n("Correctly calculates from Complete Encumbrance",(()=>{i("At 0% encumbered (100% moverate)",(()=>{const e=y.baseMoveRate,t=e/3,s=e/5,n=new a,i=new y(n);o(i.base).to.equal(e),o(i.encounter).to.equal(t),o(i.overland).to.equal(s)})),i("At 12.5% encumbered (100% moverate)",(()=>{const t=y.baseMoveRate,s=t/3,n=t/5;let i=new a(void 0,[je("item",.125*e.baseEncumbranceCap,1)]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(s),o(r.overland).to.equal(n)})),i("At 25% encumbered (100% moverate)",(()=>{const t=y.baseMoveRate,s=t/3,n=t/5;let i=new a(void 0,[je("item",.25*e.baseEncumbranceCap,1)]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(s),o(r.overland).to.equal(n)})),i("At 25.1% encumbered (75% moverate)",(()=>{const t=.75*y.baseMoveRate,s=t/3,n=t/5;let i=new a(void 0,[je("item",.251*e.baseEncumbranceCap,1)]);const r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(s),o(r.overland).to.equal(n)})),i("At 37.5% encumbered (75% moverate)",(()=>{const t=.75*y.baseMoveRate,s=t/3,n=t/5;let i=new a(void 0,[je("item",.375*e.baseEncumbranceCap,1)]);const r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(s),o(r.overland).to.equal(n)})),i("At 37.51% encumbered (50% moverate)",(()=>{const t=.5*y.baseMoveRate,s=t/3,n=t/5;let i=new a(void 0,[je("item",.3751*e.baseEncumbranceCap,1)]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(s),o(r.overland).to.equal(n)})),i("At 50% encumbered (50% moverate)",(()=>{const t=.5*y.baseMoveRate,s=t/3,n=t/5;let i=new a(void 0,[je("item",.5*e.baseEncumbranceCap,1)]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(s),o(r.overland).to.equal(n)})),i("At 50.1% encumbered (25% moverate)",(()=>{const t=.25*y.baseMoveRate,s=t/3,n=t/5;let i=new a(void 0,[je("item",.501*e.baseEncumbranceCap,1)]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(s),o(r.overland).to.equal(n)})),i("At 100% encumbered (25% moverate)",(()=>{const t=.25*y.baseMoveRate,s=t/3,n=t/5;let i=new a(void 0,[je("item",e.baseEncumbranceCap,1)]),r=new y(i);o(r.base).to.equal(t),o(r.encounter).to.equal(s),o(r.overland).to.equal(n)})),i("At 100.1% encumbered (0% moverate)",(()=>{let t=new a(void 0,[je("item",e.baseEncumbranceCap,1.001)]);const s=new y(t);o(s.base).to.equal(0),o(s.encounter).to.equal(0),o(s.overland).to.equal(0)}))}))};const Ge={displayName:"OSE: Actor: Data Model: Character Ability Scores"};var We=({describe:e,it:t,expect:a})=>{const s=Array.from({length:21},((e,t)=>t)),n=["str","int","wis","dex","con","cha"],i=[w.standardAttributeMods,w.cappedAttributeMods,w.openDoorMods,w.literacyMods,w.spokenMods],o=(e,t)=>w.valueFromTable(i[e],t),r=e=>Object.fromEntries(n.map((t=>[t,{value:e,bonus:0}]))),l=(e,s,n,i)=>{const l=r(e),c=new w(l);return t(`${e}`,(()=>{a(c[s][n]).to.equal(o(i,e))}))},c=(e,s,n,i,l)=>{const c=r(e),u=new w(c);return t(`${e}`,(()=>{a(u[s][n]).to.equal(o(i,e)+l)}))};e("Standard attribute modifiers",(()=>{return t="Attribute",n.map((a=>e(`${t}: ${a}`,(()=>s.map((e=>l(e,a,"mod",0)))))));var t})),e("Strength modifiers",(()=>{e("Open Doors",(()=>s.map((e=>l(e,"str","od",2)))))})),e("Intelligence modifiers",(()=>{e("Literacy",(()=>s.map((e=>l(e,"int","literacy",3))))),e("Spoken Languages",(()=>s.map((e=>l(e,"int","spoken",4)))))})),e("Dexterity modifiers",(()=>{e("Initiative",(()=>s.map((e=>l(e,"dex","init",1)))))})),e("Charisma modifiers",(()=>{e("NPC Reaction",(()=>s.map((e=>l(e,"cha","npc",1))))),e("Loyalty",(()=>s.map((e=>c(e,"cha","retain",0,4))))),e("Number of Retainers",(()=>s.map((e=>c(e,"cha","loyalty",0,7)))))}))};const Ue={displayName:"OSE: Actor: Data Model: Character Spells"},Ke=(e,t)=>new Item.implementation({name:`Mock Spell ${foundry.utils.randomID()}`,type:"spell",system:{...t,lvl:e}}),Ve=[1,2,3,4,5,6,7,8,9];var Ye=({describe:e,it:t,expect:a})=>{e("Spell levels",(()=>{t("Sorts the incoming spell list into an object with spell level keys",(()=>{const e=((e,...t)=>t.reduce(((t,a,s)=>[...t,...Array.from({length:a},(()=>Ke(s+1,e)))]),[]))({},...Ve),t=new b({},e);Ve.forEach((e=>{a(t.spellList[e].length).to.equal(e)}))}))})),e("Spell slots",(()=>{e("Shows committed and max spell slots per level",(()=>{t("with no spells prepared",(()=>{const e=[Ke(1)],t=new b({1:{max:1}},e);a(t.slots[1].used).to.equal(0),a(t.slots[1].max).to.equal(1)})),t("with spells prepared, not cast",(()=>{const e=[Ke(1,{memorized:1,cast:1})],t=new b({1:{max:1}},e);a(t.slots[1].used).to.equal(1),a(t.slots[1].max).to.equal(1)})),t("with spells prepared and cast",(()=>{const e=[Ke(1,{memorized:1,cast:0})],t=new b({1:{max:1}},e);a(t.slots[1].used).to.equal(0),a(t.slots[1].max).to.equal(1)}))}))})),e("Checking for spellcasting",(()=>{t("Can cast spells when spellcasting is enabled",(()=>{const e=new b({enabled:!0},[]);a(e.enabled).to.be.true})),t("Cannot cast spells when spellcasting is disabled",(()=>{const e=new b({enabled:!1},[]);a(e.enabled).to.be.false})),t("Can toggle between being able and unable to cast spells",(()=>{const e=new b({enabled:!0},[]);a(e.enabled).to.be.true,e.enabled=!1,a(e.enabled).to.be.false}))}))};const Xe="ose.actor.datamodel.monster",Qe={displayName:"OSE: Actor: Data Model: Monster"},Je=()=>be("monster",{},Xe);var Ze=({describe:e,it:t,expect:a,after:s,afterEach:n,before:i})=>{const o=new S,r=game.settings.get(game.system.id,"ascendingAC"),l=game.settings.get(game.system.id,"initiative");s((()=>{game.settings.set(game.system.id,"ascendingAC",r),game.settings.set(game.system.id,"initiative",l),Ie(Xe)})),e("prepareDerivedData()",(()=>{n((()=>{Ie(Xe)})),t("doesnt have scores",(async()=>{const e=await Je();a(e?.system.scores).is.undefined})),t("has encumbrance",(async()=>{const e=await Je();a(e?.system.encumbrance).not.undefined,a(e?.system.encumbrance.variant).not.undefined,a(e?.system.encumbrance.enabled).not.undefined,a(e?.system.encumbrance.pct).not.undefined,a(e?.system.encumbrance.encumbered).not.undefined,a(e?.system.encumbrance.steps).not.undefined,a(e?.system.encumbrance.value).not.undefined,a(e?.system.encumbrance.max).not.undefined,a(e?.system.encumbrance.atFirstBreakpoint).not.undefined,a(e?.system.encumbrance.atSecondBreakpoint).not.undefined,a(e?.system.encumbrance.atThirdBreakpoint).not.undefined})),t("have movement",(async()=>{const e=await Je();a(e?.system.movement).not.undefined,a(e?.system.movement.base).not.undefined})),t("have ac",(async()=>{const e=await Je();a(e?.system.ac).not.undefined,a(e?.system.ac.value).not.undefined,a(e?.system.ac.mod).not.undefined})),t("have aac",(async()=>{const e=await Je();a(e?.system.aac).not.undefined,a(e?.system.aac.value).not.undefined,a(e?.system.aac.mod).not.undefined})),e("has spells",(()=>{const e=new Set(["1","2","3","4","5","6"]);t("has spells",(async()=>{const e=await Je();a(e?.system.spells).not.undefined,a(e?.system.spells.enabled).not.undefined,a(e?.system.spells.spellList).not.undefined,a(e?.system.spells.slots).not.undefined})),e.forEach((e=>{t(`has spell level ${e}`,(async()=>{const t=await Je();a(t?.system.spells.slots[e]).not.undefined,a(Object.keys(t?.system.spells.slots[e])).contain("used"),a(Object.keys(t?.system.spells.slots[e])).contain("max")}))}))}))})),e("defineSchema()",(()=>{i((async()=>{await Je()}));["config","initiative","thac0","languages"].forEach((e=>{t(`has ${e}`,(async()=>{const t=await Oe(Xe);a(t?.system[e]).not.undefined}))}));[{field:"hp",subFields:["hd","value","max"]},{field:"retainer",subFields:["enabled","loyalty","wage"]}].forEach((({field:e,subFields:s})=>{s.forEach((s=>{t(`${e} field has ${s} subfield`,(async()=>{const t=await Oe(Xe);a(t?.system[e]).not.undefined,a(t?.system[e][s]).not.undefined}))}))}));[{field:"saves",subFields:[{subField:"breath",subSubField:["value"]},{subField:"death",subSubField:["value"]},{subField:"paralysis",subSubField:["value"]},{subField:"spell",subSubField:["value"]},{subField:"wand",subSubField:["value"]}]}].forEach((({field:e,subFields:s})=>{s.forEach((({subField:s,subSubField:n})=>{t(`${e} field has ${s} subfield, which has ${n} field`,(async()=>{const t=await Oe(Xe);a(t?.system[e]).not.undefined,a(t?.system[e][s]).not.undefined,a(t?.system[e][s][n]).not.undefined}))}))})),s((()=>{Ie(Xe)}))})),e("isNew()",(()=>{t("New when all saves are at 0",(async()=>{const e=await be("monster",{system:{saves:{breath:{value:0},death:{value:0},paralysis:{value:0},spell:{value:0},wand:{value:0}}}},Xe);a(e?.system.isNew).to.be.true})),t("Not new when any save is above 0",(async()=>{const e=await be("monster",{system:{saves:{breath:{value:10},death:{value:0},paralysis:{value:0},spell:{value:0},wand:{value:0}}}},Xe);a(e?.system.isNew).to.be.false}))})),e("containers()",(()=>{t("returns all containers",(async()=>{const e=await Je();a(e?.items.contents.length).equal(0),a(e?.system.containers.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}])),a(e?.items.contents.length).equal(1);const t=e?.items.getName("test container");a(t).to.not.be.undefined,a(t?.name).equal("test container"),a(e?.items.contents[0].name).equal("test container"),a(e?.system.containers[0]._id).equal(t.id),e?.delete()})),s((()=>{Ie(Xe)}))})),e("treasures()",(()=>{t("returns treasures on actor",(async()=>{const e=await Je();a(e?.items.contents.length).equal(0),a(e?.system.treasures.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0}}])),a(e?.items.contents.length).equal(1);const t=e?.items.getName("test treasure");a(t).to.not.be.undefined,a(t?.name).equal("test treasure"),a(t?.system.treasure).is.true,a(e?.system.treasures.length).equal(1),a(e?.system.treasures[0]._id).equal(t.id),e?.delete()})),t("doesn't return treasures on actor if in container",(async()=>{const e=await Je();a(e?.items.contents.length).equal(0),a(e?.system.treasures.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]));const t=e?.items.getName("test container");await(e?.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0,containerId:t?.id}}])),a(e?.items.contents.length).equal(2);const s=e?.items.getName("test container"),n=e?.items.getName("test treasure");a(s).to.not.be.undefined,a(s?.name).equal("test container"),a(n).to.not.be.undefined,a(n?.name).equal("test treasure"),a(n?.system.treasure).is.true,a(n?.system.containerId).equal(t?.id),a(e?.system.treasures.length).equal(0),e?.delete()})),s((()=>{Ie(Xe)}))})),e("items()",(()=>{t("only returns items other than treasure",(async()=>{const e=await Je();a(e?.items.contents.length).equal(0),a(e?.system.items.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"item",name:"test item"},{type:"item",name:"test treasure",system:{treasure:!0,quantity:{value:3},cost:4}}])),a(e?.items.contents.length).equal(2);const t=e?.items.getName("test item"),s=e?.items.getName("test treasure");a(t).to.not.be.undefined,a(t?.name).equal("test item"),a(t?.system.treasure).is.false,a(s).to.not.be.undefined,a(s?.name).equal("test treasure"),a(s?.system.treasure).is.true,a(e?.system.items.length).equal(1),a(e?.system.items[0].name).equal("test item"),e?.delete()})),t("only returns other items than stored in containers",(async()=>{const e=await Je();a(e?.items.contents.length).equal(0),a(e?.system.items.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]));const t=e?.items.getName("test container");await(e?.createEmbeddedDocuments("Item",[{type:"item",name:"test item in container",system:{containerId:t?.id}},{type:"item",name:"test item"}])),a(e?.items.contents.length).equal(3);const s=e?.items.getName("test container"),n=e?.items.getName("test item in container"),i=e?.items.getName("test item");a(s).to.not.be.undefined,a(s?.name).equal("test container"),a(n).to.not.be.undefined,a(n?.name).equal("test item in container"),a(i).to.not.be.undefined,a(i?.name).equal("test item"),a(e?.system.items.length).equal(1),a(e?.system.items[0].name).equal("test item"),e?.delete()}))}));[{type:"weapon",getter:"weapons"},{type:"ability",getter:"abilities"},{type:"armor",getter:"armor"}].forEach((({type:n,getter:i})=>{e(`${i}()`,(()=>{t(`returns all ${i}`,(async()=>{const e=await Je();a(e?.items.contents.length).equal(0),a(e?.system[i].length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:n,name:`test ${n}`}])),a(e?.items.contents.length).equal(1);const t=e?.items.getName(`test ${n}`);a(t).to.not.be.undefined,a(t?.name).equal(`test ${n}`),a(e?.system[i].length).equal(1),a(e?.system[i][0]._id).equal(t.id),e?.delete()})),t(`returns all ${i} except ones in container`,(async()=>{if("abilities"===i)return;const e=await Je();a(e?.items.contents.length).equal(0),a(e?.system[i].length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]));const t=e?.items.getName("test container");await(e?.createEmbeddedDocuments("Item",[{type:n,name:`test ${n} in container`,system:{containerId:t?.id}},{type:n,name:`test ${n}`}])),a(e?.items.contents.length).equal(3);const s=e?.items.getName("test container"),o=e?.items.getName(`test ${n} in container`),r=e?.items.getName(`test ${n}`);a(s).to.not.be.undefined,a(s?.name).equal("test container"),a(o).to.not.be.undefined,a(o?.name).equal(`test ${n} in container`),a(r).to.not.be.undefined,a(r?.name).equal(`test ${n}`),a(e?.system[i].length).equal(1),a(e?.system[i][0]._id).equal(r.id),e?.delete()}))})),s((()=>{Ie(Xe)}))})),e("attackPatterns()",(()=>{t("returns all weapons and abilities in transparent when no pattern set",(async()=>{const e=await Je();await(e?.createEmbeddedDocuments("Item",[{type:"ability",name:"test ability"},{type:"weapon",name:"test weapon"}])),a(Object.keys(e?.system.attackPatterns).length).equal(1),a(Object.keys(e?.system.attackPatterns)).contain("transparent"),a(e?.system.attackPatterns.transparent.length).equal(2),a(e?.system.attackPatterns.transparent[0].name).equal("test weapon"),a(e?.system.attackPatterns.transparent[1].name).equal("test ability")})),t("returns separated weapons and abilities whith patterns patterns",(async()=>{const e=await Je();await(e?.createEmbeddedDocuments("Item",[{type:"ability",name:"test ability green",system:{pattern:"green"}},{type:"weapon",name:"test weapon green",system:{pattern:"green"}},{type:"ability",name:"test ability"},{type:"weapon",name:"test weapon"}])),a(Object.keys(e?.system.attackPatterns).length).equal(2),a(Object.keys(e?.system.attackPatterns)).contain("transparent"),a(Object.keys(e?.system.attackPatterns)).contain("green"),a(e?.system.attackPatterns.transparent.length).equal(2),a(e?.system.attackPatterns.transparent[0].name).equal("test ability"),a(e?.system.attackPatterns.transparent[1].name).equal("test weapon"),a(e?.system.attackPatterns.green.length).equal(2),a(e?.system.attackPatterns.green[0].name).equal("test weapon green"),a(e?.system.attackPatterns.green[1].name).equal("test ability green")}))})),e("isSlow()",(()=>{t("returns false if no weapons",(async()=>{const e=await Je();a(e?.system.isSlow).is.false,e?.delete()})),t("returns false if weapon that doesn't have slow tag",(async()=>{const e=await Je();a(e?.items.contents.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"weapon",name:"test weapon",system:{slow:!1}}])),a(e?.items.contents.length).equal(1),a(e?.items.contents[0].name).equal("test weapon"),a(e?.system.isSlow).is.false,e?.delete()})),t("returns true if weapon that has slow tag",(async()=>{const e=await Je();a(e?.items.contents.length).equal(0),await(e?.createEmbeddedDocuments("Item",[{type:"weapon",name:"test weapon",system:{slow:!0}}])),a(e?.items.contents.length).equal(1),a(e?.items.contents[0].name).equal("test weapon"),a(e?.system.isSlow).is.true,e?.delete()})),s((()=>{Ie(Xe)}))})),e("init()",(()=>{i((async()=>{await game.settings.set(game.system.id,"initiative","individual")})),t("returns 0 by default",(()=>{a(o.initiative.value).equal(0),a(o.initiative.mod).equal(0),a(o.init).equal(0)})),t("returns correctly with initiative value set",(async()=>{o.initiative.value=12,a(o.init).equal(12),o.initiative.value=0,a(o.init).equal(0),a(o.initiative.value).equal(0)})),t("returns correctly with initiative mod set",(async()=>{o.initiative.mod=10,a(o.init).equal(10),o.initiative.mod=0,a(o.init).equal(0),a(o.initiative.mod).equal(0)})),t("returns correctly with initiative value and mod set",(async()=>{o.initiative.value=12,o.initiative.mod=3,a(o.init).equal(15),o.initiative.value=0,o.initiative.mod=0,a(o.init).equal(0),a(o.initiative.value).equal(0),a(o.initiative.mod).equal(0)}))}))};const et="ose.actor.entity",tt={displayName:"OSE: Actor: Entity",preSelected:!0},at=async e=>E.create({name:`Test Actor ${et}`,type:e});var st=({describe:e,it:t,expect:a,after:s,afterEach:n,before:i,assert:o})=>{n((async()=>{await re(),Ie(et),Ce()})),e("update(data, options)",(()=>{t("AAC to AC",(async()=>{const e=await at("character");a(e?.system.ac.value).equal(12),a(e?.system.aac.value).equal(7),await(e?.update({"system.ac.mod":1})),a(e?.system.ac.value).equal(11),a(e?.system.aac.value).equal(8),await(e?.update({"system.ac.mod":2})),a(e?.system.ac.value).equal(10),a(e?.system.aac.value).equal(9),await(e?.update({"system.ac.mod":-1})),a(e?.system.ac.value).equal(13),a(e?.system.aac.value).equal(6)})),t("AC to AAC",(async()=>{const e=await at("character");a(e?.system.ac.value).equal(12),a(e?.system.aac.value).equal(7),await(e?.update({"system.aac.mod":1})),a(e?.system.aac.value).equal(8),a(e?.system.ac.value).equal(11),await(e?.update({"system.aac.mod":2})),a(e?.system.aac.value).equal(9),a(e?.system.ac.value).equal(10),await(e?.update({"system.aac.mod":-1})),a(e?.system.aac.value).equal(6),a(e?.system.ac.value).equal(13)})),t("THAC0 to BBA",(async()=>{const e=await at("character");a(e?.system.thac0.value).equal(19),a(e?.system.thac0.bba).equal(0),await(e?.update({"system.thac0.value":15})),a(e?.system.thac0.value).equal(15),a(e?.system.thac0.bba).equal(4)})),t("BBA to THAC0",(async()=>{const e=await at("character");a(e?.system.thac0.value).equal(19),a(e?.system.thac0.bba).equal(0),await(e?.update({"system.thac0.bba":15})),a(e?.system.thac0.bba).equal(15),a(e?.system.thac0.value).equal(4)}))})),e("createEmbeddedDocuments(embeddedName, data, context)",(()=>{s((async()=>{game.items?.filter((e=>e?.name?.indexOf(`Test ${et}`)>=0)).forEach((e=>e.delete()))})),Ne.forEach((e=>{t(`Creates ${e.capitalize()} with correct default icon`,(async()=>{const t=await at("character"),s=await O.create({name:`Test ${et} ${e.capitalize()}`,type:e});await(t?.createEmbeddedDocuments("Item",[s]));const n=t?.items.getName(s?.name);a(n?.img).equal(O.defaultIcons[e]),s?.delete()}))}))})),e("getExperience(value, options)",(()=>{n((async()=>{await re()})),t("Adding positive XP adds to experience",(async()=>{const e=await at("character");a(e?.system.details.xp.value).equal(0),a(game.messages?.size).equal(0),await(e?.getExperience(10)),a(e?.system.details.xp.value).equal(10),await le(),a(game.messages?.size).equal(1),await(e?.delete())})),t("Adding negative XP subtracts from experience",(async()=>{const e=await at("character");a(e?.system.details.xp.value).equal(0),a(game.messages?.size).equal(0),await(e?.getExperience(-10)),a(e?.system.details.xp.value).equal(-10),await le(),a(game.messages?.size).equal(1),await(e?.delete())})),t("Adding positive XP adds to experience modified by bonus",(async()=>{const e=await at("character");await(e?.update({system:{details:{xp:{bonus:10}}}})),a(e?.system.details.xp.value).equal(0),a(game.messages?.size).equal(0),await(e?.getExperience(10)),a(e?.system.details.xp.value).equal(11),await le(),a(game.messages?.size).equal(1),await(e?.delete())}))})),e("_preCreate(data, options, user)",(()=>{t("New character's prototypeToken actorLink defaults to true",(async()=>{const e=await at("character");a(e.prototypeToken.actorLink).equal(!0)})),t("New monster's prototypeToken actorLink defaults to false",(async()=>{const e=await at("monster");a(e.prototypeToken.actorLink).equal(!1)})),t("Character from compendium does not have defaults applied on import",(async()=>{const e=await ke("Actor"),t=await be("character",{"prototypeToken.actorLink":!1},et),s=await e.importDocument(t);await Ie(et);const n=await game.actors.importFromCompendium(e,s.id);a(n.prototypeToken.actorLink).equal(!1)})),s((async()=>{await Ee(),await Ie(et)}))})),e("isNew()",(()=>{t("character",(async()=>{const e=await at("character");a(e?.isNew()).equal(!0),await(e?.delete())})),t("monster",(async()=>{const e=await at("monster");a(e?.isNew()).equal(!0),await(e?.delete())}))})),e("generateSave(hd)",(async()=>{const e=[{low:-99,high:1,death:14,wands:15,paralysis:16,breath:17,spell:18},{low:1,high:3,death:12,wands:13,paralysis:14,breath:15,spell:16},{low:4,high:6,death:10,wands:11,paralysis:12,breath:13,spell:14},{low:7,high:9,death:8,wands:9,paralysis:10,breath:10,spell:12},{low:10,high:12,death:6,wands:7,paralysis:8,breath:8,spell:10},{low:10,high:12,death:6,wands:7,paralysis:8,breath:8,spell:10},{low:13,high:15,death:4,wands:5,paralysis:6,breath:5,spell:8},{low:16,high:18,death:2,wands:3,paralysis:4,breath:3,spell:6},{low:19,high:21,death:2,wands:2,paralysis:2,breath:2,spell:4},{low:22,high:99,death:2,wands:2,paralysis:2,breath:2,spell:2}],s=[{low:-100,high:0,value:20},{low:0,high:1,value:19},{low:1,high:2,value:18},{low:2,high:3,value:17},{low:3,high:4,value:16},{low:4,high:5,value:15},{low:5,high:6,value:14},{low:6,high:7,value:13},{low:7,high:9,value:12},{low:9,high:11,value:11},{low:11,high:13,value:1},{low:13,high:15,value:9},{low:15,high:17,value:8},{low:17,high:19,value:7},{low:19,high:21,value:6},{low:21,high:100,value:5}],n=Array.from({length:23},((e,t)=>t+1)),i=await at("monster");n.forEach((n=>{const o=e.find((e=>n>=e.low&&n<=e.high)),r=s.find((e=>n>=e.low&&n<=e.high)),l=s.find((e=>n+1>=e.low&&n+1<=e.high));i?.generateSave(`${n}`),t(`hd ${n} generates correct saves`,(()=>{a(i?.system.saves.death.value).equal(o?.death),a(i?.system.saves.wand.value).equal(o?.wands),a(i?.system.saves.paralysis.value).equal(o?.paralysis),a(i?.system.saves.breath.value).equal(o?.breath),a(i?.system.saves.spell.value).equal(o?.spell)})),t(`hd ${n} generates correct thac0`,(()=>{a(i?.system.thac0.value).equal(r?.value),a(i?.system.thac0.bba).equal(19-r?.value)})),i?.generateSave(`${n}+`),t(`hd ${n}+ generates correct thac0`,(()=>{a(i?.system.thac0.value).equal(l?.value),a(i?.system.thac0.bba).equal(19-l?.value)}))})),await(i?.delete())})),e("rollHP(options)",(async()=>{const e=await at("monster"),a=Array.from({length:20},((e,t)=>t+1)),s=[-3,-3,-3,-2,-2,-1,-1,-1,0,0,0,0,1,1,1,2,2,3,3,3],n=[4,6,8,10,12,20];a.forEach(((a,i)=>{n.forEach((n=>{t(`${n} hd with ${a} Con correctly rolls HP`,(async()=>{await(e?.update({system:{hp:{hd:`1d${n}`},scores:{con:{value:a}}}})),await(e?.rollHP()),o(e?.system.hp.max-s[i]>=1),o(e?.system.hp.value-s[i]>=1),o(e?.system.hp.max-s[i]>=n),o(e?.system.hp.value-s[i]>=n)}))}))})),await(e?.delete())})),e("rollSave(save, options)",(()=>{n((async()=>{await re()}));["death","wand","paralysis","breath","spell"].forEach((e=>{t(`is functional for ${e} saves on character`,(async()=>{const t=await at("character");a(game.messages?.size).equal(0),await(t?.rollSave(e,{fastForward:!0})),await le(),a(game.messages?.size).equal(1),await(t?.delete())})),t(`is functional for ${e} saves on monster`,(async()=>{const t=await at("monster");a(game.messages?.size).equal(0),await t.rollSave(e,{fastForward:!0}),await le(),a(game.messages?.size).equal(1),await(t?.delete())}))}))})),e("rollMorale(options)",(()=>{n((async()=>{await re()})),t("for character",(async()=>{const e=await at("character");a(game.messages?.size).equal(0),await e.rollMorale(),await le(),a(game.messages?.size).equal(1),await(e?.delete())})),t("for monster",(async()=>{const e=await at("monster");a(game.messages?.size).equal(0),await e.rollMorale(),await le(),a(game.messages?.size).equal(1),await(e?.delete())}))})),e("rollLoyalty(options)",(()=>{n((async()=>{await re()})),t("for character",(async()=>{const e=await at("character");a(game.messages?.size).equal(0),await e.rollLoyalty(),await le(),a(game.messages?.size).equal(1),await(e?.delete())})),t("for monster",(async()=>{const e=await at("monster");a(game.messages?.size).equal(0),await e.rollLoyalty(),await le(),a(game.messages?.size).equal(1),await(e?.delete())}))})),e("rollReaction(options)",(()=>{n((async()=>{await re()})),t("for character",(async()=>{const e=await at("character");a(game.messages?.size).equal(0),await e.rollReaction({fastForward:!0}),await le(),a(game.messages?.size).equal(1),await e.delete()})),t("for monster",(async()=>{const e=await at("monster");a(game.messages?.size).equal(0),await e.rollReaction({fastForward:!0}),await le(),a(game.messages?.size).equal(1),await e.delete()}))})),e("rollCheck(score, options)",(()=>{n((async()=>{await re()})),["str","int","dex","wis","con","cha"].forEach((e=>{t(`${e} for character`,(async()=>{const t=await at("character");a(game.messages?.size).equal(0),await t.rollCheck(e,{fastForward:!0}),await le(),a(game.messages?.size).equal(1),await t.delete()})),t(`${e} for character`,(async()=>{const t=await at("monster");a(game.messages?.size).equal(0),await t.rollCheck(e,{fastForward:!0}),await le(),a(game.messages?.size).equal(0),await t.delete()}))}))})),e("rollHitDice(options)",(()=>{const e=Array.from({length:20},((e,t)=>t+1)),n=[-3,-3,-3,-2,-2,-1,-1,-1,0,0,0,0,1,1,1,2,2,3,3,3],i=Array.from({length:9},((e,t)=>t+1));e.forEach(((e,s)=>{const o=n[s]||0,r=o<0?"-":"+",l="-"===r?-1*o:o;i.forEach((s=>{t(`constructs the roll terms correctly with level ${s} and con ${e}`,(async()=>{const t=await at("character");await(t?.update({system:{details:{level:s},hp:{hd:`${s}d8`},scores:{con:{value:e}}}}));const n=await t.rollHitDice();a(n.terms.length).equal(1),a(n.terms[0].rolls.length).equal(2),a(n.terms[0].rolls[0].terms.length).equal(3),a(n.terms[0].rolls[0].terms[0].expression).equal(t?.system.hp.hd),a(n.terms[0].rolls[0].terms[1].operator).equal(r),a(n.terms[0].rolls[0].terms[2].expression).equal((l*s).toString()),a(t?.system.scores.con.mod).equal(o),await(t?.delete())}))}))})),s((async()=>{await re()}))})),e("rollAppearing(options)",(()=>{n((async()=>{await re()})),t("for character",(async()=>{const e=await at("character");a(game.messages?.size).equal(0),await e.rollAppearing(),await le(),a(game.messages?.size).equal(0),await e.delete()})),e("for monster",(()=>{t("in wilderness",(async()=>{const e=await at("monster");a(game.messages?.size).equal(0),await e.rollAppearing({check:"wilderness"}),await le(),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(game.i18n.format("OSE.roll.appearing",{type:"2"})),await e.delete()})),t("in other",(async()=>{const e=await at("monster");a(game.messages?.size).equal(0),await e.rollAppearing({check:"other"}),await le(),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(game.i18n.format("OSE.roll.appearing",{type:"1"})),await e.delete()}))}))})),e("rollExploration(expl, options)",(()=>{n((async()=>{await re()}));["ld","od","sd","fs"].forEach((e=>{t("for character",(async()=>{const t=await at("character");a(game.messages?.size).equal(0),await t.rollExploration(e,{fastForward:!0}),await le(),a(game.messages?.contents[0].content).contain(game.i18n.format("OSE.roll.exploration",{exploration:game.i18n.localize(`OSE.exploration.${e}.long`)})),await t.delete()}))})),t("for monster",(async()=>{const e=await at("monster");a(game.messages?.size).equal(0),await e.rollExploration("ld",{fastForward:!0}),await le(),a(game.messages?.size).equal(0),await e.delete()}))})),e("rollDamage(attData, options)",(()=>{n((async()=>{await re()})),t("for character",(async()=>{const e=await at("character");a(game.messages?.size).equal(0),await e.rollDamage({label:"test"}),await le(),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(`test - ${game.i18n.localize("OSE.Damage")}`),await e.delete()})),t("for monster",(async()=>{const e=await at("monster");a(game.messages?.size).equal(0),await e.rollDamage({label:"test"}),await le(),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(`test - ${game.i18n.localize("OSE.Damage")}`),await e.delete()})),t("Adds roll.dmg to damage parts if provided",(async()=>{const e=await at("character");a(game.messages?.size).equal(0),await e.rollDamage({label:"test",roll:{dmg:"15"}}),await le(),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(`test - ${game.i18n.localize("OSE.Damage")}`),a(game.messages?.contents[0].content).contain("15"),await e.delete()})),t("Adds strength bonus if melee damage roll",(async()=>{const e=await at("character");await(e?.update({system:{scores:{str:{value:1}}}})),a(e.system.scores.str.value).equal(1),a(game.messages?.size).equal(0),await e.rollDamage({label:"test",roll:{dmg:"15",type:"melee"}}),await le(),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(`test - ${game.i18n.localize("OSE.Damage")}`),a(game.messages?.contents[0].content).contain("15 - 3"),await e.delete()}))})),e("targetAttack(data, type, options)",(()=>{i((async()=>{const e=await Se();await(e?.activate()),await oe(500)})),n((async()=>{await re(),await le()})),t("One target causes one attack roll",(async()=>{const e=await at("character"),t=await e.getTokenDocument();await oe(500),await t.constructor.create(t,{parent:canvas.scene}),await le(),a(game.user?.targets.size).equal(0),canvas.tokens?.placeables.forEach((e=>e.setTarget(!0,{releaseOthers:!1,groupSelection:!0}))),a(canvas.tokens?.placeables[0].actor).not.null,a(canvas.tokens?.placeables[0].actor?.system.ac.value).not.null,a(game.user?.targets.size).equal(1),a(game.messages?.size).equal(0),await e.targetAttack({roll:{target:{}}},"melee",{skipDialog:!0}),await le(),a(game.messages?.size).equal(1),canvas.tokens?.placeables.forEach((e=>e.setTarget(!1))),a(game.user?.targets.size).equal(0),await e.delete()})),t("Multiple target causes multiple attack rolls",(async()=>{const e=await at("character"),t=await e.getTokenDocument();await t.constructor.create(t,{parent:canvas.scene}),await le(),a(game.user?.targets.size).equal(0),canvas.tokens?.placeables.forEach((e=>e.setTarget(!0,{releaseOthers:!1,groupSelection:!0}))),a(game.user?.targets.size).equal(2),a(game.messages?.size).equal(0),await e.targetAttack({roll:{target:{}}},"melee",{skipDialog:!0}),await le(),a(game.messages?.size).equal(2),canvas.tokens?.placeables.forEach((e=>e.setTarget(!1))),a(game.user?.targets.size).equal(0),await e.delete()})),t("If no target is given, just roll attack",(async()=>{const e=await at("character");a(game.user?.targets.size).equal(0),a(game.messages?.size).equal(0),await e.targetAttack({roll:{blindroll:!1,dmg:["1d6"],thac0:15,target:{actor:{system:{ac:{value:0},aac:{value:9}}}}}},"melee",{skipDialog:!0}),await le(),a(game.messages?.size).equal(1),await e.delete()})),s((async()=>{await Ae()}))})),e("rollAttack(attdata, options)",(()=>{i((async()=>{await re()})),n((async()=>{await re(),await le()})),t("rolls a d20 if supplied no data",(async()=>{const e=await at("character");a(game.messages?.size).equal(0);const t=await e.rollAttack({roll:{}},{skipDialog:!0});a(t.formula).equal("1d20"),await le(),a(game.messages?.size).equal(1),await e.delete()})),t("Provided an item, adds item damage to dmgParts",(async()=>{const e=await at("character"),t=await ve("weapon");a(t?.system.damage).is.not.undefined,a(game.messages?.size).equal(0);const s=await e.rollAttack({roll:{},item:t},{skipDialog:!0});a(s.formula).equal("1d20"),await le(),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(game.i18n.format("OSE.roll.attacksWith",{name:t?.name})),a(game.messages?.contents[0].content).contain("1d20"),e?.delete(),t?.delete()})),t("If missile attack, add dex mod to attack roll",(async()=>{const e=await at("character");a(game.messages?.size).equal(0);const t=await e.rollAttack({roll:{}},{type:"missile",skipDialog:!0});a(t.formula).equal("1d20 - 3"),await le(),a(game.messages?.size).equal(1),await e.delete()})),t("If melee attack, add str mod to attack roll",(async()=>{const e=await at("character");await e.update({system:{scores:{str:{value:18}}}}),a(game.messages?.size).equal(0);const t=await e.rollAttack({roll:{}},{type:"melee",skipDialog:!0});a(t.formula).equal("1d20 + 3"),await le(),a(game.messages?.size).equal(1),await e.delete()})),t("If melee attack, add str mod to damage roll",(async()=>{const e=CONFIG.Dice.randomUniform;CONFIG.Dice.randomUniform=()=>we(10,20);const t=await at("character");await t.update({system:{scores:{str:{value:18}}}}),a(game.messages?.size).equal(0);const s=await t.rollAttack({roll:{}},{type:"melee",skipDialog:!0});a(s.formula).equal("1d20 + 3"),await le(),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(game.i18n.localize("OSE.messages.InflictsDamage")),a(game.messages?.contents[0].content).contain("1d6 + 3"),await t.delete(),CONFIG.Dice.randomUniform=e})),t("If item provided with a bonus, it is added as bonus to attack roll",(async()=>{const e=await at("character"),t=await ve("weapon");await(t?.update({system:{bonus:18}})),a(game.messages?.size).equal(0);const s=await e.rollAttack({roll:{},item:t},{skipDialog:!0});a(s.formula).equal("1d20 + 18"),await le(),a(game.messages?.size).equal(1),await e.delete()}))})),e("applyDamage(amount, multiplier)",(()=>{t("doesn't remove hp if no variables are given",(async()=>{const e=await at("character");await e.update({system:{hp:{value:10,max:10}}}),a(e.system.hp.value).equal(10),await e.applyDamage(),a(e.system.hp.value).equal(10),await e.delete()})),t("calculates the amount with amount",(async()=>{const e=await at("character");await e.update({system:{hp:{value:10,max:10}}}),a(e.system.hp.value).equal(10),await e.applyDamage(3),a(e.system.hp.value).equal(7),await e.delete()})),t("calculates the amount with amount and multiplier",(async()=>{const e=await at("character");await e.update({system:{hp:{value:10,max:10}}}),a(e.system.hp.value).equal(10),await e.applyDamage(3,2),a(e.system.hp.value).equal(4),await e.delete()})),t("calculates the amount with amount and negative multiplier",(async()=>{const e=await at("character");await e.update({system:{hp:{value:1,max:10}}}),a(e.system.hp.value).equal(1),await e.applyDamage(3,-2),a(e.system.hp.value).equal(7),await e.delete()})),t("calculates the amount with negative amount",(async()=>{const e=await at("character");await e.update({system:{hp:{value:1,max:10}}}),a(e.system.hp.value).equal(1),await e.applyDamage(-3),a(e.system.hp.value).equal(4),await e.delete()})),t("doesn't reduce lower than 0 hp with only amount",(async()=>{const e=await at("character");await e.update({system:{hp:{value:10,max:10}}}),a(e.system.hp.value).equal(10),await e.applyDamage(20),a(e.system.hp.value).equal(0),await e.delete()})),t("doesn't reduce lower than 0 hp with amount and multiplier",(async()=>{const e=await at("character");await e.update({system:{hp:{value:10,max:10}}}),a(e.system.hp.value).equal(10),await e.applyDamage(4,3),a(e.system.hp.value).equal(0),await e.delete()})),t("doesn't increase higher than max hp with only amount",(async()=>{const e=await at("character");await e.update({system:{hp:{value:1,max:10}}}),a(e.system.hp.value).equal(1),await e.applyDamage(-20),a(e.system.hp.value).equal(10),await e.delete()})),t("doesn't increase higher than max hp with amount and multiplier",(async()=>{const e=await at("character");await e.update({system:{hp:{value:1,max:10}}}),a(e.system.hp.value).equal(1),await e.applyDamage(4,-3),a(e.system.hp.value).equal(10),await e.delete()}))}))};const nt="ose.actor.sheet",it={displayName:"OSE: Actor: Sheet",preSelected:!0},ot=async()=>game.actors?.getName(`Test Actor ${nt}`);var rt=({describe:e,it:t,expect:a,after:s,afterEach:n,before:i})=>{const o=game.settings.get(game.system.id,"invertedCtrlBehavior");s((async()=>{await Ie(nt),await pe(),game.settings.set(game.system.id,"invertedCtrlBehavior",o)})),e("getData()",(()=>{t("returns the expected data",(async()=>{const e=await be("character",{},nt),t=new g(e),s=await t.getData();a(s.owner).equal(e?.isOwner),a(s.editable).equal(e?.sheet?.isEditable),a(Object.keys(s.config)).contain("ascendingAC"),a(Object.keys(s.config)).contain("initiative"),a(Object.keys(s.config)).contain("encumbrance"),a(s.isNew).equal(e?.isNew())}))})),e("_getItemFromActor(event)",(()=>{Ne.forEach((e=>{t(`Can get an ${e.capitalize()} item`,(async()=>{const t=await be("character",{},nt);await(t?.update({system:{spells:{enabled:!0}}})),t?.sheet?.render(!0),await oe(200);const s=await fe(t,e);await le(),a(t?.items.size).equal(1);const n=s?.pop();a(t?.items.contents.find((e=>e.id===n?.id))).not.undefined;let i="";switch(e){case"spell":i=".tab[data-tab=spells]";break;case"ability":i=".tab[data-tab=abilities]";break;default:i=".tab[data-tab=inventory]"}const o=document.querySelector(`${i} .item-name`)?.parentElement?.nextElementSibling;a([...o?.classList]).to.be.an("array").that.does.not.include("expanded"),document.querySelector(`${i} .item-name`)?.dispatchEvent(new MouseEvent("click",{bubbles:!0})),await oe(200),a([...o?.classList]).to.be.an("array").that.includes("expanded"),await(t?.delete())})),s((async()=>{await Ie(nt),await pe(),await oe(220)}))}))})),e("_toggleItemCategory(event)",(()=>{const e=async()=>{document.querySelector(".tab[data-tab='inventory'] .item-category-title")?.dispatchEvent(new MouseEvent("click",{bubbles:!0})),await oe(220)};i((async()=>{const e=await be("character",{},nt);await e.update({system:{spells:{enabled:!0}}}),e?.sheet?.render(!0),await oe(220)})),t("clicking the category name hides the item cateogry",(async()=>{const t=ce("sheet");a(t.length).equal(1);const s=document.querySelector(".tab[data-tab='inventory'] .item-list");a(s?.style.display).equal(""),await e(),a(s?.style.display).equal("none")})),t("clicking the category name again shows the item cateogry",(async()=>{const t=ce("sheet");a(t.length).equal(1);const s=document.querySelector(".tab[data-tab='inventory'] .item-list");a(s?.style.display).equal("none"),await e(),a(s?.style.display).equal("")})),s((async()=>{await Ie(nt),await pe(),await oe(220)}))})),e("_toggleContainedItems(event)",(()=>{const e=async()=>{document.querySelector(".tab[data-tab='inventory'] .container .category-caret")?.dispatchEvent(new MouseEvent("click",{bubbles:!0})),await oe(220)};i((async()=>{const e=await be("character",{},nt);await fe(e,"container"),await fe(e,"weapon");const t=e?.items.getName("New Actor Test Weapon"),a=e?.items.getName("New Actor Test Container");await(t?.update({system:{containerId:a?.id}})),e?.sheet?.render(!0)})),t("clicking container caret will hide the content",(async()=>{const t=ce("sheet");a(t.length).equal(1);const s=await ot();a(s?.items.size).equal(2);const n=s?.items?.getName("New Actor Test Container");a(s?.items.getName("New Actor Test Weapon")?.system.containerId).equal(n?.id);const i=document.querySelector(".tab[data-tab='inventory'] .container .contained-items");a(i?.style.display).equal(""),await e(),a(i?.style.display).equal("none")})),t("clicking container caret again will show the content",(async()=>{const t=ce("sheet");a(t.length).equal(1);const s=await ot();a(s?.items.size).equal(2);const n=s?.items?.getName("New Actor Test Container");a(s?.items.getName("New Actor Test Weapon")?.system.containerId).equal(n?.id);const i=document.querySelector(".tab[data-tab='inventory'] .container .contained-items");a(i?.style.display).equal("none"),await e(),a(i?.style.display).equal("")})),s((async()=>{await Ie(nt),await pe()}))})),e("_toggleItemSummary(event)",(()=>{const n=async e=>{const t=await ot();document.querySelector(`#OseActorSheetCharacter-Actor-${t.id} section .tab[data-tab="${e}"] .item-name`)?.click(),await oe(320)},o=async e=>{const t=await ot();document.querySelector(`#OseActorSheetCharacter-Actor-${t.id} nav.sheet-tabs a[data-tab="${e}"]`)?.click(),await oe(120)};i((async()=>{const e=await be("character",{},nt);await(e?.update({system:{spells:{enabled:!0}}})),e?.sheet?.render(!0),await oe(220)}));for(const r of Ne){let l="";switch(r){case"spell":l="spells";break;case"ability":l="abilities";break;default:l="inventory"}e(`for type ${r}`,(()=>{i((async()=>{const e=await ot();await fe(e,r)})),t("clicking item name will show the content",(async()=>{const e=ce("sheet");a(e.length).equal(1),await o(l);const t=await ot();a(t?.items.size).equal(1);const s=document.querySelector(`#OseActorSheetCharacter-Actor-${t.id} section .tab[data-tab="${l}"] .item-summary`);a([...s?.classList]).to.be.an("array").that.does.not.include("expanded"),await n(l),a([...s?.classList]).to.be.an("array").that.includes("expanded")})),t("clicking item name again will hide the content",(async()=>{const e=ce("sheet");a(e.length).equal(1),await o(l);const t=await ot();a(t?.items.size).equal(1);const s=document.querySelector(`#OseActorSheetCharacter-Actor-${t.id} section .tab[data-tab="${l}"] .item-summary`);a([...s?.classList]).to.be.an("array").that.includes("expanded"),await n(l),a([...s?.classList]).to.be.an("array").that.does.not.include("expanded")})),t("item containing description still shows the summary",(async()=>{const e=ce("sheet");a(e.length).equal(1),await o(l);const t=await ot(),s=t?.items.getName(`New Actor Test ${r.capitalize()}`);await n(l),await(s?.update({system:{description:"hello world"}})),await le(),a(s?.system.description).equal("hello world");const i=document.querySelector(`#OseActorSheetCharacter-Actor-${t.id} section .tab[data-tab="${l}"] .item-summary`);a(i?.innerHTML.indexOf("hello world")>=0).is.true,await(s?.update({system:{description:""}}))})),t("item containing macro reference still shows the summary, Issue #353",(async()=>{const e=ce("sheet");a(e.length).equal(1),await o(l);const t=await qe(),s=`<p>@UUID[${t?.uuid}]{Mock Macro}</p>`,n=await ot(),i=n?.items.getName(`New Actor Test ${r.capitalize()}`);await(i?.update({system:{description:s}})),await le();const c=document.querySelector(`#OseActorSheetCharacter-Actor-${n.id} section .tab[data-tab="${l}"] .item-summary`);a(c).is.not.null,a(c?.querySelector(`a[data-uuid="${t?.uuid}"]`)).is.not.null,await(t?.delete()),await(i?.update({system:{description:""}}))})),s((async()=>{(await ot())?.items.forEach((async e=>{await e.delete()})),await Te()}))}))}s((async()=>{await Ie(nt),await pe()}))})),e("_displayItemInChat(event)",(()=>{i((async()=>{const e=await be("character",{},nt);await(e?.update({system:{spells:{enabled:!0}}})),e?.sheet?.render(!0),await oe(220)})),Ne.forEach((e=>{let n="";switch(e){case"spell":n=".tab[data-tab='spells']";break;case"ability":n=".tab[data-tab='abilities']";break;default:n=".tab[data-tab='inventory']"}t(`can show ${e}`,(async()=>{await re();const t=await ot();await fe(t,e),await le(),await(async e=>{document.querySelector(`${e} .item-show`)?.dispatchEvent(new MouseEvent("click",{bubbles:!0})),await oe(220)})(n),await le(),a(game.messages?.size).equal(1),a(game.messages?.contents[0]?.content).contain(`New Actor Test ${e.capitalize()}`),t?.items.forEach((e=>e.delete()))})),s((async()=>{await Ie(nt)}))}))})),e("_removeItemFromActor(item)",(()=>{i((async()=>{const e=await be("character",{},nt);await(e?.update({system:{spells:{enabled:!0}}})),e?.sheet?.render(!0)})),Ne.forEach((n=>{e(`${n} item`,(()=>{t("can remove item outside container",(async()=>{const e=await ot();a(e?.items.size).equal(0),await fe(e,n),await le();const t=e?.items.getName(`New Actor Test ${n.capitalize()}`);a(e?.items.size).equal(1),await(e?.sheet?._removeItemFromActor(t)),await le(),a(e?.items.size).equal(0)})),"container"!==n&&"spell"!==n&&"ability"!==n&&(t("can remove item inside container",(async()=>{const e=await ot();a(e?.items.size).equal(0),await fe(e,"container"),await fe(e,n),await le(),a(e?.items.size).equal(2);const t=e?.items.getName(`New Actor Test ${n.capitalize()}`),s=e?.items.getName("New Actor Test Container");a(t).not.undefined,a(s).not.undefined,await(e?.sheet?._onContainerItemAdd(t,s)),await le(),await(e?.sheet?._removeItemFromActor(t)),await le(),a(e?.items.size).equal(1),a(s?.system.itemIds.length).equal(0),await(e?.sheet?._removeItemFromActor(s)),await le(),a(e?.items.size).equal(0)})),t("removing container with item inside deletes just container",(async()=>{const e=await ot();a(e?.items.size).equal(0),await fe(e,"container"),await fe(e,n),await le(),a(e?.items.size).equal(2);const t=e?.items.getName(`New Actor Test ${n.capitalize()}`),s=e?.items.getName("New Actor Test Container");a(t).not.undefined,a(s).not.undefined,a(e?.items.size).equal(2),await(e?.sheet?._removeItemFromActor(s)),await le(),a(e?.items.size).equal(1),await(e?.sheet?._removeItemFromActor(t)),await le(),a(e?.items.size).equal(0)})))})),s((async()=>{await Ie(nt)}))}))})),e("_useConsumable(event, decrement)",(()=>{i((async()=>{const e=await be("character",{},nt);await fe(e,"item"),await le();const t=e?.items.contents[0];await(t?.update({system:{quantity:{max:6,value:3}}})),await le(),e?.sheet?.render(!0),await oe(220)})),t("can decrease value",(async()=>{const e=(await ot())?.items.contents[0];a(e?.system.quantity.value).equal(3),await(async()=>document.querySelector('.tab[data-tab="inventory"] .full-mark')?.dispatchEvent(new MouseEvent("click",{bubbles:!0})))(),await le(),a(e?.system.quantity.value).equal(2)})),t("can increase value",(async()=>{const e=(await ot())?.items.contents[0];a(e?.system.quantity.value).equal(2),await(async()=>document.querySelector('.tab[data-tab="inventory"] .empty-mark')?.dispatchEvent(new MouseEvent("click",{bubbles:!0})))(),await le(),a(e?.system.quantity.value).equal(3)})),s((async()=>{await Ie(nt)}))})),e("_onSpellChange(event)",(()=>{i((async()=>{const e=await be("character",{},nt);await(e?.update({system:{spells:{enabled:!0}}})),await fe(e,"spell"),await le(),e?.sheet?.render(!0)})),t("changing the input for cast changes spell cast data",(async()=>{const e=document.querySelector("input[data-field='cast']");a(e).is.not.null,e&&(e.value=3,e.dispatchEvent(new Event("change"))),await le();const t=(await ot())?.items.contents[0];a(t?.system.cast).equal(3)})),t("changing the input for memorize changes spell memorize data",(async()=>{const e=document.querySelector("input[data-field='memorize']");a(e).is.not.null,e&&(e.value=3,e.dispatchEvent(new Event("change"))),await le();const t=(await ot())?.items.contents[0];a(t?.system.memorized).equal(3)})),s((async()=>{await Ie(nt),await oe(300)}))})),e("_resetSpells(event)",(()=>{i((async()=>{const e=await be("character",{},nt);await(e?.update({system:{spells:{enabled:!0}}})),await fe(e,"spell"),await le(),await(e?.items.contents[0].update({system:{cast:1,memorized:3}})),e?.sheet?.render(!0)})),t("resetting spells resets the cast field to maximum",(async()=>{const e=await ot();document.querySelector(`#OseActorSheetCharacter-Actor-${e.id} a[data-action='reset-spells']`)?.click(),await le(),a(e?.items.contents[0].system.cast).equal(e?.items.contents[0].system.memorized)})),s((async()=>{await Ie(nt)}))})),e("_rollAbility(event) ",(()=>{const e=async e=>{document.querySelector(`.tab[data-tab="${e}"] .item-image`)?.dispatchEvent(new MouseEvent("click",{bubbles:!0})),await oe(220)};i((async()=>{await game.settings.set(game.system.id,"invertedCtrlBehavior",!0),await re()})),n((async()=>{await Ie(nt),await re()})),t("rolling weapon on monster updates the counter value",(async()=>{a(game.messages?.size).equal(0);const t=await be("monster",{},nt);await fe(t,"weapon"),await le(),await(t?.items.contents[0].update({system:{counter:{value:3,max:3}}})),a(t?.items.size).equal(1),t?.sheet?.render(!0),await le(),await e("attributes"),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(`<h2>${game.i18n.format("OSE.roll.attacksWith",{name:"New Actor Test Weapon"})}</h2>`),a(t?.items.contents[0].system.counter.value).equal(2)})),t("rolling weapon on character rolls weapon",(async()=>{a(game.messages?.size).equal(0);const t=await be("character",{},nt);await fe(t,"weapon"),await le(),a(t?.items.size).equal(1),t?.sheet?.render(!0),await le(),await e("inventory"),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(`<h2>${game.i18n.format("OSE.roll.attacksWith",{name:"New Actor Test Weapon"})}</h2>`)})),t("rolling spell rolls and spends the spell",(async()=>{a(game.messages?.size).equal(0);const t=await be("character",{},nt);await(t?.update({system:{spells:{enabled:!0}}})),await fe(t,"spell"),await le(),a(t?.items.size).equal(1),t?.sheet?.render(!0),await le(),await e("spells"),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain("<h2>New Actor Test Spell</h2>")})),t("rolling anything else rolls the formula",(async()=>{a(game.messages?.size).equal(0);const t=await be("character",{},nt);await(t?.update({system:{spells:{enabled:!0}}})),await fe(t,"ability"),await le(),a(t?.items.size).equal(1),await(t?.items.contents[0].update({system:{roll:"1d6"}})),await le(),a(t?.items.contents[0].system.roll).equal("1d6"),t?.sheet?.render(!0),await le(),await e("abilities"),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(`<h2>${game.i18n.format("OSE.roll.formula",{label:"New Actor Test Ability"})}</h2>`)})),t("rolling anything else, without a formula, does nothing",(async()=>{a(game.messages?.size).equal(0);const t=await be("character",{},nt);await(t?.update({system:{spells:{enabled:!0}}})),await fe(t,"spell"),await le(),a(t?.items.size).equal(1),t?.sheet?.render(!0),await le(),await e("inventory"),a(game.messages?.size).equal(0)})),s((async()=>{await Ie(nt),await re()}))})),e("_rollSave(event)",(()=>{const n=["death","wand","paralysis","breath","spell"],o=async e=>{document.querySelector(`li[data-save="${e}"] a`)?.dispatchEvent(new MouseEvent("click",{bubbles:!0})),await oe(220)};e("character can roll",(()=>{i((async()=>{const e=await be("character",{},nt);await(e?.sheet?.render(!0)),await game.settings.set(game.system.id,"invertedCtrlBehavior",!0),await re(),await oe(200)})),n.forEach((e=>{t(`${e} save`,(async()=>{await re(),await oe(200),a(game.messages?.size).equal(0),await o(e),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(game.i18n.format("OSE.roll.save",{save:game.i18n.localize(`OSE.saves.${e}.long`)}))}))})),s((async()=>{await Ie(nt),await re(),await oe(200)}))})),e("monster can roll",(()=>{i((async()=>{const e=await be("monster",{},nt);await(e?.sheet?.render(!0))})),n.forEach((e=>{t(`${e} save`,(async()=>{await re(),await oe(200),a(game.messages?.size).equal(0),await o(e),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(game.i18n.format("OSE.roll.save",{save:game.i18n.localize(`OSE.saves.${e}.long`)}))}))})),s((async()=>{await Ie(nt),await re(),await oe(200)}))}))})),e("_rollAttack(event)",(()=>{i((async()=>{await game.settings.set(game.system.id,"invertedCtrlBehavior",!0);(await be("character",{},nt))?.sheet?.render(!0),await re()})),["melee","missile"].forEach((e=>{t(`can attack with ${e}`,(async()=>{const t=await ot();a(game.messages?.size).equal(0),await(async e=>{document.querySelector(`li[data-attack="${e}"] a`)?.dispatchEvent(new MouseEvent("click",{bubbles:!0})),await oe(200)})(e),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contain(game.i18n.format("OSE.roll.attacks",{name:t?.name})),await re()}))})),s((async()=>{await Ie(nt)}))}));const r=(e,t)=>{a(t.source.item).not.undefined,a(t.source.item?.documentName).equal("Item"),a(t.source.item?.name).equal(e),a(t.source.item?.system.containerId).equal(""),a(t.target.item?.system.itemIds.length).equal(0)},l=(e,t)=>{a(t.target.item?.system.itemIds.length).equal(1),a(t.target.item?.system.itemIds).contain(t.source.item?.id),a(t.source.item?.system.containerId).equal(t.target.item?.id);const s="armor"===t.source.item?.type?t.source.item?.type:`${t.source.item?.type}s`,n="containers"===s?1:0;a(e.actor?.system[s].length).equal(n)};e("_onContainerItemAdd(item, target)",(()=>{Ne.forEach((e=>{if("spell"===e)return;if("ability"===e)return;const n={},o={source:{},target:{}};i((async()=>{n.actor=await be("character",{},nt),[o.target.item]=await fe(n.actor,"container","TargetContainer")})),t(`add ${e} to container`,(async()=>{((e,t)=>{a(e.actor).not.undefined,a(e.actor?.documentName).equal("Actor"),a(t.target.item).not.undefined,a(t.target.item?.documentName).equal("Item"),a(t.target.item?.name).equal("TargetContainer")})(n,o),[o.source.item]=await fe(n.actor,e);const t=`New Actor Test ${e.capitalize()}`;r(t,o),await(n.actor?.sheet?._onContainerItemAdd(o.source.item,o.target.item)),l(n,o)})),s((async()=>{await Ie(nt)}))}))})),e("_onContainerItemRemove(item, container)",(()=>{Ne.forEach((e=>{if("spell"===e)return;if("ability"===e)return;const a={},n={source:{},target:{}};i((async()=>{a.actor=await be("character",{},nt),[n.target.item]=await fe(a.actor,"container","TargetContainer"),[n.source.item]=await fe(a.actor,e),await(a.actor?.sheet?._onContainerItemAdd(n.source.item,n.target.item))})),t(`remove ${e} from container`,(async()=>{l(a,n),await(a.actor?.sheet?._onContainerItemRemove(n.source.item,n.target.item));const t=`New Actor Test ${e.capitalize()}`;r(t,n)})),s((async()=>{await Ie(nt)}))}))})),e("_onDropItemCreate(droppedItem, targetContainer)",(()=>{Ne.forEach((e=>{if("spell"===e)return;if("ability"===e)return;const n={},o={source:{},target:{}};i((async()=>{n.actor=await be("character",{},nt)})),t(`add non-actor ${e} to sheet`,(async()=>{o.source.item=await ve(e);const t=o.source.item.name||"test";await(n.actor?.sheet?._onDropItemCreate([o.source.item])),o.source.item=n.actor?.items.getName(t),a(o.source.item).not.undefined})),s((async()=>{await Ie(nt)}))}))})),e("_chooseItemType(choices)",(()=>{const e=["weapon","armor","shield","gear"];t("can create standard dialog",(async()=>{(await be("monster",{},nt))?.sheet?._chooseItemType(),await le();const t=me();a(t.length).equal(1),e.forEach((e=>{a(t[0]?.element.querySelector(`option[value="${e}"]`)).is.not.null})),await(t[0]?.close())})),t("can create custom dialog",(async()=>{const e=["test","test2","test3"];(await be("monster",{},nt))?.sheet?._chooseItemType(e),await le();const t=me();a(t.length).equal(1),e.forEach((e=>{a(t[0]?.element.querySelector(`option[value="${e}"]`)).is.not.null})),await(t[0]?.close())})),n((async()=>{await ge(),await Ie(nt)}))})),e("_createItem(event)",(()=>{for(const e of Ne)t(`can create ${e}`,(async()=>{const t=await be("character",{},nt);await(t?.update({system:{spells:{enabled:!0}}})),await(t?.sheet?.render(!0)),await oe(200),a(t?.items.size).equal(0);let s=`.sheet .item-create[data-type="${e}"]`;"item"===e?s+=':not([data-treasure="true"]':"treasure"===e&&(s='.sheet .item-create[data-type="item"][data-treasure="true"]'),document.querySelector(s)?.dispatchEvent(new MouseEvent("click",{bubbles:!0})),await le(),a(t?.items.size).equal(1);const n=t?.items.contents[0];a(n).not.undefined,a(n?.type).equal(e)}));n((async()=>{await Ie(nt),await le()}))})),e("_updateItemQuantity(event)",(()=>{const e=(e,t)=>{e.value=String(parseInt(e.value,10)+t);const a=new InputEvent("change");e.dispatchEvent(a)};t("can add to the quantity",(async()=>{const t=await be("character",{},nt);t?.sheet?.render(!0);const[s]=await fe(t,"item");await s.update({system:{quantity:{value:2,max:4}}}),await le();const n=document.querySelector(`.sheet .item[data-item-id="${s.id}"] input[data-field="value"]`);a(s.system.quantity.value).equal(2),e(n,1),await le(),a(s.system.quantity.value).equal(3)})),t("can subtract from the quantity",(async()=>{const t=await be("character",{},nt);t?.sheet?.render(!0);const[s]=await fe(t,"item");await s.update({system:{quantity:{value:2,max:4}}}),await le();const n=document.querySelector(`.sheet .item[data-item-id="${s.id}"] input[data-field="value"]`);a(s.system.quantity.value).equal(2),e(n,-1),await le(),a(s.system.quantity.value).equal(1)})),n((async()=>{await Ie(nt),await oe(300)}))})),e("_renderInner(...args)",(()=>{})),e("_onResize(event)",(()=>{})),e("_onConfigureActor(event)",(()=>{for(const e of["character","monster"])t(`Entity Tweaks renders for ${e}`,(async()=>{const t=await be(e,{},`${nt} ${e}`);await(t?.sheet?.render(!0)),await oe(600),document.querySelector(`#OseActorSheet${e.capitalize()}-Actor-${t?.id} .configure-actor`)?.dispatchEvent(new MouseEvent("click",{bubbles:!0})),await le();const s=ce("sheet-tweaks").filter((t=>t.object?.name===`Test Actor ${nt} ${e}`));a(s.length).equal(1);const n=s?.[0]?.element?.[0];a(n).not.undefined,a(n.querySelector("h4.window-title").innerHTML).to.include(`Test Actor ${nt} ${e}`),await(s?.[0]?.close()),await(t?.delete())}))})),e("_getHeaderButtons()",(()=>{}))};const lt="ose.actor.sheet.e2e.dragndrop",ct={displayName:"OSE: Actor: Sheet E2E Drag'n'Drop",preSelected:!0},ut=async e=>{const t=new DragEvent("dragstart",{dataTransfer:new DataTransfer,bubbles:!0,cancelable:!0});e.source.itemElement?.dispatchEvent(t);const a=new DragEvent("drop",{dataTransfer:t.dataTransfer,bubbles:!0,cancelable:!0});e.target.itemElement?.dispatchEvent(a)};var mt=({describe:e,it:t,expect:a,after:s,afterEach:n,beforeEach:i})=>{e("_onDragStart(event)",(()=>{t("populates dataTransfer correctly",(async()=>{const e=await be("character",{},lt);a(e).not.undefined,await(e.sheet?.render(!0));const[t]=await fe(e,"weapon");a(t).not.undefined,await le();const s=document.querySelector(`.sheet .inventory li.item[data-item-id="${t?.id}"]`);a(s).not.null;const n=(e=>{const t=new DragEvent("dragstart",{dataTransfer:new DataTransfer,bubbles:!0,cancelable:!0});return e?.dispatchEvent(t),t})(s),i=foundry.applications.ux.TextEditor.implementation.getDragEventData(n);a(Object.keys(i)).contain("item")})),s((async()=>{await Ie(lt)}))})),e("_onDropItem(event, data)",(()=>{})),e("_onDragStart(event, data) & _onDrop(event, data) - Containers",(()=>{const n=(e,t)=>{a(e.actor).not.undefined,a(e.actor?.documentName).equal("Actor"),a(e.compendium).not.undefined,a(e.compendium?.documentName).equal("Item"),a(t.target.item).not.undefined,a(t.target.item?.documentName).equal("Item"),a(t.target.item?.name).equal("TargetContainer"),a(t.target.itemElement).not.null,a(t.target.itemElement?.constructor.name).equal("HTMLLIElement")},o=(e,t)=>{a(t.source.item).not.undefined,a(t.source.item?.documentName).equal("Item"),a(t.source.item?.name).equal(e),a(t.source.itemElement).not.null,a(t.source.itemElement?.constructor.name).equal("HTMLLIElement"),a(t.source.item?.system.containerId).equal(""),a(t.target.item?.system.itemIds.length).equal(0)},r=(e,t)=>{a(t.target.item?.system.itemIds.length).equal(1),a(t.target.item?.system.itemIds).contain(t.source.item?.id),a(t.source.item?.system.containerId).equal(t.target.item?.id);const s="armor"===t.source.item?.type?t.source.item?.type:`${t.source.item?.type}s`,n="containers"===s?1:0;a(e.actor?.system[s].length).equal(n)};t("Issue#357 Dragging container onto itself should retain container in inventory",(async()=>{const e={source:{},target:{}},t=await be("character",{},lt);[e.target.item]=await fe(t,"container","TargetContainer"),[e.source.item]=await fe(t,"weapon"),t?.sheet?.render(!0),await le(),e.source.itemElement=document.querySelector(`.sheet .inventory li.item[data-item-id="${e.source?.item?.id}"]`),e.target.itemElement=document.querySelector(`.sheet .inventory li.item[data-item-id="${e.target?.item?.id}"]`),o("New Actor Test Weapon",e),await ut(e),await le(),a(e.target.item?.system.itemIds.length).equal(1),a(e.target.item?.system.itemIds).contain(e.source.item?.id),a(e.source.item?.system.containerId).equal(e.target.item?.id),e.source.itemElement=e.target.itemElement,e.source.item=e.target.item,await ut(e),await le();const s=document.querySelector(`.sheet .inventory li.item[data-item-id="${e.target?.item?.id}"]`);a(s).not.null}));for(const a of Ne){if("spell"===a)continue;if("ability"===a)continue;const l={},c={source:{},target:{}};e(`manipulating ${a} item type`,(()=>{i((async()=>{await Ie(lt),await Ee(),await Ce(),await le(),l.actor=await be("character",{},lt),l.compendium=await ke("Item"),[c.target.item]=await fe(l.actor,"container","TargetContainer"),l.actor?.sheet?.render(!0),l.compendium?.render(!0),await le(),document.querySelector(`#OseActorSheetCharacter-Actor-${l.actor.id} nav.sheet-tabs a[data-tab="inventory"]`)?.click(),await le(),c.target.itemElement=document.querySelector(`#OseActorSheetCharacter-Actor-${l.actor.id} .inventory li.item[data-item-id="${c.target.item?.id}"]`)})),t(`drag ${a} from actor sheet into a container in a character sheet`,(async()=>{n(l,c),[c.source.item]=await fe(l.actor,a),await le(),c.source.itemElement=document.querySelector(`#OseActorSheetCharacter-Actor-${l.actor.id} .inventory li.item[data-item-id="${c.source.item?.id}"]`),c.target.itemElement?.isConnected||(c.target.itemElement=document.querySelector(`#OseActorSheetCharacter-Actor-${l.actor.id} .inventory li.item[data-item-id="${c.target.item?.id}"]`));const e=`New Actor Test ${a.capitalize()}`;o(e,c),await ut(c),await le(),r(l,c)})),t(`drag ${a} from item sidebar into a container in a character sheet`,(async()=>{n(l,c),c.source.item=await ve(a),await le(),c.source.itemElement=document.querySelector(`#items li.item[data-entry-id="${c.source.item?.id}"]`);const e=`New World Test ${a.capitalize()}`;o(e,c),await ut(c),await le(),c.source.item=l.actor?.items.getName(c.source.item?.name),r(l,c)})),t(`drag ${a} from compendium into a container in a character sheet`,(async()=>{n(l,c);const e=await ve(a);c.source.item=await(l.compendium?.importDocument(e)),await le(),c.source.itemElement=document.querySelector(`.compendium-directory li.item[data-entry-id="${c.source.item?.id}"]`);const t=`New World Test ${a.capitalize()}`;o(t,c),await ut(c),await le(),c.source.item=l.actor?.items.getName(c.source.item?.name),r(l,c)})),s((async()=>{await Ie(lt),await Ee(),await Ce(),await le()}))}))}}))};const dt="ose.actor.sheet.character",gt={displayName:"OSE: Actor: Sheet: Character"};var pt=({describe:e,it:t,expect:a,after:s,afterEach:n})=>{s((async()=>{await Ie(dt),await pe()})),e("defaultOptions()",(()=>{t("Has correctly set defaultOptions",(async()=>{const e=(await be("character",{},dt))?.sheet;a(e.options.classes).contain("ose"),a(e.options.classes).contain("sheet"),a(e.options.classes).contain("actor"),a(e.options.classes).contain("character"),a(e.options.template).contain("/templates/actors/character-sheet.html"),a(e.options.width).equal(450),a(e.options.height).equal(530),a(e.options.resizable).is.true,a(e.options.tabs.length).equal(1),a(Object.keys(e.options.tabs[0])).contain("navSelector"),a(e.options.tabs[0].navSelector).equal(".sheet-tabs"),a(Object.keys(e.options.tabs[0])).contain("contentSelector"),a(e.options.tabs[0].contentSelector).equal(".sheet-body"),a(Object.keys(e.options.tabs[0])).contain("initial"),a(e.options.tabs[0].initial).equal("attributes"),a(e.options.scrollY.length).equal(1),a(e.options.scrollY[0]).equal(".inventory")})),s((async()=>{await Ie(dt)}))})),e("_prepareItems(data)",(()=>{})),e("generateScores()",(()=>{const e={str:0,int:0,dex:0,wis:0,con:0,cha:0};t("renders the character creator",(async()=>{const e=(await be("character",{},dt))?.sheet;e.generateScores(),await le();const t=ce("creator");a(t.length).equal(1);for(const e of t)await e.close()})),t("clicking on the dices generates scores",(async()=>{const t=(await be("character",{},dt))?.sheet;t.generateScores(),await oe(400);const s=ce("creator");a(s.length).equal(1),Object.keys(e).forEach((async e=>{$(`.creator div[data-score="${e}"] a.score-roll`).trigger("click"),await le();const t=document.querySelector(`.creator div[data-score="${e}"] input.score-value`),{value:s}=t;a(parseInt(s,10)>0).equal(!0)}));for(const e of s)await e.close()})),t("saving scores records data to actor",(async()=>{const t=await be("character",{},dt),s=t?.sheet;s.generateScores(),await oe(400);const n=ce("creator");a(n.length).equal(1);for(const t of Object.keys(e)){$(`.creator div[data-score="${t}"] a.score-roll`).trigger("click"),await le();const s=document.querySelector(`.creator div[data-score="${t}"] input.score-value`),{value:n}=s;a(parseInt(n,10)>0).equal(!0),e[t]=parseInt(n,10)}$(".creator footer button").trigger("submit"),await le(),a(t?.system.scores.str.value).equal(e.str),a(t?.system.scores.dex.value).equal(e.dex),a(t?.system.scores.wis.value).equal(e.wis),a(t?.system.scores.int.value).equal(e.int),a(t?.system.scores.con.value).equal(e.con),a(t?.system.scores.cha.value).equal(e.cha)})),n((async()=>{await re(),await oe(300)})),s((async()=>{await Ie(dt)}))})),e("getData()",(()=>{t("returns the expected data",(async()=>{const e=await be("character",{},dt),t=await(e?.sheet?.getData());a(Object.keys(t)).contain("enrichedBiography"),a(Object.keys(t)).contain("enrichedNotes"),a(Object.keys(t)).contain("owned"),a(Object.keys(t?.owned)).contain("weapons"),a(Object.keys(t?.owned)).contain("items"),a(Object.keys(t?.owned)).contain("containers"),a(Object.keys(t?.owned)).contain("armors"),a(Object.keys(t?.owned)).contain("treasures"),a(Object.keys(t)).contain("containers"),a(Object.keys(t)).contain("abilities"),a(Object.keys(t)).contain("spells"),a(Object.keys(t)).contain("slots"),a(Object.keys(t)).contain("system"),a(Object.keys(t?.system)).contain("usesAscendingAC"),a(Object.keys(t?.system)).contain("meleeMod"),a(Object.keys(t?.system)).contain("rangedMod"),a(Object.keys(t?.system)).contain("init")})),s((async()=>{await Ie(dt)}))})),e("_chooseLang()",(()=>{t("renders a dialog",(async()=>{(await be("character",{},dt))?.sheet?._chooseLang(),await le();const e=me();a(e.length).equal(1),e[0].close()})),s((async()=>{await Ie(dt),await ge(),await oe(300)}))})),e("_pushLang(table)",(()=>{const e="languages";t("renders a dialog",(async()=>{(await be("character",{},dt))?.sheet?._pushLang(e),await le();const t=me();a(t.length).equal(1),t[0].close()})),t("adds language on OK",(async()=>{const t=await be("character",{},dt);t?.sheet?._pushLang(e),await oe(220),$('button[data-action="ok"]').trigger("click"),await oe(500);const s=me();a(s.length).equal(0),a(t?.system.languages.value.length).equal(1),a(t?.system.languages.value[0]).equal("Common")})),s((async()=>{await Ie(dt),await ge()}))})),e("_popLang(table, lang)",(()=>{t("can remove added language",(async()=>{const e=await be("character",{},dt);await(e?.update({"system.languages.value":["Common"]})),await le(),a(e?.system.languages.value.length).equal(1),a(e?.system.languages.value[0]).equal("Common"),e?.sheet?._popLang("languages","Common"),await le(),a(e?.system.languages.value.length).equal(0)})),s((async()=>{await Ie(dt)}))})),e("_onShowModifiers(event)",(()=>{t("renders a dialog",(async()=>{const e=await be("character",{},dt);await(e?.update({system:{scores:{str:{value:10},dex:{value:10},int:{value:10},con:{value:10},wis:{value:10},cha:{value:10}}}})),e?.sheet?.render(!0),await le(),$('.sheet .profile a[data-action="modifiers"]').trigger("click"),await oe(200);const t=ue();a(t.length).equal(1)})),s((async()=>{await Ie(dt),await de(),await oe(400)}))})),e("_onShowGpCost(event, preparedData)",(()=>{t("renders a dialog",(async()=>{const e=await be("character",{},dt);await(e?.update({system:{scores:{str:{value:10},dex:{value:10},int:{value:10},con:{value:10},wis:{value:10},cha:{value:10}}}})),e?.sheet?.render(!0),await le(),$('.sheet .profile a[data-action="gp-cost"]').trigger("click"),await oe(200);const t=ue();a(t.length).equal(1)})),s((async()=>{await Ie(dt),await de(),await oe(400)}))})),e("_onShowItemTooltip(event)",(()=>{}))};const ht="ose.actor.sheet.monster",yt={displayName:"OSE: Actor: Sheet: Monster"};var wt=({describe:e,it:t,expect:a,after:s,before:n})=>{const i=game.settings.get(game.system.id,"invertedCtrlBehavior");s((async()=>{await game.settings.set(game.system.id,"invertedCtrlBehavior",i),await Ie(ht),await pe()})),e("defaultOptions()",(()=>{t("Has correctly set defaultOptions",(async()=>{const e=(await be("monster",{},ht))?.sheet;a(e.options.classes).contain("ose"),a(e.options.classes).contain("sheet"),a(e.options.classes).contain("actor"),a(e.options.classes).contain("monster"),a(e.options.template).contain("/templates/actors/monster-sheet.html"),a(e.options.width).equal(450),a(e.options.height).equal(560),a(e.options.resizable).is.true,a(e.options.tabs.length).equal(1),a(Object.keys(e.options.tabs[0])).contain("navSelector"),a(e.options.tabs[0].navSelector).equal(".tabs"),a(Object.keys(e.options.tabs[0])).contain("contentSelector"),a(e.options.tabs[0].contentSelector).equal(".sheet-body"),a(Object.keys(e.options.tabs[0])).contain("initial"),a(e.options.tabs[0].initial).equal("attributes")})),s((async()=>{await Ie(ht)}))})),e("_prepareItems(data)",(()=>{})),e("getData()",(()=>{t("returns the expected data",(async()=>{const e=await be("monster",{},ht),t=await(e?.sheet?.getData());a(Object.keys(t)).contain("owned"),a(Object.keys(t?.owned)).contain("weapons"),a(Object.keys(t?.owned)).contain("items"),a(Object.keys(t?.owned)).contain("containers"),a(Object.keys(t?.owned)).contain("armors"),a(Object.keys(t?.owned)).contain("treasures"),a(Object.keys(t)).contain("attackPatterns"),a(Object.keys(t)).contain("spells"),a(Object.keys(t)).contain("isNew"),a(t?.config.morale).equal(game.settings.get(game.system.id,"morale")),a(Object.keys(t)).contain("system"),a(Object.keys(t?.system)).contain("details"),a(Object.keys(t?.system.details)).contain("treasure"),a(Object.keys(t?.system.details.treasure)).contain("link")})),s((async()=>{await Ie(ht)}))})),e("generateSave()",(()=>{t("renders a dialog",(async()=>{(await be("monster",{},ht))?.sheet?.generateSave(),await le();const e=me();a(e.length).equal(1),e[0].close()})),s((async()=>{await Ie(ht),await ge(),await oe(300)}))})),e("_onDrop(event)",(()=>{s((async()=>{await Ie(ht),game.tables?.filter((e=>"Test RollTable"===e.name)).forEach((e=>e.delete()))})),t("Can drag testing RollTable to Monster",(async()=>{const e=await be("monster",{},ht),t=await(async()=>CONFIG.RollTable.documentClass.create({name:"Test RollTable"}))();e?.sheet?.render(!0),await oe(500);const s=document.querySelector(`#tables li[data-entry-id="${t?.id}"]`),n=document.querySelector(".monster .window-content");a(s).not.null,a(n).not.null;const i=new DragEvent("dragstart",{dataTransfer:new DataTransfer,bubbles:!0,cancelable:!0});s?.dispatchEvent(i),e?.sheet?._onDrop(i),await le(),a(e?.system.details.treasure.table).equal(`@UUID[RollTable.${t?.id}]`)}))})),e("_resetAttacks(event)",(()=>{t("resets the counter to max",(async()=>{const e=await be("monster",{},ht);e?.sheet?.render(!0);const[t]=await fe(e,"weapon");t.update({system:{counter:{max:4,value:1}}}),await oe(400),a(t.system.counter.value).equal(1),$(".item-reset").trigger("click"),await le(),a(t.system.counter.value).equal(4)})),s((async()=>{await Ie(ht)}))})),e("_updateAttackCounter(event)",(()=>{n((()=>{game.settings.set(game.system.id,"invertedCtrlBehavior",!0)})),t("updates counter when rolling",(async()=>{const e=await be("monster",{},ht);e?.sheet?.render(!0);const[t]=await fe(e,"weapon");t.update({system:{counter:{max:4,value:4}}}),await oe(400),a(t.system.counter.value).equal(4),$(`.tab .item[data-item-id="${t.id}"] .item-image`).trigger("click"),await le(),a(t.system.counter.value).equal(3)})),s((async()=>{await Ie(ht)}))})),e("_cycleAttackPatterns(event)",(()=>{const i=Object.keys(CONFIG.OSE.colors);i.push("transparent"),n((async()=>{const e=await be("monster",{},ht);e?.sheet?.render(!0),await fe(e,"weapon"),await oe(300)})),e("properly cycles between colors",(()=>{i.forEach((e=>{t(`works for color ${e}`,(async()=>{const e=(await Oe(ht))?.items.contents[0],t=e?.system.pattern;a(t).not.undefined;const s=i.indexOf(t),n=s+1===i.length?0:s+1;$(".item-pattern").trigger("click"),await oe(200),a(e?.system.pattern).equal(i[n])}))}))})),s((async()=>{await Ie(ht)}))}))};const bt="ose.combat",vt={displayName:"OSE: Combat"};var ft=({describe:e,it:t,expect:a,after:s,afterEach:n,before:i})=>{const o=new ae;let r=null,l=null,c=null,u=null,m=null,d=null,g=null,p=null,h=null,y=null,w=null,b=null,v=null,f=null,q=null,S=null,O=null,k=null,E=null,T=null;const I=async e=>{const t=await e.getTokenDocument();await t.constructor.create(t,{parent:canvas.scene})},C=async()=>{(()=>{const e=game.canvas?.scene?.tokens?.contents||[];0!==e.length&&(e[0].object.control({releaseOthers:!0}),e.slice(1).forEach((e=>{e.object.control({releaseOthers:!1})})))})();const e=canvas.tokens.controlled.map((e=>e.document));await TokenDocument.implementation.createCombatants(e)},A=()=>document.querySelector("#combat ol.combat-tracker"),N=()=>A()?.querySelectorAll("li.combatant"),F=async()=>{await(game.combat?.delete()),await le()};i((async()=>{await re(),await F();const e=await Se();await(e?.activate()),await le();const t=game.users?.find((e=>!e.isGM));r=await be("character",{...t?.id&&{ownership:{[t.id]:foundry.CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER}}},bt),l=await be("character",{...t?.id&&{ownership:{[t.id]:foundry.CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER}}},bt),c=await be("character",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY}},bt),u=await be("character",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY}},bt),m=await be("character",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.NEUTRAL}},bt),d=await be("character",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.NEUTRAL}},bt),g=await be("character",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.HOSTILE}},bt),p=await be("character",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.HOSTILE}},bt),h=await be("monster",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY}},bt),y=await be("monster",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY}},bt),w=await be("monster",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.NEUTRAL}},bt),b=await be("monster",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.NEUTRAL}},bt),v=await be("monster",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.HOSTILE}},bt),f=await be("monster",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.HOSTILE}},bt),q=await be("character",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY},system:{retainer:{enabled:!0}}},bt),S=await be("character",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY},system:{retainer:{enabled:!0}}},bt),O=await be("character",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.NEUTRAL},system:{retainer:{enabled:!0}}},bt),k=await be("character",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.NEUTRAL},system:{retainer:{enabled:!0}}},bt),E=await be("character",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.HOSTILE},system:{retainer:{enabled:!0}}},bt),T=await be("character",{prototypeToken:{disposition:foundry.CONST.TOKEN_DISPOSITIONS.HOSTILE},system:{retainer:{enabled:!0}}},bt),await le()})),s((async()=>{await F(),await Ie(bt),await Ae()})),e("Static properties",(()=>{t("should have the correct initiative formula",(()=>{a(ae.FORMULA).to.equal("1d6 + @init"),a(ae.GROUP_FORMULA).to.equal("1d6")})),t("GROUPS should combine OSE colors with action groups",(()=>{a(ae.GROUPS).to.eql({green:game.i18n.localize("OSE.colors.green"),red:game.i18n.localize("OSE.colors.red"),yellow:game.i18n.localize("OSE.colors.yellow"),purple:game.i18n.localize("OSE.colors.purple"),blue:game.i18n.localize("OSE.colors.blue"),orange:game.i18n.localize("OSE.colors.orange"),white:game.i18n.localize("OSE.colors.white"),slow:game.i18n.localize("OSE.items.Slow"),cast:game.i18n.localize("OSE.spells.Cast")})}))})),e("isGroupInitiative",(()=>{let e;i((async()=>{e=game.settings.get(game.system.id,"initiative"),await game.settings.set(game.system.id,"initiative","group")})),s((async()=>{await game.settings.set(game.system.id,"initiative",e)})),t('should return true when initiative setting is "group"',(()=>{a(game.settings.get(game.system.id,"initiative")).to.equal("group"),a(o.isGroupInitiative).to.be.true})),t('should return false when initiative setting is not "group"',(async()=>{await game.settings.set(game.system.id,"initiative","individual"),a(game.settings.get(game.system.id,"initiative")).to.equal("individual"),a(o.isGroupInitiative).to.be.false}))})),e("mockActors",(async()=>{t("should have created valid actors",(async()=>{a(r?.type).to.equal("character"),a(r?.hasPlayerOwner,"test can only pass if a non-GM user exists on this world").to.be.true,a(l?.type).to.equal("character"),a(l?.hasPlayerOwner,"test can only pass if a non-GM user exists on this world").to.be.true,a(c?.type).to.equal("character"),a(c?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY,"Friendly Character 1 should have friendly disposition"),a(c?.hasPlayerOwner).to.be.false,a(u?.type).to.equal("character"),a(u?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY,"Friendly Character 2 should have friendly disposition"),a(u?.hasPlayerOwner).to.be.false,a(m?.type).to.equal("character"),a(m?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.NEUTRAL,"Neutral Character 1 should have neutral disposition"),a(m?.hasPlayerOwner).to.be.false,a(d?.type).to.equal("character"),a(d?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.NEUTRAL,"Neutral Character 2 should have neutral disposition"),a(d?.hasPlayerOwner).to.be.false,a(g?.type).to.equal("character"),a(g?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.HOSTILE,"Hostile Character 1 should have hostile disposition"),a(g?.hasPlayerOwner).to.be.false,a(p?.type).to.equal("character"),a(p?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.HOSTILE,"Hostile Character 2 should have hostile disposition"),a(p?.hasPlayerOwner).to.be.false,a(h?.type).to.equal("monster"),a(h?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY,"Friendly Monster 1 should have friendly disposition"),a(h?.hasPlayerOwner).to.be.false,a(y?.type).to.equal("monster"),a(y?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY,"Friendly Monster 2 should have friendly disposition"),a(y?.hasPlayerOwner).to.be.false,a(w?.type).to.equal("monster"),a(w?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.NEUTRAL,"Neutral Monster 1 should have neutral disposition"),a(w?.hasPlayerOwner).to.be.false,a(b?.type).to.equal("monster"),a(b?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.NEUTRAL,"Neutral Monster 2 should have neutral disposition"),a(b?.hasPlayerOwner).to.be.false,a(v?.type).to.equal("monster"),a(v?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.HOSTILE,"Hostile Monster 1 should have hostile disposition"),a(v?.hasPlayerOwner).to.be.false,a(f?.type).to.equal("monster"),a(f?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.HOSTILE,"Hostile Monster 2 should have hostile disposition"),a(f?.hasPlayerOwner).to.be.false,a(q?.type).to.equal("character"),a(q?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY,"Friendly Retainer 1 should have friendly disposition"),a(q?.hasPlayerOwner).to.be.false,a(S?.type).to.equal("character"),a(S?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.FRIENDLY,"Friendly Retainer 2 should have friendly disposition"),a(S?.hasPlayerOwner).to.be.false,a(O?.type).to.equal("character"),a(O?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.NEUTRAL,"Neutral Retainer 1 should have neutral disposition"),a(O?.hasPlayerOwner).to.be.false,a(k?.type).to.equal("character"),a(k?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.NEUTRAL,"Neutral Retainer 2 should have neutral disposition"),a(k?.hasPlayerOwner).to.be.false,a(E?.type).to.equal("character"),a(E?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.HOSTILE,"Hostile Retainer 1 should have hostile disposition"),a(E?.hasPlayerOwner).to.be.false,a(T?.type).to.equal("character"),a(T?.prototypeToken?.disposition).to.equal(foundry.CONST.TOKEN_DISPOSITIONS.HOSTILE,"Hostile Retainer 2 should have hostile disposition"),a(T?.hasPlayerOwner).to.be.false,await I(r),await I(l),await I(c),await I(u),await I(m),await I(d),await I(g),await I(p),await I(h),await I(y),await I(w),await I(b),await I(v),await I(f),await I(q),await I(S),await I(O),await I(k),await I(E),await I(T),await le()}))})),e("groupCombat(reroll)",(async()=>{let e,o;i((async()=>{e=game.settings.get(game.system.id,"initiative"),await game.settings.set(game.system.id,"initiative","group"),o=game.settings.get(game.system.id,"rerollInitiative"),await game.settings.set(game.system.id,"rerollInitiative","reroll"),await re()})),s((async()=>{await F(),await game.settings.set(game.system.id,"initiative",e),await game.settings.set(game.system.id,"rerollInitiative",o),await Ie(bt),await le()})),n((async()=>{await re()})),t("should render groups",(async()=>{await C(),await le(),a(game.combat).to.not.be.null,a(game.combat?.combatants?.size).to.equal(20),a(game.combat?.groups?.size).to.equal(3);const e=A();a(e).to.not.be.null,a(e?.children?.length).to.equal(3);for(const t of game.combat.groups.contents){const s=e?.querySelector(`li[data-group-key="${t.name}"]`);a(s).to.not.be.null,a(s?.querySelector("ol.group-children")).to.not.be.null,a(s?.querySelector("ol.group-children")?.children?.length).to.equal(t.members?.size)}})),t("should roll initiative for all groups",(async()=>{a(game.messages.size).to.equal(0);const e=document.querySelector(".combat-tracker-header .combat-control[data-action='smartRerollInitiative']");a(e).to.not.be.null,e?.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0})),await le(),a(game.messages.size).to.equal(3);for(const e of game.combat.groups.contents.map((e=>e.name)))a(game.messages.contents.some((t=>t.flavor.includes(game.i18n.format("OSE.roll.initiative",{group:e}))))).to.be.true;a(game.combat?.groups?.some((e=>null===e.initiative))).to.be.false;const t=A(),s=t?.querySelector("li[data-group-key='green']");a(s).to.not.be.null,a(s?.dataset?.initiative).to.not.be.undefined,a(s?.querySelector(".group-header .create-button")?.textContent).to.equal(s?.dataset?.initiative);const n=t?.querySelector("li[data-group-key='purple']");a(n).to.not.be.null,a(n?.dataset?.initiative).to.not.be.undefined,a(n?.querySelector(".group-header .create-button")?.textContent).to.equal(n?.dataset?.initiative);const i=t?.querySelector("li[data-group-key='red']");a(i).to.not.be.null,a(i?.dataset?.initiative).to.not.be.undefined,a(i?.querySelector(".group-header .create-button")?.textContent).to.equal(i?.dataset?.initiative)})),t("should not reroll initiative for rolled groups on combat start",(async()=>{const e=new Map;for(const t of game.combat?.groups)e.set(t.name,t.initiative);await game.combat.startCombat(),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(1),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(3),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(0),a(game.combat?.groups?.some((t=>t.initiative!==e.get(t.name)))).to.be.false})),t("should roll initiative for unrolled groups on combat start",(async()=>{await F(),await le(),await C(),await le(),a(game.messages.size).to.equal(0),a(game.combat?.groups?.some((e=>null===e.initiative))).to.be.true,await game.combat.startCombat(),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(1),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(3),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(3);for(const e of game.combat.groups.contents.map((e=>e.name)))a(game.messages.contents.some((t=>t.flavor.includes(game.i18n.format("OSE.roll.initiative",{group:e}))))).to.be.true;a(game.combat?.groups?.some((e=>null===e.initiative))).to.be.false;const e=A(),t=e?.querySelector("li[data-group-key='green']");a(t).to.not.be.null,a(t?.dataset?.initiative).to.not.be.undefined,a(t?.querySelector(".group-header .create-button")?.textContent).to.equal(t?.dataset?.initiative);const s=e?.querySelector("li[data-group-key='purple']");a(s).to.not.be.null,a(s?.dataset?.initiative).to.not.be.undefined,a(s?.querySelector(".group-header .create-button")?.textContent).to.equal(s?.dataset?.initiative);const n=e?.querySelector("li[data-group-key='red']");a(n).to.not.be.null,a(n?.dataset?.initiative).to.not.be.undefined,a(n?.querySelector(".group-header .create-button")?.textContent).to.equal(n?.dataset?.initiative)})),t("should mark combatants as active",(async()=>{let e=N();a(e).to.not.be.null,a(e?.length).to.equal(20),a(e?.[0]?.classList.contains("active")).to.be.true,await(game.combat?.nextTurn()),await le(),a(game.combat?.turn).to.equal(1),e=N(),a(e?.[0]?.classList.contains("active")).to.be.false,a(e?.[1]?.classList.contains("active")).to.be.true})),t("should reroll initiative for all groups on new round",(async()=>{await(game?.combat?.nextRound()),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(2),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(3),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(3),a(N()?.[0]?.classList.contains("active")).to.be.true}))})),e("groupCombat(reset)",(async()=>{let e,o;i((async()=>{e=game.settings.get(game.system.id,"initiative"),await game.settings.set(game.system.id,"initiative","group"),o=game.settings.get(game.system.id,"rerollInitiative"),await game.settings.set(game.system.id,"rerollInitiative","reset"),await re()})),s((async()=>{await F(),await game.settings.set(game.system.id,"initiative",e),await game.settings.set(game.system.id,"rerollInitiative",o),await Ie(bt),await le()})),n((async()=>{await re()})),t("should not roll initiative for groups on combat start",(async()=>{await C(),await le(),await game.combat.startCombat(),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(1),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(3),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(0),a(game.combat?.groups?.some((e=>null!==e.initiative))).to.be.false})),t("should mark combatants as active",(async()=>{let e=N();a(e).to.not.be.null,a(e?.length).to.equal(20),a(e?.[0]?.classList.contains("active")).to.be.true,await(game.combat?.nextTurn()),await le(),a(game.combat?.turn).to.equal(1),e=N(),a(e?.[0]?.classList.contains("active")).to.be.false,a(e?.[1]?.classList.contains("active")).to.be.true})),t("should reset initiative for all groups on new round",(async()=>{await(game?.combat?.smartRerollInitiative()),await le(),a(game.messages.size).to.equal(3),a(game.combat?.groups?.some((e=>null===e.initiative))).to.be.false,await(game?.combat?.nextRound()),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(2),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(3),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(3),a(game.combat?.groups?.some((e=>null!==e.initiative))).to.be.false,a(N()?.[0]?.classList.contains("active")).to.be.true}))})),e("groupCombat(keep)",(async()=>{let e,o;i((async()=>{e=game.settings.get(game.system.id,"initiative"),await game.settings.set(game.system.id,"initiative","group"),o=game.settings.get(game.system.id,"rerollInitiative"),await game.settings.set(game.system.id,"rerollInitiative","keep"),await re()})),s((async()=>{await F(),await game.settings.set(game.system.id,"initiative",e),await game.settings.set(game.system.id,"rerollInitiative",o),await Ie(bt),await le()})),n((async()=>{await re()})),t("should roll initiative for all groups on combat start",(async()=>{await C(),await le(),await game.combat.startCombat(),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(1),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(3),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(3),a(game.combat?.groups?.some((e=>null===e.initiative))).to.be.false})),t("should mark combatants as active",(async()=>{let e=N();a(e).to.not.be.null,a(e?.length).to.equal(20),a(e?.[0]?.classList.contains("active")).to.be.true,await(game.combat?.nextTurn()),await le(),a(game.combat?.turn).to.equal(1),e=N(),a(e?.[0]?.classList.contains("active")).to.be.false,a(e?.[1]?.classList.contains("active")).to.be.true})),t("should keep initiative for all groups on new round",(async()=>{a(game.combat?.groups?.some((e=>null===e.initiative))).to.be.false;const e=new Map;for(const t of game.combat?.groups)e.set(t.name,t.initiative);await(game?.combat?.nextRound()),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(2),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(3),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(0),a(game.combat?.groups?.some((t=>t.initiative!==e.get(t.name)))).to.be.false,a(N()?.[0]?.classList.contains("active")).to.be.true}))})),e("individualCombat(reroll)",(async()=>{let e,o;i((async()=>{e=game.settings.get(game.system.id,"initiative"),await game.settings.set(game.system.id,"initiative","individual"),o=game.settings.get(game.system.id,"rerollInitiative"),await game.settings.set(game.system.id,"rerollInitiative","reroll"),await re()})),s((async()=>{await F(),await game.settings.set(game.system.id,"initiative",e),await game.settings.set(game.system.id,"rerollInitiative",o),await Ie(bt),await le()})),n((async()=>{await re()})),t("should not render groups",(async()=>{await C(),await le(),a(game.combat).to.not.be.null,a(game.combat?.combatants?.size).to.equal(20),a(game.combat?.groups?.size).to.equal(0);const e=A();a(e).to.not.be.null,a(e?.children?.length).to.equal(20)})),t("should roll initiative for all combatants",(async()=>{a(game.messages.size).to.equal(0);const e=document.querySelector(".combat-tracker-header .combat-control[data-action='rollAll']");a(e).to.not.be.null,e?.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0})),await le(),a(game.messages.size).to.equal(20);for(const e of game.combat.combatants.contents.map((e=>e.name)))a(game.messages.contents.some((t=>t.flavor.includes(game.i18n.format("OSE.roll.individualInit",{name:e}))))).to.be.true;a(game.combat?.combatants?.some((e=>null===e.initiative))).to.be.false})),t("should not reroll initiative for all combatants on combat start",(async()=>{const e=new Map;for(const t of game.combat?.combatants)e.set(t.id,t.initiative);await game.combat.startCombat(),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(1),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(0),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(0),a(game.combat?.combatants?.some((t=>t.initiative!==e.get(t.id)))).to.be.false})),t("should mark combatants as active",(async()=>{let e=N();a(e).to.not.be.null,a(e?.length).to.equal(20),a(e?.[0]?.classList.contains("active")).to.be.true,await(game.combat?.nextTurn()),await le(),a(game.combat?.turn).to.equal(1),e=N(),a(e?.[0]?.classList.contains("active")).to.be.false,a(e?.[1]?.classList.contains("active")).to.be.true})),t("should reroll initiative for all combatants on new round",(async()=>{await(game?.combat?.nextRound()),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(2),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(0),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(20),a(N()?.[0]?.classList.contains("active")).to.be.true}))})),e("individualCombat(reset)",(async()=>{let e,o;i((async()=>{e=game.settings.get(game.system.id,"initiative"),await game.settings.set(game.system.id,"initiative","individual"),o=game.settings.get(game.system.id,"rerollInitiative"),await game.settings.set(game.system.id,"rerollInitiative","reset"),await re()})),s((async()=>{await F(),await game.settings.set(game.system.id,"initiative",e),await game.settings.set(game.system.id,"rerollInitiative",o),await Ie(bt),await le()})),n((async()=>{await re()})),t("should not roll initiative for all combatants on combat start",(async()=>{await C(),await le(),await game.combat.startCombat(),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(1),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(0),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(0),a(game.combat?.combatants?.some((e=>null!==e.initiative))).to.be.false})),t("should mark combatants as active",(async()=>{let e=N();a(e).to.not.be.null,a(e?.length).to.equal(20),a(e?.[0]?.classList.contains("active")).to.be.true,await(game.combat?.nextTurn()),await le(),a(game.combat?.turn).to.equal(1),e=N(),a(e?.[0]?.classList.contains("active")).to.be.false,a(e?.[1]?.classList.contains("active")).to.be.true})),t("should reset initiative for all combatants on new round",(async()=>{await(game?.combat?.smartRerollInitiative()),await le(),a(game.messages.size).to.equal(20);for(const e of game.combat?.groups)a(e?.initiative).to.not.be.null;await(game?.combat?.nextRound()),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(2),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(0),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(20),a(game.combat?.combatants?.some((e=>null!==e.initiative))).to.be.false,a(N()?.[0]?.classList.contains("active")).to.be.true}))})),e("individualCombat(keep)",(async()=>{let e,o;i((async()=>{e=game.settings.get(game.system.id,"initiative"),await game.settings.set(game.system.id,"initiative","individual"),o=game.settings.get(game.system.id,"rerollInitiative"),await game.settings.set(game.system.id,"rerollInitiative","keep"),await re()})),s((async()=>{await F(),await game.settings.set(game.system.id,"initiative",e),await game.settings.set(game.system.id,"rerollInitiative",o),await Ie(bt),await le()})),n((async()=>{await re()})),t("should roll initiative for all combatants on combat start",(async()=>{await C(),await le(),await game.combat.startCombat(),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(1),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(0),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(20),a(game.combat?.combatants?.some((e=>null===e.initiative))).to.be.false})),t("should mark combatants as active",(async()=>{let e=N();a(e).to.not.be.null,a(e?.length).to.equal(20),a(e?.[0]?.classList.contains("active")).to.be.true,await(game.combat?.nextTurn()),await le(),a(game.combat?.turn).to.equal(1),e=N(),a(e?.[0]?.classList.contains("active")).to.be.false,a(e?.[1]?.classList.contains("active")).to.be.true})),t("should keep initiative for all groups on new round",(async()=>{a(game.combat?.combatants?.some((e=>null===e.initiative))).to.be.false;const e=new Map;for(const t of game.combat?.combatants)e.set(t.id,t.initiative);await(game?.combat?.nextRound()),await le(),a(game.combat?.started).to.be.true,a(game.combat?.round).to.equal(2),a(game.combat?.turn).to.equal(0),a(game.combat?.groups?.size).to.equal(0),a(game.combat?.combatants?.size).to.equal(20),a(game.messages.size).to.equal(0),a(game.combat?.combatants?.some((t=>t.initiative!==e.get(t.id)))).to.be.false,a(N()?.[0]?.classList.contains("active")).to.be.true}))}))};const qt="ose.actor.sheet.character.dialog.modifiers",St={displayName:"OSE: Actor: Dialog Sheet: Character Modifiers"},Ot=async(e,t={})=>be(e,t,qt);var kt=({describe:e,it:t,expect:a,assert:s,after:n})=>{e("defaultOptions()",(()=>{t("Has correctly set defaultOptions",(()=>{const e=new u;a(e.options.id).equal("sheet-modifiers"),a(e.options.classes).contain("ose"),a(e.options.classes).contain("dialog"),a(e.options.classes).contain("modifiers"),a(e.options.template).contain("/templates/actors/dialogs/modifiers-dialog.html"),a(e.options.width).equal(240)}))})),e("title()",(()=>{t("Creates string in dialog window title",(async()=>{const e=await Ot("character");new u(e).render(!0),await le();const t=document.querySelector("div.modifiers .window-title")?.innerHTML;a(typeof t).equal("string");const s=ce("modifiers");a(s.length).equal(1),await s[0].close(),a(ce("modifiers").length).equal(0)}))})),e("getData()",(()=>{t("Returns proper data",(async()=>{const e=await Ot("character"),t=new u(e).getData(),n=Object.keys(t);s(n.length>0),a(n).contain("user")}))})),n((async()=>{await Ie(qt)}))};const Et="ose.actor.sheet.dialog.entity-tweaks",Tt={displayName:"OSE: Actor: Dialog Sheet: Entity Tweaks"},It=async(e,t={})=>be(e,t,Et);var Ct=({describe:e,it:t,expect:a,assert:s,after:n})=>{e("defaultOptions()",(()=>{t("Has correctly set defaultOptions",(()=>{const e=new m;a(e.options.classes).contain("sheet-tweaks"),a(e.options.template).contain("/templates/actors/dialogs/tweaks-dialog.html"),a(e.options.width).equal(380)}))})),e("title()",(()=>{t("Creates string in dialog window title",(async()=>{const e=await It("character");new m(e).render(!0),await le();const t=document.querySelector("div.sheet-tweaks .window-title")?.innerHTML;a(typeof t).equal("string");const s=ce("sheet-tweaks");a(s.length).equal(1),await s[0].close(),a(ce("sheet-tweaks").length).equal(0)}))})),e("getData()",(()=>{t("Returns proper data",(async()=>{const e=await It("character"),t=new m(e).getData(),n=Object.keys(t);s(n.length>=2),a(n).contain("config"),a(n).contain("user"),s(t.isCharacter)}))})),e("_updateObject(event, formData)",(()=>{})),n((async()=>{await Ie(Et)}))};const At={displayName:"OSE: Item: Data Model: Ability"};var Nt=({describe:e,it:t,expect:a})=>{e("manualTags",(()=>{const e=new C;t("By default return empty array",(()=>{a(e.manualTags.length).equal(0)})),t("Can write tags to tags field",(()=>{e.tags=[{title:"title",value:"value"}],a(e.tags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.tags[0].title).equal("title"),a(e.tags[0].value).equal("value"),a(e.tags[0].label).is.undefined})),t("Can retrieve tags",(()=>{a(e.manualTags.length).equal(1),a(e.manualTags[0].title).equal("title"),a(e.manualTags[0].value).equal("value"),a(e.tags[0].label).is.undefined}))})),e("autoTags",(()=>{const e=new C;e.updateSource({blindroll:!1,description:"",pattern:"transparent",requirements:"",roll:"",rollTarget:0,rollType:"result",save:"",tags:[]}),t("By default return tshirt icon",(()=>{a(e.autoTags[0].icon).is.undefined})),t("Requirements create autoTags",(()=>{e.updateSource({requirements:"magic-user,slow"}),a(e.autoTags.length).equal(2),a(Object.keys(e.autoTags[0]).length).equal(1),a(e.autoTags[0].label).equal("magic-user"),a(Object.keys(e.autoTags[1]).length).equal(1),a(e.autoTags[1].label).equal("slow")})),t("Save create autoTags",(()=>{e.updateSource({save:"death"}),a(e.autoTags.length).equal(3),a(Object.keys(e.autoTags[2]).length).equal(2),a(e.autoTags[2].label).equal(game.i18n.localize("OSE.saves.death.long")),a(e.autoTags[2].icon).equal("fa-skull")})),t("Roll create autoTags",(()=>{e.updateSource({roll:"1d20+1"}),a(e.autoTags.length).equal(4),a(Object.keys(e.autoTags[3]).length).equal(2),a(e.autoTags[2].label).equal(`${game.i18n.localize("OSE.items.Roll")} 1d20 + 1 =0`)}))}))};const Ft={displayName:"OSE: Item: Data Model: Armor"};var Dt=({describe:e,it:t,expect:a})=>{e("ArmorTypes",(()=>{const e=A.ArmorTypes;t("Has 4 armor types",(()=>{a(Object.keys(e).length).equal(4)})),t("Has unarmored",(()=>{a(e.unarmored).equal("OSE.armor.unarmored")})),t("Has light",(()=>{a(e.light).equal("OSE.armor.light")})),t("Has heavy",(()=>{a(e.heavy).equal("OSE.armor.heavy")})),t("Has shield",(()=>{a(e.shield).equal("OSE.armor.shield")}))})),e("manualTags",(()=>{const e=new A;t("By default return empty array",(()=>{a(e.manualTags.length).equal(0)})),t("Can write tags to tags field",(()=>{e.tags=[{title:"title",value:"value"}],a(e.tags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.tags[0].title).equal("title"),a(e.tags[0].value).equal("value"),a(e.tags[0].label).is.undefined})),t("Can retrieve tags",(()=>{a(e.manualTags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.manualTags[0].title).equal("title"),a(e.manualTags[0].value).equal("value"),a(e.manualTags[0].label).equal("value")}))})),e("autoTags",(()=>{const e=new A;t("By default return auto-tags",(()=>{a(e.autoTags.length).equal(1),a(Object.keys(e.autoTags[0]).length).equal(2)})),t("By default return light armor",(()=>{a(e.autoTags[0].label).equal("OSE.armor.light")})),t("By default return tshirt icon",(()=>{a(e.autoTags[0].icon).equal("fa-tshirt")}))}))};const Mt={displayName:"OSE: Item: Data Model: Container"};var xt=({describe:e,it:t,expect:a})=>{e("contents()",(()=>{t("Returns null if itemIds is empty Array",(()=>{const e=new N;a(e.contents).is.null}))})),e("totalWeight()",(()=>{t("Returns 0 with no items",(()=>{const e=new N;a(e.totalWeight).equal(0)}))})),e("manualTags()",(()=>{const e=new N;t("By default return empty array",(()=>{a(e.manualTags.length).equal(0)})),t("Can write tags to tags field",(()=>{e.tags=[{value:"value",title:"title"}],a(e.tags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.tags[0].title).equal("title"),a(e.tags[0].value).equal("value"),a(e.tags[0].label).is.undefined})),t("Can retrieve tags",(()=>{a(e.manualTags.length).equal(1),a(e.manualTags[0].title).equal("title"),a(e.manualTags[0].value).equal("value"),a(e.tags[0].label).is.undefined}))})),e("autoTags()",(()=>{const e=new N;t("By default return no auto-tags",(()=>{a(e.autoTags.length).equal(0)})),t("Can create autoTags",(()=>{e.tags=[{value:CONFIG.OSE.tags.blunt}],a(e.tags.length).equal(1),a(e.autoTags[0].label).equal(CONFIG.OSE.tags.blunt),a(e.autoTags[0].icon).equal("fa-hammer-crash"),a(e.autoTags[0].image).equal(`${CONFIG.OSE.assetsPath}/blunt.png`)}))}))};const _t={displayName:"OSE: Item: Data Model: Misc"};var Rt=({describe:e,it:t,expect:a})=>{e("manualTags()",(()=>{const e=new F;t("By default return empty array",(()=>{a(e.manualTags.length).equal(0)})),t("Can write tags to tags field",(()=>{e.tags=[{title:"title",value:"value"}],a(e.tags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.tags[0].title).equal("title"),a(e.tags[0].value).equal("value"),a(e.tags[0].label).is.undefined})),t("Can retrieve tags",(()=>{a(e.manualTags.length).equal(1),a(e.manualTags[0].title).equal("title"),a(e.manualTags[0].value).equal("value"),a(e.tags[0].label).is.undefined}))})),e("autoTags()",(()=>{const e=new F;t("By default return no auto-tags",(()=>{a(e.autoTags.length).equal(0)})),t("Can create autoTags",(()=>{e.tags=[{value:CONFIG.OSE.tags.blunt}],a(e.tags.length).equal(1),a(e.autoTags[0].label).equal(CONFIG.OSE.tags.blunt),a(e.autoTags[0].icon).equal("fa-hammer-crash"),a(e.autoTags[0].image).equal(`${CONFIG.OSE.assetsPath}/blunt.png`)}))}))};const $t={displayName:"OSE: Item: Data Model: Spell"};var zt=({describe:e,it:t,expect:a})=>{e("manualTags()",(()=>{const e=new D;t("By default return empty array",(()=>{a(e.manualTags.length).equal(0)})),t("Can write tags to tags field",(()=>{e.tags=[{title:"title",value:"value"}],a(e.tags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.tags[0].title).equal("title"),a(e.tags[0].value).equal("value"),a(e.tags[0].label).is.undefined})),t("Can retrieve tags",(()=>{a(e.manualTags.length).equal(1),a(e.manualTags[0].title).equal("title"),a(e.manualTags[0].value).equal("value"),a(e.tags[0].label).is.undefined}))})),e("autoTags()",(()=>{const e=new D;t("By default return 3 auto-tags",(()=>{a(e.autoTags.length).equal(3),e.autoTags.forEach((e=>{a(e).not.null,a(e?.label).equal("")}))})),t("Save create autoTags",(()=>{e.save="death",a(e.autoTags.length).equal(4),a(Object.keys(e.autoTags[3]).length).equal(2),a(e.autoTags[3].label).equal(game.i18n.localize("OSE.saves.death.long")),a(e.autoTags[3].icon).equal("fa-skull")})),t("Roll create autoTags",(()=>{e.updateSource({roll:"1d20+1"}),a(e.autoTags.length).equal(4),a(Object.keys(e.autoTags[3]).length).equal(1),a(e.autoTags[3].label).equal(`${game.i18n.localize("OSE.items.Roll")} 1d20 + 1`)}))}))};const Lt={displayName:"OSE: Item: Data Model: Weapon"};var Pt=({describe:e,it:t,expect:a})=>{e("manualTags()",(()=>{const e=new M;t("By default return empty array",(()=>{a(e.manualTags.length).equal(0)})),t("Can write tags to tags field",(()=>{e.tags=[{title:"title",value:"value"}],a(e.tags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.tags[0].title).equal("title"),a(e.tags[0].value).equal("value"),a(e.tags[0].label).is.undefined})),t("Can retrieve tags",(()=>{a(e.manualTags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.manualTags[0].title).equal("title"),a(e.manualTags[0].value).equal("value"),a(e.manualTags[0].label).is.undefined}))})),e("qualities()",(()=>{t("By default returns an array with Melee tag",(()=>{const e=new M;a(e.qualities.length).equal(1),a(e.qualities[0].label).equal("Melee")})),t("Given a manual tag, it returns an array containing said tag",(()=>{const e=new M;e.tags=[{value:"slow",label:"slow"}],a(e.qualities.length).equal(2),a(Object.keys(e.qualities[1]).length).equal(2),a(e.qualities[1].label).equal(e.manualTags[0].label),a(e.qualities[1].value).equal(e.manualTags[0].value)})),t("Given an autoTag, it returns an array containing said autoTag",(()=>{const e=new M;e.slow=!0,a(e.qualities.length).equal(2),a(Object.keys(e.qualities[1]).length).equal(4),a(e.qualities[1].label).equal("Slow"),a(e.qualities[1].title).equal("Slow"),a(e.qualities[1].icon).equal("fa-weight-hanging"),a(e.qualities[1].image).contain("assets/slow.png")}))})),e("autotags()",(()=>{t("Returns a flattened array with damage and autotags",(()=>{const e=new M;a(e.autoTags.length).equal(2),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal("")})),t("Damage is present in flattened array",(()=>{const e=new M;e.damage="1d13",a(e.autoTags.length).equal(2),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal("1d13")})),t("A melee tag is returned as expected",(()=>{const e=new M;e.melee=!0,a(e.autoTags.length).equal(2),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal(""),a(Object.keys(e.autoTags[1]).length).equal(3),a(e.autoTags[1].label).equal("Melee"),a(e.autoTags[1].icon).equal("fa-sword"),a(e.autoTags[1].image).contain("assets/melee.png")})),t("A missile tag is returned as expected",(()=>{const e=new M;e.melee=!1,e.missile=!0,a(e.autoTags.length).equal(3),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal(""),a(Object.keys(e.autoTags[1]).length).equal(3),a(e.autoTags[1].label).equal("Missile"),a(e.autoTags[1].icon).equal("fa-bow-arrow"),a(e.autoTags[1].image).contain("assets/missile.png"),a(Object.keys(e.autoTags[2]).length).equal(2),a(e.autoTags[2].label).equal("0/0/0"),a(e.autoTags[2].icon).equal("fa-bullseye")})),t("A missile tag with ranges is returned as expected",(()=>{const e=new M;e.melee=!1,e.missile=!0,e.range.short=30,e.range.medium=60,e.range.long=90,a(e.autoTags.length).equal(3),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal(""),a(Object.keys(e.autoTags[1]).length).equal(3),a(e.autoTags[1].label).equal("Missile"),a(e.autoTags[1].icon).equal("fa-bow-arrow"),a(e.autoTags[1].image).contain("assets/missile.png"),a(Object.keys(e.autoTags[2]).length).equal(2),a(e.autoTags[2].label).equal("30/60/90"),a(e.autoTags[2].icon).equal("fa-bullseye")})),t("A slow tag is returned as expected",(()=>{const e=new M;e.slow=!0,a(e.autoTags.length).equal(3),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal(""),a(Object.keys(e.autoTags[2]).length).equal(3),a(e.autoTags[2].label).equal("Slow"),a(e.autoTags[2].icon).equal("fa-weight-hanging"),a(e.autoTags[2].image).contain("assets/slow.png")})),t("A save tag is returned as expected",(()=>{const e=new M;e.save="death",a(e.autoTags.length).equal(3),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal(""),a(Object.keys(e.autoTags[2]).length).equal(2),a(e.autoTags[2].label).equal(game.i18n.localize("OSE.saves.death.long")),a(e.autoTags[2].icon).equal("fa-skull")}))}))};const Bt={displayName:"OSE: Item: Entity"},jt=async(e={})=>be("character",e,"ose.item.entity");var Ht=({describe:e,it:t,expect:a,after:s,beforeEach:n,assert:i})=>{const o=new Set(["spell","ability","armor","weapon","item","container"]),{defaultIcons:r}=O;s((async()=>{Ce()})),e("defaultIcons()",(()=>{t("There are 6 default icons",(()=>a(Object.keys(r).length).equal(6))),o.forEach((e=>{t(`Has ${e} icon`,(()=>a(r[e]).is.not.undefined))})),t("Asking for other items return null",(()=>a(r.non_existing).is.undefined))})),e("create()",(()=>{const e=async e=>{const t=await ve(e);a(t).is.not.undefined,a(t?.img).equals(r[e]);const s=t?.name;await(t?.delete()),a(game.items?.find((e=>e.name===s))).is.undefined};t("Can create weapon OseItem",(async()=>{await e("weapon")})),t("Can create armor OseItem",(async()=>{await e("armor")})),t("Can create item OseItem",(async()=>{await e("item")})),t("Can create spell OseItem",(async()=>{await e("spell")})),t("Can create ability OseItem",(async()=>{await e("ability")})),t("Can create container OseItem",(async()=>{await e("container")})),t("Can't create without name",(async()=>{const e=await O.create({type:"container"});await a(e).is.undefined,a(he().map((e=>e?.textContent?.trim()))).to.be.an("array").that.includes("OseItem validation errors:\n  name: may not be undefined"),await(ui.notifications?.clear())})),t("Can't create without type",(async()=>{const e=await O.create({name:"Test Item"});await a(e).is.undefined,a(he().map((e=>e?.textContent?.trim()))).to.be.an("array").that.includes("OseItem validation errors:\n  type: may not be undefined"),await(ui.notifications?.clear())})),t("Can't create without acceptable type",(async()=>{const e=await O.create({name:"Test Item",type:"TEST"});await a(e).is.undefined,a(he().map((e=>e?.textContent?.trim()))).to.be.an("array").that.includes('OseItem validation errors:\n  type: "TEST" is not a valid type for the Item Document class'),await(ui.notifications?.clear())}))})),e("prepareData()",(()=>{})),e("prepareDerivedData()",(()=>{t("has the expected fields",(async()=>{const e=await ve("weapon");a(e?.system.enrichedDescription).not.undefined,await(e?.delete())}))})),e("chatListeners(html)",(()=>{t("Correctly binds _onChatCardAction to element",(()=>{})),t("Correctly binds _onChatCardToggleContent to element",(()=>{}))})),e("getChatData(htmlOptions)",(()=>{t("Weapon with tags correctly stored in item.system.properties",(()=>{})),t("Spell stores class, level, range, and duration in item.system.properties",(()=>{})),t('Equipped item stores "Equipped" in item.system.properties',(()=>{})),t("Properly returns itemData",(()=>{}))})),e("rollWeapon(options)",(()=>{t("Actor with melee & missile weapon renders dialog",(async()=>{const e=await jt();await fe(e,"weapon");const t=e?.items.contents[0];await(t?.update({system:{melee:!0,missile:!0}}));const s=t.rollWeapon();await le(),await e.delete(),a(me().length).equal(1),i(s),await ge(),await le(),await le(),await le(),a(me().length).equal(0)})),t("Actor with weapon with ",(async()=>{const e=await jt();await fe(e,"weapon");const t=e?.items.contents[0];await(t?.update({system:{missile:!0,melee:!1}}));const a=t.rollWeapon();await e.delete(),i(a)}))})),e("rollFormula(options)",(()=>{t("Missing item.system.roll throws error",(async()=>{const e=await ve("item");try{await e.rollFormula()}catch(e){a(e.name).equal("Error")}})),t("Casting a spell trigger a dialog",(async()=>{const e=await ve("spell");await e.update({system:{roll:"1d20+12"}}),await e.rollFormula(),await le(),await le(),await le(),a(me().length).equal(1),await ge(),await re()})),t("A OseDice.Roll is returned from method",(async()=>{const e=await ve("spell");await e.update({system:{roll:"1d20+12"}});const t=await e.rollFormula();i(t instanceof Roll)}))})),e("spendSpell()",(()=>{t("Calling using non-spell item throws an error",(async()=>{const e=await ve("weapon");try{await e.spendSpell()}catch(e){a(e.name).equal("Error")}})),t("Calling function reduces item.system.cast by one",(async()=>{const e=await ve("spell");await e.update({system:{cast:3}}),await e.spendSpell(),a(e?.system?.cast).equal(2)}))})),e("_getRollTag(data)",(()=>{t("Data provided without a roll key returns void",(async()=>{const e=(await ve("weapon"))._getRollTag({});a(e).to.be.undefined})),t("Returns ab object with value containing roll-info",(async()=>{const e=(await ve("weapon"))._getRollTag({roll:"1d12+4"});a(e).not.to.be.undefined,a(e?.label).equal("Roll 1d12+4")}))})),e("_getSaveTag(data)",(()=>{t("Data provided without a save key returns void",(async()=>{const e=(await ve("weapon"))._getSaveTag({});a(e).to.be.undefined})),t("Returns an object with two keys; label and icon",(async()=>{const e=(await ve("weapon"))._getSaveTag({save:"death"});a(e).not.to.be.undefined,a(e?.label).equal("Death Poison"),a(e?.icon).equal("fa-skull")}))})),e("pushManualTag(values)",(()=>{const e=async(e,t,s)=>{a(e?.system?.tags.length).equal(0),await(e?.pushManualTag([t])),a(e?.system?.tags.length).equal(1);const n=e?.system?.tags?.pop();a(n.label).equal(s.label),a(n.title).equal(s.title),a(n.value).equal(s.value)},s=async(e,t)=>{a(e?.system?.tags.length).equal(0),await(e?.pushManualTag([t]))},n=(e,t)=>{a(e.system.melee).equal(t.melee),a(e.system.slow).equal(t.slow),a(e.system.missile).equal(t.missile)};t("Provided value without () adds value to all keys",(async()=>{const t=await ve("weapon");await e(t,"test",{label:"test",title:"test",value:"test"}),t.delete()})),t("Provided values have tags within () added to array as title",(async()=>{const t=await ve("weapon");await e(t,"test (test2)",{label:"test",title:"test2",value:"test"}),t.delete()})),t("Weapons are automatically melee",(async()=>{const e=await ve("weapon");n(e,{melee:!0,slow:!1,missile:!1}),await(e?.delete())}));new Set([CONFIG.OSE.tags.melee,CONFIG.OSE.tags.slow,CONFIG.OSE.tags.missile]).forEach((a=>{t(`"${a}" tag activates the boolean but not a tag`,(async()=>{const e=await ve("weapon");await s(e,a),n(e,{melee:!0,slow:a===CONFIG.OSE.tags.slow,missile:a===CONFIG.OSE.tags.missile}),e.delete()})),t(`"${a.toUpperCase()}" tag activates the boolean but not a tag`,(async()=>{const e=await ve("weapon");await s(e,a.toUpperCase()),n(e,{melee:!0,slow:a.toLowerCase()===CONFIG.OSE.tags.slow.toLowerCase(),missile:a.toLowerCase()===CONFIG.OSE.tags.missile.toLowerCase()}),e.delete()})),t(`"Test (${a})" tags activates the boolean and adds a tag`,(async()=>{const t=await ve("weapon");await e(t,`Test (${a})`,{label:"Test",title:a,value:"Test"}),n(t,{melee:!0,slow:a===CONFIG.OSE.tags.slow,missile:a===CONFIG.OSE.tags.missile}),t.delete()})),t(`"Test (${a.toUpperCase()})" tags activates the boolean and adds a tag`,(async()=>{const t=await ve("weapon");await e(t,`Test (${a.toUpperCase()})`,{label:"Test",title:a.toUpperCase(),value:"Test"}),n(t,{melee:!0,slow:a.toLowerCase()===CONFIG.OSE.tags.slow.toLowerCase(),missile:a.toLowerCase()===CONFIG.OSE.tags.missile.toLowerCase()}),t.delete()}))}))})),e("popManualTag(value)",(()=>{t("Item without system.tags return undefined",(async()=>{const e=await ve("weapon");a(e.system.tags.length).equal(0);const t=await e.popManualTag("test");a(t).equal(void 0)})),t("Tags matching input value are removed from item.system.tags",(async()=>{const e=await ve("weapon");a(e.system.tags.length).equal(0),await e.pushManualTag(["test","test2"]),a(e.system.tags.length).equal(2),await e.popManualTag("test"),a(e.system.tags.length).equal(1),a(e.system.tags.pop().title).equal("test2")}))})),e("getAutoTagList()",(()=>{t("Container does nothing",(async()=>{const e=await ve("container"),t=e.getAutoTagList();a(t.length).equal(0),e.delete()})),t("Item does nothing",(async()=>{const e=await ve("item"),t=e.getAutoTagList();a(t.length).equal(0),e.delete()})),t("Weapon has damage label applied",(async()=>{const e=await ve("weapon"),t=e.getAutoTagList();a(t.length).equal(1),a(t[0].icon).equal("fa-tint"),a(t[0].label).equal("1d6"),e.delete()})),t("Missile weapon has ranges applied",(async()=>{const e=await ve("weapon");await e.pushManualTag([CONFIG.OSE.tags.missile]),i(e.system.missile);const t=e.getAutoTagList();a(t.length).equal(2),a(t[0].icon).equal("fa-tint"),a(t[0].label).equal("1d6"),a(t[1].icon).equal("fa-bullseye"),a(t[1].label).equal("0/0/0"),e.delete()})),t("Manual weapon tags are applied",(async()=>{const e=await ve("weapon");await e.pushManualTag(["Test"]);const t=e.getAutoTagList();a(t.length).equal(2),a(t[0].icon).equal("fa-tint"),a(t[0].label).equal("1d6"),a(t[1].label).equal("Test"),e.delete()})),t("Default Armor has armor type applied",(async()=>{const e=await ve("armor"),t=e.getAutoTagList();a(t.length).equal(1),a(t[0].icon).equal("fa-tshirt"),a(t[0].label).equal("Light"),e.delete()})),t("Heavy Armor has armor type applied",(async()=>{const e=await ve("armor");await e.update({system:{type:"heavy"}});const t=e.getAutoTagList();a(t.length).equal(1),a(t[0].icon).equal("fa-tshirt"),a(t[0].label).equal("Heavy"),e.delete()})),t("Spells have class, range, and duration applied",(async()=>{const e=await ve("spell"),t=e.getAutoTagList();a(t.length).equal(3),a(t[0].label).equal("Magic-User"),a(t[1].label).equal(""),a(t[2].label).equal(""),e.delete()})),t("Abilities have requirements applied",(async()=>{const e=await ve("ability");await e.update({system:{requirements:"alice,bob"}});const t=e.getAutoTagList();a(t.length).equal(2),a(t[0].label).equal("alice"),a(t[1].label).equal("bob"),e.delete()})),t("If rollTag exists, it is applied",(async()=>{const e=await ve("spell");await e.update({system:{roll:"1d20+12"}});const t=e.getAutoTagList();a(t.length).equal(4),a(t[3].label).equal("Roll 1d20+12"),e.delete()})),t("If saveTag exists, it is applied",(async()=>{const e=await ve("spell");await e.update({system:{save:"death"}});const t=e.getAutoTagList();a(t.length).equal(4),a(t[3].label).equal("Death Poison"),a(t[3].icon).equal("fa-skull"),e.delete()}))})),e("roll(options)",(()=>{t("Item of weapon type activates rollWeapon",(async()=>{})),t("Item of spell type activates spendSpell",(()=>{})),t("Item of ability type activates rollFormula if it has associated item.system.roll",(()=>{})),t("Item of ability type shows chat card if no item.system.roll associated",(()=>{})),t("Item of item type shows chat card",(()=>{})),t("Item of armor type shows chat card",(()=>{}))})),e("show()",(()=>{n((async()=>{await re()})),s((async()=>{game.items?.filter((e=>e?.name?.indexOf("Test Weapon Item ")>=0||!1)).forEach((async e=>e.delete())),await re()}));const e=async e=>{i(["publicroll","gmroll","blindroll","selfroll"].includes(e)),a(game.messages?.size).equal(0),game.settings.set("core","rollMode",e),a(game.settings.get("core","rollMode")).equal(e);const t=await ve("weapon");await(t?.show()),a(game.messages?.size).equal(1);const s=game.messages?.contents.pop();a(s?.blind).equal("blindroll"===e),a(s?.style).equal(0),"publicroll"===e?a(s?.whisper?.length).equal(0):s?.whisper?.forEach((e=>{i(game.users?.find((t=>t._id===e))?.isGM)})),await(t?.delete())};t("Private GM Roll whispers chat message to GM",(async()=>{await e("gmroll")})),t("Blindroll whispers chat message to GM and is blind",(async()=>{await e("blindroll")})),t("Selfroll whispers chat message to user",(async()=>{await e("selfroll")})),t("Public messages is not a whisper and is not blind",(async()=>{await e("publicroll")}))})),e("_onChatCardToggleContent(event)",(()=>{})),e("_onChatCardAction(event)",(()=>{})),e("_getChatCardActor(card)",(()=>{t("Returns actor if tokenId is properly set",(()=>{})),t("Returns actor if actorId is properly set",(()=>{})),t("Returns null if neither tokenId nor actorId is properly set",(()=>{}))})),e("_getChatCardTargets(card)",(()=>{}))};const Gt={displayName:"OSE: Item: Sheet"};var Wt=({describe:e,it:t,expect:a,after:s,assert:n})=>{s((()=>{Ce()})),e("defaultOptions() ",(()=>{t("Has correctly set defaultOptions",(async()=>{const e=(await ve("item"))?.sheet;a(e).is.not.undefined,a(e?.options.classes.length).to.be.above(3),a(e?.options.classes).contain("ose"),a(e?.options.classes).contain("sheet"),a(e?.options.classes).contain("item"),a(e?.options.width).equal(520),a(e?.options.height).equal(390),n(e?.options.resizable),a(e?.options.tabs.length).equal(1),a(Object.keys(e?.options.tabs[0]).length).equal(4),a(Object.keys(e?.options.tabs[0])).contain("callback"),a(typeof e?.options.tabs[0].callback).equal("function"),a(e?.options.tabs[0].callback.name).contain("_onChangeTab"),a(Object.keys(e?.options.tabs[0])).contain("navSelector"),a(e?.options.tabs[0].navSelector).equal(".tabs"),a(Object.keys(e?.options.tabs[0])).contain("contentSelector"),a(e?.options.tabs[0].contentSelector).equal(".sheet-body"),a(Object.keys(e?.options.tabs[0])).contain("initial"),a(e?.options.tabs[0].initial).equal("description")}))})),e("template()",(()=>{t("Returns html path",(async()=>{const e=(await ve("item"))?.sheet;a(e).is.not.undefined,a(e?.template).contain("templates/items"),a(e?.template).contain("-sheet.html")}))})),e("getData()",(()=>{t("Returns data",(async()=>{const e=(await ve("item"))?.sheet;a(e).is.not.undefined;const t=await(e?.getData());a(Object.keys(t)).contain("_id"),a(Object.keys(t)).contain("editable"),a(Object.keys(t)).contain("config"),a(Object.keys(t)).contain("enriched")}))}))};const Ut="ose.party.entity",Kt={displayName:"OSE: Party: Entity"};var Vt=({describe:e,it:t,expect:a,assert:s,after:n})=>{e("currentParty()",(()=>{t("Returns all characters in a party",(async()=>{const e=await(async(e,t={})=>be(e,t,Ut))("character"),t=new X,n=await t._addActorToParty(e);a(n).is.undefined,s(e?.getFlag(game.system.id,"party"));const i=K,o=game.actors?.filter((e=>e.flags[game.system.id]?.party));a(i.currentParty.length).equal(o?.length),await(e?.delete())}))})),n((async()=>{await Ie(Ut)}))};const Yt="ose.party.sheet",Xt={displayName:"OSE: Party: Sheet"},Qt=async(e,t={})=>be(e,t,Yt);var Jt=({describe:e,it:t,expect:a,assert:s,after:n})=>{e("defaultOptions()",(()=>{t("Has correctly set defaultOptions",(()=>{const e=new X;a(e.options.classes).contain("ose"),a(e.options.classes).contain("dialog"),a(e.options.classes).contain("party-sheet"),a(e.options.template).contain("/templates/apps/party-sheet.html"),a(e.options.width).equal(280),a(e.options.height).equal(400),s(e.options.resizable),a(e.options.dragDrop[0].dragSelector).equal(".actor-list .actor"),a(e.options.dragDrop[0].dropSelector).equal(".party-members"),s(!e.options.closeOnSubmit)}))})),e("init()",(()=>{})),e("showPartySheet(options = {})",(()=>{t("Can render party sheet",(async()=>{X.showPartySheet(),await le();const e=ce("party-sheet");a(e.length).equal(1),a(e[0].options.classes).contain("party-sheet"),await e[0].close(),a(ce("party-sheet").length).equal(0)}))})),e("partySheet()",(()=>{t("Returns a partysheet",(()=>{const{partySheet:e}=X;a(e).is.not.undefined,a(e?.options.classes).contain("party-sheet")}))})),e("title()",(()=>{t("Creates string in dialog window title",(async()=>{X.showPartySheet(),await le();const e=document.querySelector("div.party-sheet .window-title")?.innerHTML;a(typeof e).equal("string");const t=ce("party-sheet");a(t.length).equal(1),await t[0].close(),a(ce("party-sheet").length).equal(0)}))})),e("getData()",(()=>{t("Returns proper data",(()=>{const e=(new X).getData(),t=Object.keys(e);a(t.length).equal(4),a(t).contain("partyActors"),a(t).contain("config"),a(t).contain("user"),a(t).contain("settings")}))})),e("_addActorToParty(actor)",(()=>{t("Monster returns undefined",(async()=>{const e=await Qt("monster"),t=new X,s=await t._addActorToParty(e);a(s).is.undefined,await e.delete()})),t("Adding a character updates the actor",(async()=>{const e=await Qt("character"),t=new X,n=await t._addActorToParty(e);a(n).is.undefined,await le(),s(e?.getFlag(game.system.id,"party")),await e.delete()}))})),e("_removeActorFromParty(actor)",(async()=>{t("Removing a character updates the actor flags",(async()=>{const e=await Qt("character"),t=new X,n=await t._addActorToParty(e);a(n).is.undefined,await le(),s(e?.getFlag(game.system.id,"party"));const i=await t._removeActorFromParty(e);a(i).is.undefined,await le(),s(!e?.getFlag(game.system.id,"party")),await e.delete()}))})),e("_onDrop(event)",(()=>{})),e("_onDropActor(event, data)",(()=>{t("Dropping a non-actor type returns nothing",(async()=>{const e=new X,t=await e._onDropActor("",{type:"not-actor"});a(t).is.undefined})),t("Dropping an actor type updates the actor",(async()=>{const e=await Qt("character"),t={type:e?.documentName,uuid:e?.uuid},n=new X,i=await n._onDropActor("",t);await le(),a(i).is.undefined,s(e?.getFlag(game.system.id,"party")),await(e?.delete())}))})),e("_recursiveAddFolder(folder)",(()=>{t("Folder of actors add actors to party",(async()=>{const e=new X,t=await Folder.create({name:`Test Folder ${Yt}`,type:"Actor"});let n=await Qt("character");n=await(n?.update({folder:t?._id})),a(n?.folder).equal(t),e._recursiveAddFolder(t),await le(),s(n?.getFlag(game.system.id,"party")),await(n?.delete()),await(t?.delete())})),t("Folder with sub-folders of actors add actors to party",(async()=>{const e=new X,t=await Folder.create({name:`Test Folder ${Yt}`,type:"Actor"}),n=await Folder.create({name:`Test Folder ${Yt} subfolder`,type:"Actor",folder:t._id}),i=await Qt("character");await(i?.update({folder:n?._id})),a(i?.folder).equal(n),e._recursiveAddFolder(t),await le(),s(i?.getFlag(game.system.id,"party")),await(i?.delete())}))})),e("_onDropFolder(event, data)",(()=>{t("Dropping with documentName that is not Actor returns undefined",(async()=>{const e=new X,t=await e._onDropFolder("",{documentName:"Not-Actor"});a(t).is.undefined})),t("Dropping a folder with an actor in it adds it to the party",(async()=>{const e=new X,t=await Folder.create({name:`Test Folder ${Yt}`,type:"Actor"});let n=await Qt("character");n=await(n?.update({folder:t?._id})),a(n?.folder).equal(t),await e._onDropFolder("",t),await le(),s(n?.getFlag(game.system.id,"party")),await(n?.delete()),await(t?.delete())}))})),e("_onDragStart(event)",(()=>{})),e("_dealXP(event)",(()=>{})),n((async()=>{Ie(Yt),game.folders?.contents?.filter((e=>e.name?.includes(`Test Folder ${Yt}`)))?.forEach((e=>e.delete()))}))};const Zt={displayName:"OSE: Party XP: Sheet"};var ea=({describe:e,it:t,expect:a,assert:s})=>{e("defaultOptions()",(()=>{t("Has correctly set defaultOptions",(()=>{const e=new V;a(e.options.classes).contain("ose"),a(e.options.classes).contain("dialog"),a(e.options.classes).contain("party-xp"),a(e.options.template).contain("/templates/apps/party-xp.html"),a(e.options.width).equal(300),a(e.options.height).equal("auto"),s(!e.options.resizable),s(e.options.closeOnSubmit)}))})),e("title()",(()=>{t("Creates string in dialog window title",(async()=>{(new V).render(!0),await le();const e=document.querySelector("div.party-xp .window-title")?.innerHTML;a(typeof e).equal("string");const t=ce("party-xp");a(t.length).equal(1),await t[0].close(),a(ce("party-xp").length).equal(0)}))})),e("getData()",(()=>{t("Returns proper data",(()=>{const e=(new V).getData(),t=Object.keys(e);a(t.length).equal(5),a(t).contain("actors"),a(t).contain("data"),a(t).contain("config"),a(t).contain("user"),a(t).contain("settings")}))})),e("_onDrop(event)",(()=>{})),e("_updateObject(event)",(()=>{})),e("_calculateShare()",(()=>{})),e("_dealXP(event)",(()=>{}))};const ta={displayName:"OSE: Helpers: Behaviour"};var aa=({describe:e,it:t,before:a,after:s,assert:n})=>{e("skipRollDialogCheck(event)",(()=>{const i=game.settings.get(game.system.id,"invertedCtrlBehavior");e("invertedCtrlBehavior is set to false",(()=>{a((async()=>{await game.settings.set(game.system.id,"invertedCtrlBehavior",!1)})),t("Setting is false",(async()=>{const e=await game.settings.get(game.system.id,"invertedCtrlBehavior");n(!e)})),t("Not holding ctrl should not skip dialog",(()=>{const e=new KeyboardEvent("keydown",{ctrlKey:!1});n(!d(e))})),t("Not holding meta should not skip dialog",(()=>{const e=new KeyboardEvent("keydown",{metaKey:!1});n(!d(e))})),t("Holding ctrl should not skip dialog",(()=>{const e=new KeyboardEvent("keydown",{ctrlKey:!0});n(d(e))})),t("Holding meta should not skip dialog",(()=>{const e=new KeyboardEvent("keydown",{metaKey:!0});n(d(e))}))})),e("invertedCtrlBehavior is set to true",(()=>{a((async()=>{await game.settings.set(game.system.id,"invertedCtrlBehavior",!0)})),t("Setting is false",(async()=>{const e=await game.settings.get(game.system.id,"invertedCtrlBehavior");n(e)})),t("Not holding ctrl should skip dialog",(()=>{const e=new KeyboardEvent("keydown",{ctrlKey:!1});n(d(e))})),t("Not holding meta should skip dialog",(()=>{const e=new KeyboardEvent("keydown",{ctrlKey:!1});n(d(e))})),t("Holding ctrl should not skip dialog",(()=>{const e=new KeyboardEvent("keydown",{ctrlKey:!0});n(!d(e))})),t("Holding meta should not skip dialog",(()=>{const e=new KeyboardEvent("keydown",{metaKey:!0});n(!d(e))}))})),s((async()=>{await game.settings.set(game.system.id,"invertedCtrlBehavior",i)}))}))};const sa={displayName:"OSE: Helpers: Chat"};var na=({describe:e,it:t,before:a,after:s,expect:n})=>{e("applyChatCardDamage(roll, multiplier)",(()=>{})),e("addChatMessageContextOptions(_, options)",(()=>{})),e("addChatMessageButtons(msg. html)",(()=>{}))};const ia={displayName:"OSE: Helpers: Dice"},oa=(e,t=[e])=>{const a=[];return t.forEach((e=>{a.push({result:e})})),{terms:[{results:a}],total:e}};var ra=({describe:e,it:t,after:a,afterEach:s,before:n,expect:i})=>{const o=game.settings.get(game.system.id,"ascendingAC");n((async()=>{await(ui.notifications?.clear())})),a((async()=>{game.settings.set(game.system.id,"ascendingAC",o),await(ui.notifications?.clear())})),e("sendRoll(parts, data, title, flavor, speaker, form, chatMessage)",(()=>{n((async()=>{await re()})),t("Can roll with single part",(async()=>{const e=await r.sendRoll({parts:["1d10"],data:{roll:{blindroll:!1}}});await le(),await le();const t=document.querySelector(".chat-message .dice-formula")?.innerHTML;i(Object.keys(e)).contain("_evaluated"),i(e._evaluated).equal(!0),i(Object.keys(e)).contain("_formula"),i(e._formula).equal("1d10"),i(t).equal("1d10")})),t("Can roll with multiple parts",(async()=>{const e=await r.sendRoll({parts:["1d10","1d20"],data:{roll:{blindroll:!1}}});await le(),await le();const t=document.querySelector(".chat-message .dice-formula")?.innerHTML;i(Object.keys(e)).contain("_evaluated"),i(e._evaluated).equal(!0),i(Object.keys(e)).contain("_formula"),i(e._formula).equal("1d10 + 1d20"),i(t).equal("1d10 + 1d20")})),s((async()=>{await re()}))})),e("digestResult(data, roll)",(()=>{const a=(e,t,a=0)=>({roll:{type:e,target:t,thac0:a}});e("result type",(()=>{const e=a("result",10);t("Successful roll hitting target",(()=>{const t=oa(10);i(r.digestResult(e,t).isSuccess).equal(!0),i(r.digestResult(e,t).isFailure).equal(!1)})),t("Unsuccessful roll under",(()=>{const t=oa(9);i(r.digestResult(e,t).isSuccess).equal(!1),i(r.digestResult(e,t).isFailure).equal(!0)})),t("Unsuccessful roll over",(()=>{const t=oa(11);i(r.digestResult(e,t).isSuccess).equal(!1),i(r.digestResult(e,t).isFailure).equal(!0)}))})),e("above type",(()=>{const e=a("above",10);t("Successful roll hitting target",(()=>{const t=oa(10);i(r.digestResult(e,t).isSuccess).equal(!0),i(r.digestResult(e,t).isFailure).equal(!1)})),t("Unsuccessful roll under",(()=>{const t=oa(9);i(r.digestResult(e,t).isSuccess).equal(!1),i(r.digestResult(e,t).isFailure).equal(!0)})),t("Successful roll over",(()=>{const t=oa(11);i(r.digestResult(e,t).isSuccess).equal(!0),i(r.digestResult(e,t).isFailure).equal(!1)}))})),e("below type",(()=>{const e=a("below",10);t("Successful roll hitting target",(()=>{const t=oa(10);i(r.digestResult(e,t).isSuccess).equal(!0),i(r.digestResult(e,t).isFailure).equal(!1)})),t("Successful roll under",(()=>{const t=oa(9);i(r.digestResult(e,t).isSuccess).equal(!0),i(r.digestResult(e,t).isFailure).equal(!1)})),t("Unsuccessful roll over",(()=>{const t=oa(11);i(r.digestResult(e,t).isSuccess).equal(!1),i(r.digestResult(e,t).isFailure).equal(!0)}))})),e("check type",(()=>{const e=a("check",10);t("Successful roll on a nat 1",(()=>{const t=oa(1);i(r.digestResult(e,t).isSuccess).equal(!0),i(r.digestResult(e,t).isFailure).equal(!1)})),t("Unsuccessful roll on a nat 20",(()=>{const e=a("check",20),t=oa(20);i(r.digestResult(e,t).isSuccess).equal(!1),i(r.digestResult(e,t).isFailure).equal(!0)})),t("Successful roll hitting target",(()=>{const t=oa(10);i(r.digestResult(e,t).isSuccess).equal(!0),i(r.digestResult(e,t).isFailure).equal(!1)})),t("Successful roll under",(()=>{const t=oa(9);i(r.digestResult(e,t).isSuccess).equal(!0),i(r.digestResult(e,t).isFailure).equal(!1)})),t("Unsuccessful roll over",(()=>{const t=oa(11);i(r.digestResult(e,t).isSuccess).equal(!1),i(r.digestResult(e,t).isFailure).equal(!0)}))})),e("table type",(()=>{const e={roll:{type:"table",target:10,table:{9:"Success",10:"Failure"}}};t("Successful roll hitting target",(()=>{const t=oa(9);i(r.digestResult(e,t).isSuccess).equal(!1),i(r.digestResult(e,t).isSuccess).equal(!1),i(r.digestResult(e,t).details).equal("Success")})),t("Successful roll under",(()=>{const t=oa(10);i(r.digestResult(e,t).isSuccess).equal(!1),i(r.digestResult(e,t).isSuccess).equal(!1),i(r.digestResult(e,t).details).equal("Failure")}))})),e("unknown type",(()=>{const e=a("unknown",10);t("Returns default result",(()=>{const t=oa(4);i(r.digestResult(e,t).isSuccess).equal(!1),i(r.digestResult(e,t).isSuccess).equal(!1),i(r.digestResult(e,t).target).equal(10),i(r.digestResult(e,t).total).equal(4)}))}))})),e("attackIsSuccess(roll, target, bonus)",(()=>{e("Ascending AC",(()=>{n((async()=>{await game.settings.set(game.system.id,"ascendingAC",!0)})),t("Natural 1 always fails",(()=>{const e=oa(1,[1]);i(r.attackIsSuccess(e,100,0)).equal(!1);const t=oa(20,[1]);i(r.attackIsSuccess(t,100,0)).equal(!1)})),t("Natural 20 always succeeds",(()=>{const e=oa(1,[20]);i(r.attackIsSuccess(e,0,100)).equal(!0);const t=oa(20,[20]);i(r.attackIsSuccess(t,0,100)).equal(!0)})),t("Roll + bonus equal target is successful",(()=>{const e=oa(10);i(r.attackIsSuccess(e,20,10)).equal(!0)})),t("Roll + bonus above target is successful",(()=>{const e=oa(10);i(r.attackIsSuccess(e,19,10)).equal(!0)})),t("Roll + bonus under target is unsuccessful",(()=>{const e=oa(10);i(r.attackIsSuccess(e,21,10)).equal(!1)}))})),e("Descending AC",(()=>{n((async()=>{await game.settings.set(game.system.id,"ascendingAC",!1)})),t("Natural 1 always fails",(()=>{const e=oa(1,[1]);i(r.attackIsSuccess(e,100,0)).equal(!1);const t=oa(20,[1]);i(r.attackIsSuccess(t,100,0)).equal(!1)})),t("Natural 20 always succeeds",(()=>{const e=oa(1,[20]);i(r.attackIsSuccess(e,0,100)).equal(!0);const t=oa(20,[20]);i(r.attackIsSuccess(t,0,100)).equal(!0)})),t("Roll + ac equal thac0 is successful",(()=>{const e=oa(10);i(r.attackIsSuccess(e,20,10)).equal(!0)})),t("Roll + ac above thac0 is successful",(()=>{const e=oa(10);i(r.attackIsSuccess(e,19,10)).equal(!0)})),t("Roll + ac under thac0 is unsuccessful",(()=>{const e=oa(10);i(r.attackIsSuccess(e,21,10)).equal(!1)}))}))})),e("digestAttackResult(data, roll)",(()=>{const a={roll:{thac0:15,target:{actor:{system:{ac:{value:0},aac:{value:9}}}}}};e("Ascending AC",(()=>{n((async()=>{await game.settings.set(game.system.id,"ascendingAC",!0)})),t("Natural 1 terms is unsuccessful",(async()=>{i(game.settings.get(game.system.id,"ascendingAC")).equal(!0);const e=oa(1,[1]);i(r.digestAttackResult(a,e).isSuccess).equal(!1),i(r.digestAttackResult(a,e).isFailure).equal(!0);const t=oa(20,[1]);i(r.digestAttackResult(a,t).isSuccess).equal(!1),i(r.digestAttackResult(a,t).isFailure).equal(!0)})),t("Attack rolls with a modified result of 1 are allowed to succeed if hits target AC. Issue#340",(()=>{const e={roll:{thac0:19,target:{actor:{system:{ac:{value:0},aac:{value:1}}}}}},t=oa(1,[2,-1]);i(r.digestAttackResult(e,t).isSuccess).equal(!0),i(r.digestAttackResult(e,t).isFailure).equal(!1)})),t("Lower than target AC is unsuccessful",(()=>{const e=oa(a.roll.target.actor.system.aac.value-1);i(r.digestAttackResult(a,e).isSuccess).equal(!1),i(r.digestAttackResult(a,e).isFailure).equal(!0)})),t("Equal than target AC is successful",(()=>{const e=oa(a.roll.target.actor.system.aac.value);i(r.digestAttackResult(a,e).isSuccess).equal(!0),i(r.digestAttackResult(a,e).isFailure).equal(!1)})),t("Higher than target AC is successful",(()=>{const e=oa(a.roll.target.actor.system.aac.value+1);i(r.digestAttackResult(a,e).isSuccess).equal(!0),i(r.digestAttackResult(a,e).isFailure).equal(!1)})),t("Attack rolls with a modified result of 20 are allowed to fail if doesn't hit target AC. Issue#340",(()=>{const e={roll:{thac0:19,target:{actor:{system:{ac:{value:0},aac:{value:21}}}}}},t=oa(20,[19,1]);i(r.digestAttackResult(e,t).isSuccess).equal(!1),i(r.digestAttackResult(e,t).isFailure).equal(!0)})),t("Natural 20 is successful",(()=>{const e=oa(1,[20]);i(r.digestAttackResult(a,e).isSuccess).equal(!0),i(r.digestAttackResult(a,e).isFailure).equal(!1);const t=oa(20,[20]);i(r.digestAttackResult(a,t).isSuccess).equal(!0),i(r.digestAttackResult(a,t).isFailure).equal(!1)}))})),e("Descending AC, ac=0",(()=>{n((async()=>{await game.settings.set(game.system.id,"ascendingAC",!1)})),t("Natural 1 terms is unsuccessful",(async()=>{i(game.settings.get(game.system.id,"ascendingAC")).equal(!1);const e=oa(1,[1]);i(r.digestAttackResult(a,e).isSuccess).equal(!1),i(r.digestAttackResult(a,e).isFailure).equal(!0);const t=oa(20,[1]);i(r.digestAttackResult(a,t).isSuccess).equal(!1),i(r.digestAttackResult(a,t).isFailure).equal(!0)})),t("Lower than thac0 is unsuccessful",(()=>{const e=oa(a.roll.thac0-1);i(r.digestAttackResult(a,e).isSuccess).equal(!1),i(r.digestAttackResult(a,e).isFailure).equal(!0)})),t("Equal to thac0 is successful",(()=>{const e=oa(a.roll.thac0);i(r.digestAttackResult(a,e).isSuccess).equal(!0),i(r.digestAttackResult(a,e).isFailure).equal(!1)})),t("Higher than thac0 is successful",(()=>{const e=oa(a.roll.thac0+1);i(r.digestAttackResult(a,e).isSuccess).equal(!0),i(r.digestAttackResult(a,e).isFailure).equal(!1)})),t("Natural 20 is successful",(()=>{const e=oa(1,[20]);i(r.digestAttackResult(a,e).isSuccess).equal(!0),i(r.digestAttackResult(a,e).isFailure).equal(!1);const t=oa(20,[20]);i(r.digestAttackResult(a,t).isSuccess).equal(!0),i(r.digestAttackResult(a,t).isFailure).equal(!1)}))}))})),e("sendAttackRoll(parts, data, flags, title, flavor, speaker, form)",(()=>{n((async()=>{await re(),await game.settings.set(game.system.id,"ascendingAC",!0)})),t("Missing dmg roll shows notification",(async()=>{ui.notifications?.clear();const e={parts:["1d20","0","0","0"],data:{roll:{type:"melee",dmg:["1d6"],thac0:15,target:{actor:{system:{ac:{value:0},aac:{value:9}}}}}}};e.data.roll.dmg=[],await r.sendAttackRoll(e),await le(),i(he().map((e=>e?.textContent?.trim()))).to.be.an("array").that.includes("Attack has no damage dice terms; be sure to set the attack's damage")})),t("Can roll with single part and single dmg die",(async()=>{const e=CONFIG.Dice.randomUniform;CONFIG.Dice.randomUniform=()=>we(10,20);const t={parts:["1d20","0","0","0"],data:{roll:{type:"melee",dmg:["1d6"],thac0:15,target:{actor:{system:{ac:{value:0},aac:{value:9}}}}}}};await r.sendAttackRoll(t),await le(),await le(),await le(),await le();const a=document.querySelector(".dice-formula")?.innerHTML;i(a).equal("1d20 + 0 + 0 + 0");const s=document.querySelector(".damage-roll .dice-formula")?.innerHTML;i(s).equal("1d6"),CONFIG.Dice.randomUniform=e})),s((async()=>{await re()}))})),e("RollSave(parts, data, skipDialog, speaker, flavor, title, chatMessage)",(()=>{e("Skipping dialog",(()=>{t("produces a roll chat message",(async()=>{await r.RollSave({parts:["1d10"],skipDialog:true,data:{roll:{blindroll:!1}}}),await le(),i(game.messages.size).equal(1),i(document.querySelector(".roll-result")).not.undefined}))})),e("Not skipping dialog",(()=>{t("produces a dialog",(async()=>{r.RollSave({parts:["1d10"],data:{roll:{blindroll:!1}}}),await le();const e=document.querySelector(".dialog");i(e?.querySelector("button[data-action='ok']")).not.null,i(e?.querySelector("button[data-action='magic']")).not.null,i(e?.querySelector("button[data-action='cancel']")).not.null,await ge()}))})),s((async()=>{await re(),await ge()}))})),e("Roll(parts, data, skipDialog, speaker, flavor, title, chatMessage, flags)",(()=>{e("Skipping dialog",(()=>{t("produces a roll chat message",(async()=>{await r.Roll({parts:["1d10"],skipDialog:true,data:{roll:{blindroll:!1}}}),await le(),i(game.messages.size).equal(1),i(document.querySelector(".roll-result")).not.undefined}))})),e("Not skipping dialog",(()=>{t("produces a dialog",(async()=>{r.Roll({parts:["1d10"],data:{roll:{blindroll:!1}}}),await le();const e=document.querySelector(".dialog");i(e?.querySelector("button[data-action='ok']")).not.null,i(e?.querySelector("button[data-action='magic']")).is.null,i(e?.querySelector("button[data-action='cancel']")).not.null,await ge()}))})),s((async()=>{await re(),await ge(),await le()}))}))};const la={displayName:"OSE: Helpers: Handlebars"};var ca=({describe:e,it:t,expect:a})=>{e("registerHelpers()",(()=>{e("eq helper",(()=>{t("is registered",(()=>{a(Object.keys(Handlebars.helpers)).contain("eq")})),t("is functional",(()=>{a(Handlebars.helpers.eq(1,1)).equal(!0),a(Handlebars.helpers.eq("test","test")).equal(!0),a(Handlebars.helpers.eq(1,2)).equal(!1),a(Handlebars.helpers.eq("test",1)).equal(!1),a(Handlebars.helpers.eq([],[])).equal(!1)}))})),e("mod helper",(()=>{t("is registered",(()=>{a(Object.keys(Handlebars.helpers)).contain("mod")})),t("is functional",(()=>{a(Handlebars.helpers.mod(0)).equal("0"),a(Handlebars.helpers.mod(1)).equal("+1"),a(Handlebars.helpers.mod(-1)).equal("-1"),a(Handlebars.helpers.mod("1")).equal("+1"),a(Handlebars.helpers.mod("-1")).equal("-1"),a(Handlebars.helpers.mod("a")).equal("0")}))})),e("add helper",(()=>{t("is registered",(()=>{a(Object.keys(Handlebars.helpers)).contain("add")})),t("is functional",(()=>{a(Handlebars.helpers.add(1,2)).equal(3),a(Handlebars.helpers.add(1,-2)).equal(-1),a(Handlebars.helpers.add("1","3")).equal(4),a(Handlebars.helpers.add("1","-3")).equal(-2)}))})),e("subtract helper",(()=>{t("is registered",(()=>{a(Object.keys(Handlebars.helpers)).contain("subtract")})),t("is functional",(()=>{a(Handlebars.helpers.subtract(1,2)).equal(-1),a(Handlebars.helpers.subtract(1,-2)).equal(3),a(Handlebars.helpers.subtract("1","3")).equal(-2),a(Handlebars.helpers.subtract("1","-3")).equal(4)}))})),e("divide helper",(()=>{t("is registered",(()=>{a(Object.keys(Handlebars.helpers)).contain("divide")})),t("is functional",(()=>{a(Handlebars.helpers.divide(1,2)).equal(0),a(Handlebars.helpers.divide(1,-2)).equal(-1),a(Handlebars.helpers.divide(10,3)).equal(3),a(Handlebars.helpers.divide("10","3")).equal(3),a(Handlebars.helpers.divide("10","-3")).equal(-4)}))})),e("mult helper",(()=>{t("is registered",(()=>{a(Object.keys(Handlebars.helpers)).contain("mult")})),t("is functional",(()=>{a(Handlebars.helpers.mult(1,2)).equal(2),a(Handlebars.helpers.mult(1,-2)).equal(-2),a(Handlebars.helpers.mult(10,3)).equal(30),a(Handlebars.helpers.mult("10","3")).equal(30),a(Handlebars.helpers.mult("10","-3")).equal(-30),a(Handlebars.helpers.mult(.1,2)).equal(.2),a(Handlebars.helpers.mult(.01,1)).equal(.01),a(Handlebars.helpers.mult(.001,1)).equal(0)}))})),e("roundWeight helper",(()=>{t("is registered",(()=>{a(Object.keys(Handlebars.helpers)).contain("roundWeight")})),t("is functional",(()=>{a(Handlebars.helpers.roundWeight(10.1)).equal(0),a(Handlebars.helpers.roundWeight(100.1)).equal(.1),a(Handlebars.helpers.roundWeight(1000.1)).equal(1)}))})),e("getTagIcon helper",(()=>{t("is registered",(()=>{a(Object.keys(Handlebars.helpers)).contain("getTagIcon")})),e("is functional",(()=>{Object.keys(CONFIG.OSE.tags).forEach((e=>{t(`for ${e} tag`,(async()=>{a(Handlebars.helpers.getTagIcon(CONFIG.OSE.tags[e])).equal(CONFIG.OSE.tag_images[e])}))}))}))})),e("counter helper",(()=>{t("is registered",(()=>{a(Object.keys(Handlebars.helpers)).contain("counter")})),t("is functional",(()=>{a(Handlebars.helpers.counter(!0,12,10)).equal(100),a(Handlebars.helpers.counter(!0,-10,10)).equal(0),a(Handlebars.helpers.counter(!0,3,10)).equal(30),a(Handlebars.helpers.counter(!0,33,100)).equal(33),a(Handlebars.helpers.counter(!0,100,400)).equal(25),a(Handlebars.helpers.counter(!1,12,10)).equal(0),a(Handlebars.helpers.counter(!1,-10,10)).equal(100),a(Handlebars.helpers.counter(!1,3,10)).equal(70),a(Handlebars.helpers.counter(!1,33,100)).equal(67),a(Handlebars.helpers.counter(!1,100,400)).equal(75)}))})),e("times helper",(()=>{t("is registered",(()=>{a(Object.keys(Handlebars.helpers)).contain("times")})),t("is functional",(()=>{const e={fn:e=>e};a(Handlebars.helpers.times(2,e)).equal("01"),a(Handlebars.helpers.times(5,e)).equal("01234")}))})),e("path helper",(()=>{t("is registered",(()=>{a(Object.keys(Handlebars.helpers)).contain("path")})),t("is functional",(()=>{a(Handlebars.helpers.path("/test")).equal(`${CONFIG.OSE.systemPath()}/test`)}))})),e("asset helper",(()=>{t("is registered",(()=>{a(Object.keys(Handlebars.helpers)).contain("asset")})),t("is functional",(()=>{a(Handlebars.helpers.asset("/test")).equal(`${CONFIG.OSE.assetsPath}/test`)}))}))}))};const ua="ose.helpers.macro",ma={displayName:"OSE: Helpers: Macro"},da=async(e,t={})=>be(e,t,ua),ga=()=>Ie(ua);var pa=({describe:e,it:t,expect:a,before:s,after:n,afterEach:i})=>{s((async()=>{game?.scenes?.active?.update({active:!1}),await(ui.notifications?.clear())})),i((async()=>{await ge(),await Te(),await ga(),await Ce(),await Ae(),await(ui.notifications?.clear())})),n((async()=>{await de(),await ge(),await Te(),await ga(),await Ce(),await Ae(),await(ui.notifications?.clear())})),e("createOseMacro(data, slot)",(()=>{t("Can create macro",(async()=>{const e=await qe();a(game.macros?.contents.find((t=>t.uuid===e?.uuid))).not.undefined})),t("Can drag Macro to hotbar",(async()=>{const e=await qe(),t={type:"Macro",uuid:e?.uuid};await G(t,9);const s=game.user?.getHotbarMacros(1);a(s[8].macro).equal(e)})),t("Dragging Actor to hotbar send notification",(async()=>{const e=await da("character"),t={type:e?.type,uuid:e?.uuid},s=await G(t,9);a(ye(s)).equal(!0),a(s.message).equal(game.i18n.localize("OSE.warn.macrosNotAnItem")),await(e?.delete())})),t("Dragging World Item to hotbar send notification",(async()=>{const e=await da("character"),t=await ve("weapon"),s={type:"Item",uuid:t?.uuid},n=await G(s,9);a(ye(n)).equal(!0),a(n.message).equal(game.i18n.localize("OSE.warn.macrosOnlyForOwnedItems")),await(e?.delete()),await(t?.delete())})),e("Dragging all item types creates macros",(()=>{new Set(["spell","ability","armor","weapon","item","container"]).forEach((e=>{t(`Dragging Actor ${e.capitalize()} to hotbar craetes macro`,(async()=>{const t=await da("character");await fe(t,e);const s=t?.items.contents[0],n={type:"Item",uuid:s?.uuid,item:{name:s?.name,img:""}};await G(n,9);const i=game.user?.getHotbarMacros()[8];a(i?.macro?.command).equal(`game.ose.rollItemMacro("New Actor Test ${e.capitalize()}");`),await(t?.delete())}))}))}))})),e("rollItemMacro(itemName)",(()=>{t("No scene creates warning",(async()=>{const e="weapon",t=await da("character");await fe(t,e),await(game.user?.update({character:t?.id})),a(ChatMessage.getSpeaker().scene).is.null,a(ChatMessage.getSpeaker().actor).is.not.null;const s=await W(`New Actor Test ${e.capitalize()}`);a(ye(s)).equal(!0),a(s.message).equal(game.i18n.localize("OSE.warn.macrosNoTokenOwnedInScene")),await(t?.delete())})),t("No assigned actor creates warning",(async()=>{const e="weapon",t=await da("character"),s=await Se();a(s?.tokenVision).equal(!0),await fe(t,e),await(game.user?.update({character:null})),a(ChatMessage.getSpeaker().scene).is.not.null,a(ChatMessage.getSpeaker().actor).is.null;const n=await W(`New Actor Test ${e.capitalize()}`);a(ye(n)).equal(!0),a(n.message).equal(game.i18n.localize("OSE.warn.macrosNoTokenOwnedInScene")),await(t?.delete()),await(s?.delete())})),t("Scene & assigned actor creates roll",(async()=>{const e="weapon",t=await da("character"),s=await Se();a(s?.tokenVision).equal(!0),await fe(t,e),await(game.user?.update({character:t?.id})),a(ChatMessage.getSpeaker().scene).is.not.null,a(ChatMessage.getSpeaker().actor).is.not.null,await W(`New Actor Test ${e.capitalize()}`),await le(),a(me().length).equal(1),await ge(),await(t?.delete()),await(s?.delete())})),t("Duplicate item creates warning but also creates rolls",(async()=>{const e="weapon",t=await da("character"),s=await Se();a(s?.tokenVision).equal(!0),await fe(t,e),await fe(t,e),await(game.user?.update({character:t?.id})),await W(`New Actor Test ${e.capitalize()}`),await le(),a(he().map((e=>e?.textContent?.trim()))).to.be.an("array").that.includes(game.i18n.format("OSE.warn.moreThanOneItemWithName",{actorName:t?.name,itemName:`New Actor Test ${e.capitalize()}`})),await le(),a(me().length).equal(1),await ge(),await(t?.delete()),await(s?.delete())})),t("Missing item creates warning",(async()=>{const e="weapon",t=await da("character"),s=await Se();a(s?.tokenVision).equal(!0),await fe(t,e),await(game.user?.update({character:t?.id})),await(t?.items.getName(`New Actor Test ${e.capitalize()}`)?.delete());const n=await W(`New Actor Test ${e.capitalize()}`);await le(),a(ye(n)).equal(!0),a(n.type).equal("error"),a(n.message).equal(game.i18n.format("OSE.error.noItemWithName",{actorName:t?.name,itemName:`New Actor Test ${e.capitalize()}`})),await(t?.delete()),await(s?.delete())}))}))};const ha="ose.helpers.party",ya={displayName:"OSE: Helpers: Party"},wa=async(e,t={})=>be(e,t,ha);var ba=({describe:e,it:t,expect:a,after:s})=>{s((()=>{Ie(ha)})),e("addControl(object, html)",(()=>{})),e("update(actor)",(()=>{t("Doesn't render a partysheet when not in party",(async()=>{const e=await wa("character");Q(e),a(ue().length).equal(0),await(e?.delete())})),t("Opens a partysheet when in party",(async()=>{const e=await wa("character");await(e?.setFlag(game.system.id,"party",!0)),Q(e),await le(),await(X?.partySheet?.render(!0)),await le();const t=document.querySelector(".party-members .actor")?.getAttribute("data-actor-id");a(t).equal(e?.id),a(ue().length).equal(1),await de(),e?.delete()}))}))};const{drawTreasure:va,rollTreasure:fa}=H,qa="ose.helpers.treasure",Sa={displayName:"OSE: Helpers: Treasure"},Oa=async()=>RollTable.create({name:`Mock Table ${qa}`}),ka=async()=>{const e=await Oa();return await e.update({name:`Mock Treasure Table ${qa}`}),await e.setFlag(game.system.id,"treasure",!0),e};var Ea=({describe:e,it:t,expect:a,after:s})=>{e("augmentTable(table, html)",(()=>{})),e("drawTreasure(table, data)",(()=>{t("Can create table",(async()=>{const e=await ka();await e.createEmbeddedDocuments("TableResult",[{text:"50% Chance",range:[1,1],weight:50}]),a(e.results.size).equal(1),await e.delete()})),t("Draws successfully from a treasure table",(async()=>{const e=await ka();await e.createEmbeddedDocuments("TableResult",[{text:"100% Chance",range:[1,1],weight:100}]);const t=await va(e,{});await le(),a(t.treasure).is.not.undefined;const s=Object.keys(t.treasure)[0];a(t.treasure[s].text).to.include("100% Chance")})),t("Draws unsuccessfully from a treasure table",(async()=>{const e=CONFIG.Dice.randomUniform;CONFIG.Dice.randomUniform=()=>we(2,100);const t=await ka();await t.createEmbeddedDocuments("TableResult",[{text:"1% Chance",range:[1,1],weight:1}]);const s=await va(t,{});a(Object.keys(s.treasure).length).equal(0),CONFIG.Dice.randomUniform=e})),t("Just draws from a non-treasure table",(async()=>{const e=await Oa();e?.update({formula:"1d100"}),await(e?.createEmbeddedDocuments("TableResult",[{text:"100% Chance",range:[1,100]}]));const t=await va(e,{});await le(),a(t.treasure).is.not.undefined;const s=Object.keys(t.treasure)[0];a(t.treasure[s].text).to.include("100% Chance")}))})),e("rollTreasure(table, options)",(()=>{t("Rolling on treasure table produces a chat message",(async()=>{re();const e=await ka();await e.createEmbeddedDocuments("TableResult",[{text:"100% Chance",range:[1,1],weight:100}]),await fa(e),await le(),a(game.messages?.size).equal(1),a(game.messages?.contents[0].content).contains("100% Chance")}))})),s((()=>{(async()=>{const e=game.tables?.filter((e=>e.name===`Mock Table ${qa}`||e.name===`Mock Treasure Table ${qa}`));e?.forEach((e=>e.delete()))})(),re()}))};Hooks.on("quenchReady",(async e=>{e.registerBatch(Fe,xe,De),e.registerBatch("ose.actor.datamodel.character.ac",Re,_e),e.registerBatch("ose.actor.datamodel.character.encumbrance",Pe,$e),e.registerBatch("ose.actor.datamodel.character.move",He,Be),e.registerBatch("ose.actor.datamodel.character.scores",We,Ge),e.registerBatch("ose.actor.datamodel.character.spells",Ye,Ue),e.registerBatch(Xe,Ze,Qe),e.registerBatch(et,st,tt),e.registerBatch(nt,rt,it),e.registerBatch(lt,mt,ct),e.registerBatch(dt,pt,gt),e.registerBatch(ht,wt,yt),e.registerBatch(bt,ft,vt),e.registerBatch(qt,kt,St),e.registerBatch(Et,Ct,Tt),e.registerBatch("ose.item.datamodel.ability",Nt,At),e.registerBatch("ose.item.datamodel.armor",Dt,Ft),e.registerBatch("ose.item.datamodel.container",xt,Mt),e.registerBatch("ose.item.datamodel.misc",Rt,_t),e.registerBatch("ose.item.datamodel.spell",zt,$t),e.registerBatch("ose.item.datamodel.weapon",Pt,Lt),e.registerBatch("ose.item.entity",Ht,Bt),e.registerBatch("ose.item.sheet",Wt,Gt),e.registerBatch(Ut,Vt,Kt),e.registerBatch(Yt,Jt,Xt),e.registerBatch("ose.party-xp.sheet",ea,Zt),e.registerBatch("ose.helpers.behaviour",aa,ta),e.registerBatch("ose.helpers.chat",na,sa),e.registerBatch("ose.helpers.dice",ra,ia),e.registerBatch("ose.helpers.handlebars",ca,la),e.registerBatch(ua,pa,ma),e.registerBatch(ha,ba,ya),e.registerBatch(qa,Ea,Sa)})),Hooks.once("init",(async()=>{CONFIG.OSE=o,Hooks.call("ose-setup-encumbrance"),"ose"===game.system.id&&(CONFIG.debug={...CONFIG.debug,combat:!0}),game.settings.register(game.system.id,"initiative",{name:game.i18n.localize("OSE.Setting.Initiative"),hint:game.i18n.localize("OSE.Setting.InitiativeHint"),default:"group",scope:"world",type:String,requiresReload:!0,config:!0,choices:{individual:"OSE.Setting.InitiativeIndividual",group:"OSE.Setting.InitiativeGroup"}}),game.settings.register(game.system.id,"rerollInitiative",{name:game.i18n.localize("OSE.Setting.RerollInitiative"),hint:game.i18n.localize("OSE.Setting.RerollInitiativeHint"),default:"reset",scope:"world",type:String,config:!0,choices:{keep:"OSE.Setting.InitiativeKeep",reset:"OSE.Setting.InitiativeReset",reroll:"OSE.Setting.InitiativeReroll"}}),game.settings.register(game.system.id,"ascendingAC",{name:game.i18n.localize("OSE.Setting.AscendingAC"),hint:game.i18n.localize("OSE.Setting.AscendingACHint"),default:!1,scope:"world",type:Boolean,config:!0}),game.settings.register(game.system.id,"morale",{name:game.i18n.localize("OSE.Setting.Morale"),hint:game.i18n.localize("OSE.Setting.MoraleHint"),default:!1,scope:"world",type:Boolean,config:!0}),game.settings.register(game.system.id,"encumbranceOption",{name:game.i18n.localize("OSE.Setting.Encumbrance"),hint:game.i18n.localize("OSE.Setting.EncumbranceHint"),default:"detailed",scope:"world",type:String,config:!0,requiresReload:!0,choices:Object.values(CONFIG.OSE.encumbranceOptions).reduce(((e,t)=>({...e,[t.type]:t.localizedLabel})),{})}),game.settings.register(game.system.id,"encumbranceItemStrengthMod",{name:game.i18n.localize("OSE.Setting.EncumbranceItemStrengthMod"),hint:game.i18n.localize("OSE.Setting.EncumbranceItemStrengthModHint"),default:!1,scope:"world",type:Boolean,config:!0}),game.settings.register(game.system.id,"significantTreasure",{name:game.i18n.localize("OSE.Setting.SignificantTreasure"),hint:game.i18n.localize("OSE.Setting.SignificantTreasureHint"),default:800,scope:"world",type:Number,config:!0}),game.settings.register(game.system.id,"languages",{name:game.i18n.localize("OSE.Setting.Languages"),hint:game.i18n.localize("OSE.Setting.LanguagesHint"),default:"",scope:"world",type:String,config:!0}),game.settings.register(game.system.id,"applyDamageOption",{name:game.i18n.localize("OSE.Setting.applyDamageOption"),hint:game.i18n.localize("OSE.Setting.applyDamageOptionHint"),default:"selected",scope:"world",type:String,config:!0,choices:{selected:game.i18n.localize("OSE.Setting.damageSelected"),targeted:game.i18n.localize("OSE.Setting.damageTarget"),originalTarget:game.i18n.localize("OSE.Setting.damageOriginalTarget")}}),game.settings.register(game.system.id,"invertedCtrlBehavior",{name:game.i18n.localize("OSE.Setting.InvertedCtrlBehavior"),hint:game.i18n.localize("OSE.Setting.InvertedCtrlBehaviorHint"),default:!1,scope:"world",type:Boolean,config:!0}),game.settings.register(game.system.id,"ignoreAttackBonusOnDamageRoll",{name:game.i18n.localize("OSE.Setting.ignoreAttackBonusOnDamageRoll"),hint:game.i18n.localize("OSE.Setting.ignoreAttackBonusOnDamageRollHint"),default:!1,scope:"world",type:Boolean,config:!0,requiresReload:!0}),game.settings.register(game.system.id,"hasPromptedDefaultOSETokenRing",{default:!1,scope:"world",type:Boolean}),CONFIG.Combat.documentClass=ae,CONFIG.Combatant.documentClass=se;const e="group"===game.settings.get(game.system.id,"initiative");CONFIG.Combat.initiative={decimals:2,formula:e?ae.GROUP_FORMULA:ae.FORMULA},CONFIG.Combat.fallbackTurnMarker="icons/svg/circle.svg",CONFIG.ui.combat=ne,CONFIG.Token.rulerClass=ie,game.ose={rollItemMacro:W,rollTableMacro:U},X.init(),(async()=>{Handlebars.registerHelper("eq",((e,t)=>e===t)),Handlebars.registerHelper("mod",(e=>e>0?`+${e}`:e<0?`${e}`:"0")),Handlebars.registerHelper("add",((e,t)=>parseInt(e,10)+parseInt(t,10))),Handlebars.registerHelper("subtract",((e,t)=>parseInt(e,10)-parseInt(t,10))),Handlebars.registerHelper("divide",((e,t)=>Math.floor(parseFloat(e)/parseFloat(t)))),Handlebars.registerHelper("mult",((e,t)=>Math.round(100*parseFloat(e)*parseFloat(t))/100)),Handlebars.registerHelper("roundWeight",(e=>Math.round(parseFloat(e)/100)/10)),Handlebars.registerHelper("getTagIcon",(e=>{const t=Object.keys(CONFIG.OSE.tags).find((t=>CONFIG.OSE.tags[t]===e));return t?CONFIG.OSE.tag_images[t]:null})),Handlebars.registerHelper("counter",((e,t,a)=>e?Math.clamp(100*t/a,0,100):Math.clamp(100-100*t/a,0,100))),Handlebars.registerHelper("times",((e,t)=>{let a="";for(let s=0;s<e;++s)a+=t.fn(s);return a})),Handlebars.registerHelper("path",(e=>`${o.systemPath()}${e}`)),Handlebars.registerHelper("asset",(e=>`${o.assetsPath}${e}`)),Handlebars.registerHelper("ceil",(e=>Math.ceil(e))),Handlebars.registerHelper("partial",(e=>`${o.systemPath()}/templates/${e}`))})(),Hooks.once("item-piles-ready",(async()=>{game.itempiles.API.addSystemIntegration({VERSION:"1.0.1",ACTOR_CLASS_TYPE:"character",ITEM_QUANTITY_ATTRIBUTE:"system.quantity.value",ITEM_PRICE_ATTRIBUTE:"system.cost",ITEM_FILTERS:[{path:"type",filters:"spell,ability"}],UNSTACKABLE_ITEM_TYPES:["weapon","armor","container"],ITEM_SIMILARITIES:["name","type","system.treasure"],CURRENCIES:[{type:"item",name:"OSE.items.gp.long",img:"systems/ose/assets/gold.png",abbreviation:"{#}GP",data:{item:{name:"Gold Coins",type:"item",img:"systems/ose/assets/gold.png",system:{quantity:{value:1,max:null},weight:.1,cost:1,treasure:!0}}},primary:!0,exchangeRate:1}]})})),CONFIG.Actor.documentClass=E,CONFIG.Item.documentClass=O,CONFIG.Actor.dataModels={character:f,monster:S},CONFIG.Item.dataModels={weapon:M,armor:A,item:F,spell:D,ability:C,container:N},foundry.documents.collections.Actors.unregisterSheet("core",foundry.appv1.sheets.ActorSheet),foundry.documents.collections.Actors.registerSheet(game.system.id,p,{types:["character"],makeDefault:!0,label:"OSE.SheetClassCharacter"}),foundry.documents.collections.Actors.registerSheet(game.system.id,T,{types:["monster"],makeDefault:!0,label:"OSE.SheetClassMonster"}),foundry.documents.collections.Items.unregisterSheet("core",foundry.appv1.sheets.ItemSheet),foundry.documents.collections.Items.registerSheet(game.system.id,x,{makeDefault:!0,label:"OSE.SheetClassItem"}),await(async()=>{const e=[`${o.systemPath()}/templates/actors/character-sheet.html`,`${o.systemPath()}/templates/actors/monster-sheet.html`,`${o.systemPath()}/templates/actors/partials/character-header.html`,`${o.systemPath()}/templates/actors/partials/character-attributes-tab.html`,`${o.systemPath()}/templates/actors/partials/character-encumbrance.html`,`${o.systemPath()}/templates/actors/partials/character-abilities-tab.html`,`${o.systemPath()}/templates/actors/partials/character-spells-tab.html`,`${o.systemPath()}/templates/actors/partials/character-inventory-tab.html`,`${o.systemPath()}/templates/actors/partials/actor-item-summary.html`,`${o.systemPath()}/templates/actors/partials/character-notes-tab.html`,`${o.systemPath()}/templates/actors/partials/monster-header.html`,`${o.systemPath()}/templates/actors/partials/monster-attributes-tab.html`,`${o.systemPath()}/templates/actors/partials/item-auto-tags-partial.html`,`${o.systemPath()}/templates/apps/party-sheet.html`,`${o.systemPath()}/templates/sidebar/combat-tracker-combatant.hbs`,`${o.systemPath()}/templates/apps/combat-set-groups.hbs`];return foundry.applications.handlebars.loadTemplates(e)})()})),Hooks.once("setup",(()=>{["saves_short","saves_long","scores","armor","colors","tags"].forEach((e=>{CONFIG.OSE[e]=Object.entries(CONFIG.OSE[e]).reduce(((e,t)=>{const a={...e};return a[t[0]]=game.i18n.localize(t[1]),a}),{})}));const e=game.settings.get(game.system.id,"languages");if(""!==e){const t=e.split(",").map((e=>e.trim()));CONFIG.OSE.languages=t}})),Hooks.once("ready",(async()=>{Hooks.on("hotbarDrop",((e,t,a)=>!["Macro","RollTable","Item"].includes(t.type)||(G(t,a),!1))),await async function(){game.settings.get(game.system.id,"hasPromptedDefaultOSETokenRing")||(await foundry.applications.api.DialogV2.confirm({window:{title:game.i18n.localize("OSE.dialog.TokenRingPrompt.Title")},content:game.i18n.localize("OSE.dialog.TokenRingPrompt.Content")})&&await game.settings.set("core","dynamicTokenRing","ose-default-black-white"),await game.settings.set(game.system.id,"hasPromptedDefaultOSETokenRing",!0))}()})),Hooks.on("activateActorDirectory",(e=>{const t=e.element;if(t?.querySelector("button.ose-party-sheet"))return;const a=document.createElement("button");a.className="ose-party-sheet",a.type="button",a.title=game.i18n.localize("OSE.dialog.partysheet");const s=document.createElement("i");s.className="fas fa-users",a.append(s);const n=t.querySelector(".toggle-search-mode");n&&(a.addEventListener("click",(e=>{e.preventDefault(),Hooks.call("OSE.Party.showSheet")})),n.parentNode.insertBefore(a,n))})),Hooks.on("renderSettings",(async(e,t)=>{const a=t.querySelector("section.info"),s=`${o.systemPath()}/templates/chat/license.html`,n=await foundry.applications.handlebars.renderTemplate(s);a.insertAdjacentHTML("afterend",n)})),Hooks.on("renderChatLog",((e,t)=>O.chatListeners(t))),Hooks.on("getChatLogEntryContext",P),Hooks.on("getChatMessageContextOptions",P),Hooks.on("renderChatMessageHTML",((e,t)=>{const a=t.querySelector(".blindable");e?.blind&&!game.user?.isGM&&a&&"true"===a.dataset.blind&&(a.outerHTML="<div class='dice-roll'><div class='dice-result'><div class='dice-formula'>???</div></div></div>");const s=t.querySelector(".damage-roll");if(s&&z(t)){const e=document.createElement("div");e.className="dice-damage";const a=document.createElement("button");a.type="button",a.dataset.action="apply-damage",a.innerHTML='<i class="fas fa-tint"></i>',e.append(a),s.append(e),a.addEventListener("click",(e=>{e.preventDefault(),R(t,1)}))}})),Hooks.on("renderRollTableSheet",((e,t)=>{const a=Boolean(e.document.getFlag(game.system.id,"treasure")),s=document.createElement("div");s.className="toggle-treasure",s.title="Toggle Treasure Table",a&&s.classList.add("active");if(t.querySelector(".sheet-header").append(s),t.querySelector(".toggle-treasure").addEventListener("click",(()=>{const t=Boolean(e.document.getFlag(game.system.id,"treasure"));e.document.setFlag(game.system.id,"treasure",!t)})),!a)return;t.querySelectorAll(".range").forEach((e=>{e.style.display="none"}));const n=t.querySelector("button[data-action=normalizeResults]");n&&n.remove();const i=t.querySelector("thead .weight");i&&(i.textContent="Chance (%)");t.querySelectorAll(".weight").forEach((e=>{e.style.flex="0 0 75px"}));const o=t.querySelector("input[name=formula]");o&&(o.value="1d100",o.disabled=!0);const r=document.createElement("button");r.className="roll-treasure",r.type="button",r.innerHTML=`<i class="fas fa-gem"></i> ${game.i18n.localize("OSE.table.treasure.roll")}`;t.querySelector(".form-footer [data-action='drawResult']").replaceWith(r),r.addEventListener("click",(t=>{j(e.document,{event:t})}))})),Hooks.on("updateActor",Q),Hooks.on("renderCombatTracker",((e,t)=>e.renderGroups(t instanceof HTMLElement?t:t[0]))),Hooks.on("updateCombatantGroup",(async e=>{await(e.parent?.onUpdateCombatantGroup())})),Hooks.on("createCombatant",(e=>{"group"===game.settings.get(game.system.id,"initiative")&&game.user.isGM&&e.assignGroup()})),Hooks.on("renderActorSheet",((e,t)=>{e?.object?.isOwnerOrObserver&&new foundry.applications.ux.ContextMenu(t,".item",[{name:"OSE.Show",icon:"<i class='fas fa-eye'></i>",callback:t=>{const a=t.dataset?.itemId,s=e.actor?.items?.get(a);s&&s.show()}},{name:"OSE.items.Equip",icon:"<i class='fas fa-hand'></i>",condition:t=>{if("character"!==e.actor?.type||!e.object?.sheet?.isEditable)return!1;const a=t.dataset?.itemId,s=e.actor?.items?.get(a);return["item","armor","weapon","treasure","container"].includes(s?.type)},callback:async t=>{const a=t.dataset?.itemId,s=e.actor?.items?.get(a);s&&await s.update({system:{equipped:!s.system.equipped}})}},{name:"OSE.Edit",icon:"<i class='fas fa-edit'></i>",condition:()=>!!e.object?.sheet?.isEditable,callback:t=>{const a=t.dataset?.itemId,s=e.actor?.items?.get(a);s&&s.sheet.render(!0)}},{name:"OSE.Delete",icon:"<i class='fas fa-trash'></i>",condition:()=>!!e.object?.sheet?.isEditable,callback:t=>{const a=t.dataset?.itemId,s=e.actor?.items?.get(a);s&&e._promptRemoveItemFromActor(s)}}],{jQuery:!1})})),Hooks.on("renderCompendium",(async e=>{if("Item"!==e.documentName)return;const t=e.element.querySelectorAll(".item"),a=await e.collection.getDocuments();for(const e of t){const t=a.find((t=>t.id===e.dataset.entryId)),s=await foundry.applications.handlebars.renderTemplate(`${o.systemPath()}/templates/actors/partials/item-auto-tags-partial.html`,{tags:t.system.autoTags||[]});e.insertAdjacentHTML("beforeend",s)}})),Hooks.on("activateItemDirectory",(async e=>{const t=e.element.querySelectorAll(".item"),a=e.collection;for(const e of t){const t=a.find((t=>t.id===e.dataset.entryId)),s=await foundry.applications.handlebars.renderTemplate(`${o.systemPath()}/templates/actors/partials/item-auto-tags-partial.html`,{tags:t.system.autoTags||[]});e.insertAdjacentHTML("beforeend",s)}})),Hooks.on("OSE.Party.showSheet",X.showPartySheet),Hooks.once("initializeDynamicTokenRingConfig",(function(e){e.addConfig("ose-default-black-white",new foundry.canvas.placeables.tokens.DynamicRingData({label:"OSE.rings.BlackWhite",spritesheet:`${o.assetsPath}/rings/black-white.json`}))}));
//# sourceMappingURL=ose.js.map
